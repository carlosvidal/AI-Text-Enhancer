<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/yegor256/tacit@gh-pages/tacit-css-1.8.1.min.css"
    />
    <style>
      label {
        display: block;
        margin-bottom: 0.5rem;
      }

      div {
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <!-- API Key Form -->
    <div class="api-key-form">
      <label for="api-key">OpenAI API Key:</label>
      <input type="password" id="api-key" placeholder="sk-..." />
      <button type="button" onclick="updateApiKeys()">
        Actualizar API Key
      </button>
    </div>

    <form>
      <h2>Informaci√≥n de tu Producto</h2>

      <div>
        <label for="nombre">Nombre:</label>
        <input
          type="text"
          id="nombre"
          name="nombre"
          value="Jab√≥n Menta Natura"
        />
      </div>

      <div>
        <label for="codigo">N√∫mero o c√≥digo de referencia:</label>
        <input type="text" id="codigo" name="codigo" value="PROD12345" />
      </div>

      <div>
        <label for="descripcion">Descripci√≥n:</label>
        <textarea id="descripcion" name="descripcion">
Un jab√≥n artesanal hecho a mano con ingredientes naturales y deliciosa fragancia a menta fresca. Prensado en frio, 100% puro y natural
</textarea
        >
      </div>
      <ai-text-enhancer
        editor-id="descripcion"
        api-provider="openai"
        api-model="gpt-4-vision-preview"
        language="es"
      >
      </ai-text-enhancer>

      <h3>Im√°genes</h3>
      <img
        src="https://www.kanbotanicals.com/cdn/shop/files/mentatercerafoto_2.jpg?v=1692628978&width=1946"
        alt="Jab√≥n Artesanal"
        style="max-width: 400px; height: auto"
      />

      <p>Por favor sube una imagen de m√°ximo 9 Mb.</p>

      <h3>Categor√≠as</h3>

      <div>
        <label
          ><input type="checkbox" name="categoria" value="ABARROTES" checked />
          ABARROTES</label
        >
        <label
          ><input type="checkbox" name="categoria" value="Aceites y Vinagres" />
          Aceites y Vinagres</label
        >
        <label
          ><input type="checkbox" name="categoria" value="Arroz y Pastas" />
          Arroz y Pastas</label
        >
      </div>

      <h3>Marcas</h3>

      <div>
        <label for="marca">Seleccione una marca:</label>
        <select id="marca" name="marca">
          <option value="" disabled>Seleccione una marca...</option>
          <option value="7 DRAGONES" selected>7 DRAGONES</option>
          <option value="AGUA KANGEN">AGUA KANGEN</option>
          <option value="ALAMEDRA INTEGRAL">ALAMEDRA INTEGRAL</option>
          <!-- Continuar con las dem√°s marcas -->
        </select>
      </div>

      <button type="submit">Enviar</button>
    </form>
    <p id="resultado"></p>

    <!-- Script para updateApiKeys -->
    <script type="module">
      // Esperar a que el DOM est√© listo
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          // Importar el componente primero
          await import("../src/ai-text-enhancer.js");

          // Inicializar el manejador de API Key
          const apiKeyHandler = {
            async updateApiKeys() {
              console.log("üîÑ updateApiKeys called");
              const apiKey = document.getElementById("api-key").value;
              console.log("üîë API Key length:", apiKey.length);

              if (!apiKey) {
                console.error("‚ùå API Key is empty");
                return;
              }

              const enhancers = document.querySelectorAll("ai-text-enhancer");
              console.log(`üìù Found ${enhancers.length} enhancers`);

              try {
                for (let i = 0; i < enhancers.length; i++) {
                  const enhancer = enhancers[i];
                  console.log(`üîÑ Processing enhancer ${i + 1}`);

                  if (!enhancer.isInitialized) {
                    console.log(
                      `‚è≥ Waiting for enhancer ${i + 1} to initialize`
                    );
                    await new Promise((resolve) => {
                      const checkInterval = setInterval(() => {
                        if (enhancer.isInitialized) {
                          clearInterval(checkInterval);
                          console.log(`‚úÖ Enhancer ${i + 1} initialized`);
                          resolve();
                        }
                      }, 100);
                    });
                  }

                  console.log(`üîë Setting API Key for enhancer ${i + 1}`);
                  enhancer.setAttribute("api-key", apiKey);
                  console.log(`‚úÖ API Key set for enhancer ${i + 1}`);
                }

                console.log("‚úÖ All API keys updated successfully");
              } catch (error) {
                console.error("‚ùå Error updating API keys:", error);
              }
            },
          };

          // Asignar al window despu√©s de la importaci√≥n
          window.updateApiKeys = apiKeyHandler.updateApiKeys;

          // Aqu√≠ puedes agregar cualquier otra inicializaci√≥n que necesites
        } catch (error) {
          console.error("Error initializing:", error);
        }
      });
    </script>

    <script>
      // Espera a que el DOM est√© completamente cargado
      document.addEventListener("DOMContentLoaded", function () {
        // Elementos del formulario
        const nombreInput = document.getElementById("nombre");
        const codigoInput = document.getElementById("codigo");
        const categoriaCheckboxes = document.querySelectorAll(
          'input[name="categoria"]'
        );
        const marcaSelect = document.getElementById("marca");

        // Variable para almacenar el promt y el contexto
        let myPrompt = "";
        let contexto = "";

        const enhancer = document.querySelector("ai-text-enhancer");

        setTimeout(() => {
          enhancer.setAttribute(
            "image-url",
            "https://www.kanbotanicals.com/cdn/shop/files/mentatercerafoto_2.jpg?v=1692628978&width=1946"
          );
        }, 1000);

        // Funci√≥n para actualizar el contexto
        function actualizarConcatenacion() {
          const nombre = nombreInput.value || "Sin nombre";
          const codigo = codigoInput.value || "Sin c√≥digo";
          const categoriasSeleccionadas = Array.from(categoriaCheckboxes)
            .filter((checkbox) => checkbox.checked)
            .map((checkbox) => checkbox.value);
          const categoria =
            categoriasSeleccionadas.length > 0
              ? categoriasSeleccionadas.join(", ")
              : "Sin categor√≠a";
          const marca = marcaSelect.value || "Sin marca";

          myPrompt =
            `Instrucciones de generaci√≥n/mejora:\n\n` +
            `1. Act√∫a como un experto en redacci√≥n de descripciones de productos para tiendas en l√≠neaen Per√∫.\n\n` +
            `2. Tu tarea es generar o mejorar la descripci√≥n de un producto con un enfoque atractivo y persuasivo, destacando sus caracter√≠sticas principales, beneficios y posibles usos, optimizando el contenido para el mercado peruano.\n\n` +
            `3. Si el usuario ya ha escrito una descripci√≥n: Mej√≥rala manteniendo su esencia, pero haci√©ndola m√°s clara, persuasiva y optimizada para ventas.\n\n` +
            `4. Si la descripci√≥n est√° vac√≠a: Genera una nueva descripci√≥n atractiva, destacando caracter√≠sticas y beneficios.\n\n` +
            `5. Si el producto pertenece a una marca reconocida y tiene un modelo o part number: Considera especificaciones t√©cnicas adicionales y detalles relevantes que puedan encontrarse en fuentes confiables.\n\n` +
            `6. Adapta la descripci√≥n al mercado peruano: Usa t√©rminos y expresiones locales si es relevante, menciona env√≠os dentro de Per√∫ y considera detalles como m√©todos de pago populares en el pa√≠s.\n\n` +
            `7. Usa un tono profesional y cercano, adaptado a una tienda en l√≠nea.\n\n` +
            `8. Si hay una imagen del producto, aprovecha los detalles visuales para enriquecer la descripci√≥n.\n\n` +
            `9. Si aplica, menciona informaci√≥n relevante del comercio para reforzar la confianza del comprador (env√≠os, garant√≠a, atenci√≥n al cliente, etc.).\n\n` +
            `10. Mant√©n el texto claro, sin repeticiones innecesarias, y optimizado para SEO si es posible.\n\n` +
            `*Importante:* Solo responde con la descripci√≥n generada o mejorada, sin agregar ning√∫n otro comentario, explicaci√≥n o texto adicional.`;

          contexto = `Nombre: ${nombre}, C√≥digo: ${codigo}, Categor√≠a: ${categoria}, Marca: ${marca}.\n\n`;

          document.getElementById("resultado").textContent =
            "Contexto: " + contexto + "\n\n" + "Prompt: " + myPrompt;

          enhancer.setAttribute("prompt", myPrompt);
          enhancer.setAttribute("context", contexto);
        }

        // Escuchar cambios en los campos
        nombreInput.addEventListener("input", actualizarConcatenacion);
        codigoInput.addEventListener("input", actualizarConcatenacion);
        categoriaCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", actualizarConcatenacion);
        });
        marcaSelect.addEventListener("change", actualizarConcatenacion);

        // Llamar a la funci√≥n inicialmente para mostrar valores por defecto
        actualizarConcatenacion();
      });
    </script>
  </body>
</html>
