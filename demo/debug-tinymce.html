<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Text Enhancer - Demo TinyMCE</title>
    <link rel="stylesheet" href="css/common-styles.css" />

    <!-- TinyMCE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.7.0/tinymce.min.js"></script>

    <style>
      /* Estilos adicionales para el bot√≥n de AI */
      .mce-i-aienhancer {
        color: #3b82f6 !important;
      }

      /* Ajustes para el loader */
      .ai-loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Mensaje de √©xito */
      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>AI Text Enhancer - Demo TinyMCE</h1>

    <div class="api-key-form">
      <label for="api-key">OpenAI API Key:</label>
      <input type="password" id="api-key" placeholder="sk-..." />
      <button id="update-api-key">Actualizar API Key</button>
    </div>

    <div class="demo-navigation">
      <a href="index.html">Inicio</a>
      <a href="demo-simple.html">Textarea Simple</a>
      <a href="demo-tinymce.html" class="active">TinyMCE</a>
      <a href="demo-ckeditor.html">CKEditor 5</a>
      <a href="demo-quill.html">Quill</a>
      <a href="demo-froala.html">Froala</a>
    </div>

    <!-- TinyMCE Editor -->
    <div class="editor-container">
      <h2>
        <img src="https://www.tiny.cloud/favicon.ico" alt="TinyMCE Logo" />
        Editor TinyMCE
      </h2>
      <div id="tinymce-editor"></div>
      <div class="success-message" id="success-message">
        ‚úÖ Contenido aplicado correctamente al editor
      </div>
    </div>

    <!-- Script para parchar el componente antes de cargarlo -->
    <script>
      // Funci√≥n para parchar el componente AITextEnhancer
      function patchAITextEnhancer() {
        console.log("üõ†Ô∏è Configurando parche para AITextEnhancer...");

        // Esperar a que window.customElements est√© disponible
        if (!window.customElements) {
          setTimeout(patchAITextEnhancer, 100);
          return;
        }

        // Obtener la definici√≥n original del componente
        const originalDefine = window.customElements.define;

        // Sobrescribir el m√©todo define para poder interceptar la definici√≥n de AITextEnhancer
        window.customElements.define = function (name, constructor, options) {
          if (name === "ai-text-enhancer") {
            console.log("üîç Interceptando definici√≥n de AI Text Enhancer");

            // Crear una subclase para parchearlo
            const PatchedAITextEnhancer = class extends constructor {
              constructor() {
                super();
                console.log(
                  "üîß Creando instancia parcheada de AI Text Enhancer"
                );
              }

              // Sobrescribir el m√©todo problem√°tico
              updateVisibleTools() {
                try {
                  console.log(
                    "üîß M√©todo updateVisibleTools parcheado ejecut√°ndose"
                  );

                  // Implementaci√≥n segura que evita el error e.trim
                  let content = "";

                  // Intentar obtener el contenido de forma segura
                  if (
                    this.editorAdapter &&
                    typeof this.editorAdapter.getContent === "function"
                  ) {
                    try {
                      const rawContent = this.editorAdapter.getContent();
                      content =
                        typeof rawContent === "string" ? rawContent : "";
                    } catch (error) {
                      console.warn(
                        "‚ö†Ô∏è Error obteniendo contenido del editor:",
                        error
                      );
                    }
                  } else if (window.tinymce && tinymce.get("tinymce-editor")) {
                    // Intentar obtener directamente de TinyMCE
                    try {
                      content =
                        tinymce.get("tinymce-editor").getContent() || "";
                    } catch (error) {
                      console.warn(
                        "‚ö†Ô∏è Error obteniendo contenido de TinyMCE:",
                        error
                      );
                    }
                  }

                  // Asegurarnos de que content es una cadena
                  if (typeof content !== "string") {
                    content = "";
                  }

                  // Verificar si hay contenido de forma segura
                  const hasContent = content.trim().length > 0;

                  // Actualizar la barra de herramientas
                  const toolbar = this.shadowRoot?.querySelector("ai-toolbar");
                  if (toolbar) {
                    toolbar.setAttribute("has-content", hasContent.toString());
                    console.log(
                      "‚úÖ Toolbar has-content actualizado:",
                      hasContent
                    );
                  }
                } catch (error) {
                  console.warn(
                    "‚ö†Ô∏è Error en updateVisibleTools (versi√≥n segura):",
                    error
                  );
                  // No propagar el error para no romper la inicializaci√≥n
                }
              }

              // Sobrescribir el getter de currentContent
              get currentContent() {
                try {
                  if (window.tinymce && tinymce.get("tinymce-editor")) {
                    return tinymce.get("tinymce-editor").getContent() || "";
                  } else if (
                    this.editorAdapter &&
                    typeof this.editorAdapter.getContent === "function"
                  ) {
                    const content = this.editorAdapter.getContent();
                    return typeof content === "string" ? content : "";
                  }
                  return "";
                } catch (error) {
                  console.warn("‚ö†Ô∏è Error en getter currentContent:", error);
                  return "";
                }
              }

              // Mejorar handleResponseUse
              handleResponseUse(event) {
                console.log("üîÑ handleResponseUse parcheado:", event.detail);

                try {
                  // Verificar que el evento tenga la informaci√≥n necesaria
                  if (!event.detail || !event.detail.responseId) {
                    console.warn("‚ö†Ô∏è Datos de evento inv√°lidos:", event.detail);
                    return false;
                  }

                  const { responseId } = event.detail;

                  // Obtener el historial de respuestas
                  if (!this.responseHistory) {
                    console.error(
                      "‚ö†Ô∏è No hay historial de respuestas disponible"
                    );
                    return false;
                  }

                  // Obtener la respuesta
                  const response = this.responseHistory.getResponse(responseId);
                  if (!response) {
                    console.warn(
                      "‚ö†Ô∏è No se encontr√≥ respuesta con ID:",
                      responseId
                    );
                    return false;
                  }

                  console.log("‚úÖ Respuesta encontrada:", {
                    id: responseId,
                    action: response.action,
                    contentLength: response.content
                      ? response.content.length
                      : 0,
                  });

                  // Verificar que haya contenido
                  if (
                    !response.content ||
                    response.content.trim().length === 0
                  ) {
                    console.warn("‚ö†Ô∏è La respuesta no tiene contenido");
                    return false;
                  }

                  // Aplicar al editor - primero intentar TinyMCE directamente
                  if (window.tinymce && tinymce.get("tinymce-editor")) {
                    const editor = tinymce.get("tinymce-editor");
                    if (editor && editor.initialized) {
                      editor.setContent(response.content);
                      editor.undoManager.add();

                      console.log(
                        "‚úÖ Contenido aplicado directamente a TinyMCE"
                      );

                      // Mostrar mensaje de √©xito
                      const successMessage =
                        document.getElementById("success-message");
                      if (successMessage) {
                        successMessage.style.display = "block";

                        // Ocultar despu√©s de 5 segundos
                        setTimeout(() => {
                          successMessage.style.display = "none";
                        }, 5000);
                      }

                      // Cerrar el modal
                      setTimeout(() => {
                        const modal = this.shadowRoot.querySelector(".modal");
                        if (modal) {
                          modal.classList.remove("open");
                        }
                      }, 100);

                      return true;
                    }
                  }

                  // Fallback al editorAdapter
                  if (this.editorAdapter) {
                    const success = this.editorAdapter.setContent(
                      response.content
                    );

                    if (success) {
                      console.log(
                        "‚úÖ Contenido aplicado a trav√©s del adaptador"
                      );

                      // Mostrar mensaje de √©xito
                      const successMessage =
                        document.getElementById("success-message");
                      if (successMessage) {
                        successMessage.style.display = "block";

                        // Ocultar despu√©s de 5 segundos
                        setTimeout(() => {
                          successMessage.style.display = "none";
                        }, 5000);
                      }

                      // Cerrar el modal
                      setTimeout(() => {
                        const modal = this.shadowRoot.querySelector(".modal");
                        if (modal) {
                          modal.classList.remove("open");
                        }
                      }, 100);

                      return true;
                    }
                  }

                  console.error("‚ùå No se pudo aplicar el contenido al editor");
                  return false;
                } catch (error) {
                  console.error("‚ùå Error en handleResponseUse:", error);
                  return false;
                }
              }
            };

            // Llamar al m√©todo original con la clase parcheada
            return originalDefine.call(
              this,
              name,
              PatchedAITextEnhancer,
              options
            );
          }

          // Para otros componentes, comportamiento normal
          return originalDefine.call(this, name, constructor, options);
        };

        console.log("‚úÖ Parche configurado correctamente");
      }

      // Ejecutar el parche inmediatamente
      patchAITextEnhancer();
    </script>

    <!-- Script para importar el componente y configurar TinyMCE -->
    <script type="module">
      // Esperar a que el DOM est√© listo
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          console.log("üöÄ Inicializando demo de TinyMCE...");

          // Importar componente base
          await import("../dist/ai-text-enhancer.umd.js");
          console.log("‚úÖ Componente AI Text Enhancer importado");

          // Importar plugins
          const pluginsModule = await import(
            "../dist/ai-text-enhancer-plugins.es.js"
          );
          console.log("‚úÖ Plugins importados:", Object.keys(pluginsModule));

          // Variable para almacenar la instancia del editor
          let tinyMCEInstance = null;

          // Inicializar TinyMCE con el plugin de IA
          tinymce.init({
            selector: "#tinymce-editor",
            height: 300,
            menubar: false,
            plugins: [
              "advlist",
              "autolink",
              "lists",
              "link",
              "image",
              "charmap",
              "preview",
              "anchor",
              "searchreplace",
              "visualblocks",
              "code",
              "fullscreen",
              "insertdatetime",
              "media",
              "table",
              "help",
              "wordcount",
            ],
            toolbar:
              "undo redo | blocks | bold italic forecolor | alignleft aligncenter " +
              "alignright alignjustify | bullist numlist outdent indent | " +
              "removeformat | aienhancer | help",
            content_style:
              "body { font-family:Helvetica,Arial,sans-serif; font-size:14px }",
            setup: function (editor) {
              // Guardar la instancia para uso posterior
              tinyMCEInstance = editor;
              console.log("‚úÖ Editor TinyMCE configurado");

              // Verificar que TinyMCEPlugin est√° disponible
              if (typeof pluginsModule.TinyMCEPlugin === "function") {
                // Inicializar plugin de IA con opciones de depuraci√≥n
                const aiPlugin = pluginsModule.TinyMCEPlugin({
                  enhancerId: "tinymce-enhancer",
                  buttonTooltip: "Mejorar con IA",
                  debug: true,
                });

                // Registrar plugin
                aiPlugin(editor);
                console.log("‚úÖ Plugin de AI registrado en TinyMCE");
              } else {
                console.error(
                  "‚ùå TinyMCEPlugin no est√° disponible o no es una funci√≥n"
                );
              }

              // Cuando el editor est√© listo, configuramos el contenido inicial
              editor.on("init", function () {
                console.log("‚úÖ TinyMCE inicializado completamente");

                editor.setContent(
                  "<p>Este es un ejemplo de descripci√≥n en TinyMCE que se puede optimizar para SEO usando IA.</p>" +
                    "<p>Incluye algunas palabras clave pero necesita mejorar su estructura y relevancia.</p>" +
                    "<p>El contenido debe ser m√°s atractivo para los motores de b√∫squeda.</p>"
                );

                // A√±adir componente AI-Text-Enhancer din√°micamente
                setTimeout(() => {
                  createEnhancerComponent();
                }, 500);
              });
            },
          });

          // Funci√≥n para crear el componente AI-Text-Enhancer din√°micamente
          function createEnhancerComponent() {
            // Verificar si ya existe
            if (document.getElementById("tinymce-enhancer")) {
              console.log("‚úÖ El componente AI Text Enhancer ya existe");
              configureEnhancer();
              return;
            }

            // Crear el componente
            const enhancer = document.createElement("ai-text-enhancer");
            enhancer.setAttribute("id", "tinymce-enhancer");
            enhancer.setAttribute("editor-id", "tinymce-editor");
            enhancer.setAttribute("editor-type", "tinymce");
            enhancer.setAttribute("api-provider", "openai");
            enhancer.setAttribute("api-model", "gpt-4");
            enhancer.setAttribute("tenant-id", "1");
            enhancer.setAttribute("user-id", "12965");
            enhancer.setAttribute(
              "prompt",
              "Eres un asistente experto en SEO, especializado en optimizar contenido para motores de b√∫squeda."
            );
            enhancer.setAttribute("hide-trigger", "");

            // A√±adirlo al DOM
            document.querySelector(".editor-container").appendChild(enhancer);
            console.log("‚úÖ Componente AI Text Enhancer creado din√°micamente");

            // Configurarlo
            configureEnhancer();
          }

          // Funci√≥n para configurar el componente
          function configureEnhancer() {
            const enhancer = document.getElementById("tinymce-enhancer");
            if (!enhancer) {
              console.error("‚ùå No se encontr√≥ el componente AI Text Enhancer");
              return;
            }

            // Asegurarnos de que el adaptador del editor est√° configurado correctamente
            enhancer.editorAdapter = {
              editorId: "tinymce-editor",
              editorType: "tinymce",

              getContent: function () {
                try {
                  if (tinyMCEInstance && tinyMCEInstance.initialized) {
                    const content = tinyMCEInstance.getContent() || "";
                    console.log(`‚úÖ getContent: ${content.length} caracteres`);
                    return content;
                  }
                  return "";
                } catch (error) {
                  console.error("‚ùå Error en getContent:", error);
                  return "";
                }
              },

              setContent: function (content) {
                try {
                  if (
                    tinyMCEInstance &&
                    tinyMCEInstance.initialized &&
                    content
                  ) {
                    console.log(`‚úÖ setContent: ${content.length} caracteres`);
                    tinyMCEInstance.setContent(content);
                    tinyMCEInstance.undoManager.add();

                    // Mostrar mensaje de √©xito
                    const successMessage =
                      document.getElementById("success-message");
                    if (successMessage) {
                      successMessage.style.display = "block";

                      // Ocultar despu√©s de 5 segundos
                      setTimeout(() => {
                        successMessage.style.display = "none";
                      }, 5000);
                    }

                    return true;
                  }
                  return false;
                } catch (error) {
                  console.error("‚ùå Error en setContent:", error);
                  return false;
                }
              },

              setEditorType: function (type) {
                this.editorType = type;
              },
            };

            console.log("‚úÖ EditorAdapter configurado correctamente");

            // Configurar listener espec√≠fico para el evento responseUse
            if (enhancer.shadowRoot) {
              // Buscar el response-history dentro del shadow DOM
              const responseHistory =
                enhancer.shadowRoot.querySelector("response-history");
              if (responseHistory) {
                // Agregar listener directo a response-history
                responseHistory.addEventListener(
                  "responseUse",
                  function (event) {
                    console.log(
                      "üîÑ Evento responseUse capturado directamente en response-history:",
                      event.detail
                    );

                    try {
                      const { responseId } = event.detail;
                      const response = responseHistory.getResponse(responseId);

                      if (response && response.content) {
                        // Aplicar directamente a TinyMCE
                        tinyMCEInstance.setContent(response.content);
                        tinyMCEInstance.undoManager.add();

                        console.log(
                          "‚úÖ Contenido aplicado desde evento directo responseUse"
                        );

                        // Mostrar mensaje de √©xito
                        const successMessage =
                          document.getElementById("success-message");
                        if (successMessage) {
                          successMessage.style.display = "block";

                          // Ocultar despu√©s de 5 segundos
                          setTimeout(() => {
                            successMessage.style.display = "none";
                          }, 5000);
                        }

                        // Cerrar modal
                        setTimeout(() => {
                          const modal =
                            enhancer.shadowRoot.querySelector(".modal");
                          if (modal) {
                            modal.classList.remove("open");
                          }
                        }, 100);
                      }
                    } catch (error) {
                      console.error(
                        "‚ùå Error procesando responseUse directo:",
                        error
                      );
                    }
                  }
                );

                console.log("‚úÖ Listener directo para responseUse configurado");
              } else {
                console.warn(
                  "‚ö†Ô∏è No se encontr√≥ el componente response-history en el shadow DOM"
                );
              }
            }
          }
        } catch (error) {
          console.error("‚ùå Error inicializando el demo de TinyMCE:", error);
        }
      });
    </script>

    <script src="js/common.js"></script>
  </body>
</html>
