<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fix TinyMCE - AI Text Enhancer</title>
    <link rel="stylesheet" href="css/common-styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.7.0/tinymce.min.js"></script>
    <style>
      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Fix TinyMCE - AI Text Enhancer</h1>

    <div class="editor-container">
      <h2>Editor TinyMCE (Versi√≥n arreglada)</h2>
      <div id="tinymce-editor"></div>
      <div class="success-message" id="success-message">
        ‚úÖ Integraci√≥n funciona correctamente. El bot√≥n de IA est√° en la barra
        de herramientas.
      </div>
    </div>

    <!-- Este script se carga antes del componente para parchearlo -->
    <script>
      // Funci√≥n para parchar el componente AITextEnhancer
      function patchAITextEnhancer() {
        console.log("üõ†Ô∏è Configurando parche para AITextEnhancer...");

        // Esperar a que window.customElements est√© disponible
        if (!window.customElements) {
          setTimeout(patchAITextEnhancer, 100);
          return;
        }

        // Obtener la definici√≥n original del componente
        const originalDefine = window.customElements.define;

        // Sobrescribir el m√©todo define para poder interceptar la definici√≥n de AITextEnhancer
        window.customElements.define = function (name, constructor, options) {
          if (name === "ai-text-enhancer") {
            console.log("üîç Interceptando definici√≥n de AI Text Enhancer");

            // Crear una subclase para parchearlo
            const PatchedAITextEnhancer = class extends constructor {
              constructor() {
                super();
                console.log(
                  "üîß Creando instancia parcheada de AI Text Enhancer"
                );
              }

              // Sobrescribir el m√©todo problem√°tico
              updateVisibleTools() {
                try {
                  console.log(
                    "üîß M√©todo updateVisibleTools parcheado ejecut√°ndose"
                  );

                  // Implementaci√≥n segura que evita el error e.trim
                  let content = "";

                  // Intentar obtener el contenido de forma segura
                  if (
                    this.editorAdapter &&
                    typeof this.editorAdapter.getContent === "function"
                  ) {
                    try {
                      const rawContent = this.editorAdapter.getContent();
                      content =
                        typeof rawContent === "string" ? rawContent : "";
                    } catch (error) {
                      console.warn(
                        "‚ö†Ô∏è Error obteniendo contenido del editor:",
                        error
                      );
                    }
                  } else if (window.tinymce && tinymce.get("tinymce-editor")) {
                    // Intentar obtener directamente de TinyMCE
                    try {
                      content =
                        tinymce.get("tinymce-editor").getContent() || "";
                    } catch (error) {
                      console.warn(
                        "‚ö†Ô∏è Error obteniendo contenido de TinyMCE:",
                        error
                      );
                    }
                  }

                  // Asegurarnos de que content es una cadena
                  if (typeof content !== "string") {
                    content = "";
                  }

                  // Verificar si hay contenido de forma segura
                  const hasContent = content.trim().length > 0;

                  // Actualizar la barra de herramientas
                  const toolbar = this.shadowRoot?.querySelector("ai-toolbar");
                  if (toolbar) {
                    toolbar.setAttribute("has-content", hasContent.toString());
                    console.log(
                      "‚úÖ Toolbar has-content actualizado:",
                      hasContent
                    );
                  }
                } catch (error) {
                  console.warn(
                    "‚ö†Ô∏è Error en updateVisibleTools (versi√≥n segura):",
                    error
                  );
                  // No propagar el error para no romper la inicializaci√≥n
                }
              }

              // Sobrescribir el getter de currentContent
              get currentContent() {
                try {
                  if (window.tinymce && tinymce.get("tinymce-editor")) {
                    return tinymce.get("tinymce-editor").getContent() || "";
                  } else if (
                    this.editorAdapter &&
                    typeof this.editorAdapter.getContent === "function"
                  ) {
                    const content = this.editorAdapter.getContent();
                    return typeof content === "string" ? content : "";
                  }
                  return "";
                } catch (error) {
                  console.warn("‚ö†Ô∏è Error en getter currentContent:", error);
                  return "";
                }
              }

              // Mejorar manejo de eventos de respuesta
              connectedCallback() {
                // Llamar al m√©todo original
                super.connectedCallback();

                // Configurar manejador mejorado de responseUse
                setTimeout(() => {
                  // Asegurarse de que responseHistory existe
                  if (
                    this.shadowRoot &&
                    this.shadowRoot.querySelector("response-history")
                  ) {
                    const responseHistory =
                      this.shadowRoot.querySelector("response-history");

                    // Agregar listener mejorado
                    responseHistory.addEventListener(
                      "responseUse",
                      function (event) {
                        console.log(
                          "üîç Evento responseUse recibido en el parche:",
                          event.detail
                        );

                        try {
                          const { responseId } = event.detail || {};
                          if (!responseId) return;

                          const response =
                            responseHistory.getResponse(responseId);
                          if (response && response.content) {
                            // Aplicar directamente al editor
                            if (
                              window.tinymce &&
                              tinymce.get("tinymce-editor")
                            ) {
                              tinymce
                                .get("tinymce-editor")
                                .setContent(response.content);
                              tinymce.get("tinymce-editor").undoManager.add();

                              console.log("‚úÖ Contenido aplicado a TinyMCE");

                              // Mostrar mensaje de √©xito
                              document.getElementById(
                                "success-message"
                              ).style.display = "block";

                              // Cerrar el modal
                              setTimeout(() => {
                                const modal = document
                                  .querySelector("ai-text-enhancer")
                                  .shadowRoot.querySelector(".modal");
                                if (modal) {
                                  modal.classList.remove("open");
                                }
                              }, 100);
                            }
                          }
                        } catch (error) {
                          console.error(
                            "‚ùå Error procesando responseUse:",
                            error
                          );
                        }
                      }
                    );

                    console.log("‚úÖ Listener de responseUse configurado");
                  }
                }, 1000);
              }
            };

            // Llamar al m√©todo original con la clase parcheada
            return originalDefine.call(
              this,
              name,
              PatchedAITextEnhancer,
              options
            );
          }

          // Para otros componentes, comportamiento normal
          return originalDefine.call(this, name, constructor, options);
        };

        console.log("‚úÖ Parche configurado correctamente");
      }

      // Ejecutar el parche inmediatamente
      patchAITextEnhancer();
    </script>

    <!-- Inicializaci√≥n de TinyMCE -->
    <script>
      // Inicializar TinyMCE
      tinymce.init({
        selector: "#tinymce-editor",
        height: 300,
        menubar: false,
        plugins: [
          "advlist",
          "autolink",
          "lists",
          "link",
          "image",
          "charmap",
          "preview",
          "anchor",
          "searchreplace",
          "visualblocks",
          "code",
        ],
        toolbar:
          "undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | aienhancer",
        setup: function (editor) {
          // Agregar bot√≥n personalizado para AI
          editor.ui.registry.addButton("aienhancer", {
            icon: "new-document",
            tooltip: "Mejorar con IA",
            onAction: function () {
              console.log("üñ±Ô∏è Bot√≥n AI presionado");

              // Buscar el componente AI Text Enhancer
              setTimeout(() => {
                const enhancer = document.querySelector("ai-text-enhancer");
                if (enhancer && typeof enhancer.openModal === "function") {
                  enhancer.openModal();
                  console.log("‚úÖ Modal abierto");
                } else {
                  console.error(
                    "‚ùå No se pudo encontrar el componente o el m√©todo openModal"
                  );
                }
              }, 500);
            },
          });

          // Cuando el editor est√© listo
          editor.on("init", function () {
            console.log("‚úÖ TinyMCE inicializado");

            // Establecer contenido inicial
            editor.setContent(
              "<p>Este es un texto de ejemplo para probar la integraci√≥n con IA.</p><p>El texto puede ser mejorado usando t√©cnicas avanzadas de escritura.</p>"
            );

            // A√±adir el componente AI Text Enhancer despu√©s de que TinyMCE est√© listo
            setTimeout(() => {
              // Crear el componente din√°micamente
              const enhancer = document.createElement("ai-text-enhancer");
              enhancer.setAttribute("id", "tinymce-enhancer");
              enhancer.setAttribute("editor-id", "tinymce-editor");
              enhancer.setAttribute("editor-type", "tinymce");
              enhancer.setAttribute("api-provider", "openai");
              enhancer.setAttribute("api-model", "gpt-4");
              enhancer.setAttribute("hide-trigger", "");
              enhancer.setAttribute("tenant-id", "1");
              enhancer.setAttribute("user-id", "12965");

              // A√±adirlo al DOM
              document.querySelector(".editor-container").appendChild(enhancer);
              console.log(
                "‚úÖ Componente AI Text Enhancer a√±adido din√°micamente"
              );
            }, 1000);
          });
        },
      });
    </script>

    <!-- Cargar el componente AI Text Enhancer despu√©s de que todo est√© configurado -->
    <script type="module">
      // Esperamos un momento para que los parches se apliquen
      setTimeout(async () => {
        try {
          console.log("üîÑ Importando AI Text Enhancer...");
          await import("../dist/ai-text-enhancer.umd.js");
          console.log("‚úÖ AI Text Enhancer importado correctamente");
        } catch (error) {
          console.error("‚ùå Error al importar AI Text Enhancer:", error);
        }
      }, 500);
    </script>
  </body>
</html>
