{"version":3,"file":"ai-text-enhancer.umd.js","sources":["../src/constants/translations.js","../src/services/icon-service.js","../src/styles/base/variables.js","../src/styles/base/animations.js","../src/styles/layout/preview.js","../src/components/ResponseHistory.js","../src/components/ChatWithImage.js","../src/components/ToolBar.js","../src/constants/model-config.js","../src/services/model-manager.js","../src/services/token-manager.js","../src/services/markdown-handler.js","../src/services/api-client.js","../src/services/cache-manager.js","../src/utils/tinymce-adapter.js","../src/utils/ckeditor-adapter.js","../src/utils/quill-adapter.js","../src/utils/froala-adapter.js","../src/services/editor-adapter.js","../src/services/notification-manager.js","../src/features/keyboard-navigation.js","../src/features/response-handlers.js","../src/features/image-handlers.js","../src/features/state-integration.js","../src/utils/state-utils.js","../src/template.js","../src/index.js","../src/utils/event-utils.js","../src/utils/dom-utils.js"],"sourcesContent":["// translations.js with added prompt templates\n\nexport const TRANSLATIONS = {\n  en: {\n    modalTrigger: \"Enhance with AI (Beta)\",\n    modalTitle: \"Enhance your text with AI\",\n    tools: {\n      improve: \"Improve\",\n      summarize: \"Summarize\",\n      expand: \"Expand\",\n      paraphrase: \"Paraphrase\",\n      \"more-formal\": \"More Formal\",\n      \"more-casual\": \"More Casual\",\n      \"chat-question\": \"Question\",\n      \"chat-response\": \"Response\",\n      \"chat-error\": \"Error\",\n    },\n    actions: {\n      copy: \"Copy\",\n      use: \"Use\",\n      edit: \"Edit\",\n      retry: \"Retry\",\n      insert: \"Insert\",\n      replace: \"Replace\",\n      generate: \"Generate\",\n    },\n    preview: {\n      placeholder: \"Enhanced text will appear here\",\n    },\n    chat: {\n      placeholder: \"Ask a question about the product description...\",\n      question: \"Question\",\n      contentPrompt: \"Could you improve the text I have in the editor?\",\n      contextPrompt:\n        \"Please create a professional description based on the following context.\",\n      emptyPrompt: \"What type of content would you like me to help you create?\",\n    },\n    errors: {\n      apiKey: \"Error: API key not configured. Please provide a valid API key.\",\n      initialization: \"Error initializing component:\",\n      request: \"Error processing request:\",\n    },\n  },\n  es: {\n    modalTrigger: \"Mejorar con IA (Beta)\",\n    modalTitle: \"Mejora tu texto con IA\",\n    tools: {\n      improve: \"Mejorar\",\n      summarize: \"Resumir\",\n      expand: \"Ampliar\",\n      paraphrase: \"Parafrasear\",\n      \"more-formal\": \"Más formal\",\n      \"more-casual\": \"Más casual\",\n      \"chat-question\": \"Pregunta\",\n      \"chat-response\": \"Respuesta\",\n      \"chat-error\": \"Error\",\n    },\n    actions: {\n      copy: \"Copiar\",\n      use: \"Usar\",\n      edit: \"Editar\",\n      retry: \"Reintentar\",\n      insert: \"Insertar\",\n      replace: \"Reemplazar\",\n      generate: \"Generar\",\n    },\n    preview: {\n      placeholder: \"El texto mejorado aparecerá aquí\",\n    },\n    chat: {\n      placeholder: \"Haz una pregunta sobre la descripción del producto...\",\n      question: \"Pregunta\",\n      contentPrompt: \"¿Podrías mejorar el texto que tengo en el editor?\",\n      contextPrompt:\n        \"Por favor, crea una descripción profesional basada en el siguiente contexto.\",\n      emptyPrompt: \"¿Qué tipo de contenido te gustaría que te ayude a crear?\",\n    },\n    errors: {\n      apiKey:\n        \"Error: API key no configurada. Por favor proporciona una API key válida.\",\n      initialization: \"Error inicializando componente:\",\n      request: \"Error procesando solicitud:\",\n    },\n  },\n  fr: {\n    modalTrigger: \"Améliorer avec IA (Beta)\",\n    modalTitle: \"Améliorez votre texte avec IA\",\n    tools: {\n      improve: \"Améliorer\",\n      summarize: \"Résumer\",\n      expand: \"Développer\",\n      paraphrase: \"Paraphraser\",\n      \"more-formal\": \"Plus Formel\",\n      \"more-casual\": \"Plus Décontracté\",\n      \"chat-question\": \"Question\",\n      \"chat-response\": \"Réponse\",\n      \"chat-error\": \"Erreur\",\n    },\n    actions: {\n      retry: \"Réessayer\",\n      insert: \"Insérer\",\n      replace: \"Remplacer\",\n      generate: \"Générer\",\n      copy: \"Copier\",\n      use: \"Utiliser\",\n      edit: \"Éditer\",\n    },\n    preview: {\n      placeholder: \"Le texte amélioré apparaîtra ici\",\n    },\n    chat: {\n      placeholder: \"Posez une question sur la description du produit...\",\n      question: \"Question\",\n      contentPrompt:\n        \"Pourriez-vous améliorer le texte que j'ai dans l'éditeur ?\",\n      contextPrompt:\n        \"Veuillez créer une description professionnelle basée sur le contexte suivant.\",\n      emptyPrompt:\n        \"Quel type de contenu souhaitez-vous que je vous aide à créer ?\",\n    },\n    errors: {\n      apiKey:\n        \"Erreur : Clé API non configurée. Veuillez fournir une clé API valide.\",\n      initialization: \"Erreur d'initialisation du composant :\",\n      request: \"Erreur lors du traitement de la demande :\",\n    },\n  },\n  de: {\n    modalTrigger: \"Beschreibung Verbessern mit KI (Beta)\",\n    modalTitle: \"Verbessern Sie Ihre Beschreibun mit KI\",\n    tools: {\n      improve: \"Verbessern\",\n      summarize: \"Zusammenfassen\",\n      expand: \"Erweitern\",\n      paraphrase: \"Umformulieren\",\n      \"more-formal\": \"Formaler\",\n      \"more-casual\": \"Lockerer\",\n      \"chat-question\": \"Frage\",\n      \"chat-response\": \"Antwort\",\n      \"chat-error\": \"Fehler\",\n    },\n    actions: {\n      retry: \"Wiederholen\",\n      insert: \"Einfügen\",\n      replace: \"Ersetzen\",\n      generate: \"Generieren\",\n      copy: \"Kopieren\",\n      use: \"Verwenden\",\n      edit: \"Bearbeiten\",\n    },\n    preview: {\n      placeholder: \"Verbesserter Text erscheint hier\",\n    },\n    chat: {\n      placeholder: \"Stellen Sie eine Frage zur Produktbeschreibung...\",\n      question: \"Frage\",\n      contentPrompt: \"Könnten Sie den Text in meinem Editor verbessern?\",\n      contextPrompt:\n        \"Bitte erstellen Sie eine professionelle Beschreibung basierend auf dem folgenden Kontext.\",\n      emptyPrompt:\n        \"Welche Art von Inhalt möchten Sie, dass ich Ihnen erstellen helfe?\",\n    },\n    errors: {\n      apiKey:\n        \"Fehler: API-Schlüssel nicht konfiguriert. Bitte geben Sie einen gültigen API-Schlüssel an.\",\n      initialization: \"Fehler bei der Initialisierung der Komponente:\",\n      request: \"Fehler bei der Verarbeitung der Anfrage:\",\n    },\n  },\n  pt: {\n    modalTrigger: \"Melhorar com IA (Beta)\",\n    modalTitle: \"Melhore sua texto com IA\",\n    tools: {\n      improve: \"Melhorar\",\n      summarize: \"Resumir\",\n      expand: \"Expandir\",\n      paraphrase: \"Parafrasear\",\n      \"more-formal\": \"Mais Formal\",\n      \"more-casual\": \"Mais Casual\",\n      \"chat-question\": \"Pergunta\",\n      \"chat-response\": \"Resposta\",\n      \"chat-error\": \"Erro\",\n    },\n    actions: {\n      retry: \"Tentar Novamente\",\n      insert: \"Inserir\",\n      replace: \"Substituir\",\n      generate: \"Gerar\",\n      copy: \"Copiar\",\n      use: \"Usar\",\n      edit: \"Editar\",\n    },\n    preview: {\n      placeholder: \"O texto melhorado aparecerá aqui\",\n    },\n    chat: {\n      placeholder: \"Faça uma pergunta sobre a descrição do produto...\",\n      question: \"Pergunta\",\n      contentPrompt: \"Você poderia melhorar o texto que tenho no editor?\",\n      contextPrompt:\n        \"Por favor, crie uma descrição profissional com base no seguinte contexto.\",\n      emptyPrompt:\n        \"Que tipo de conteúdo você gostaria que eu ajudasse a criar?\",\n    },\n    errors: {\n      apiKey:\n        \"Erro: Chave API não configurada. Por favor, forneça uma chave API válida.\",\n      initialization: \"Erro ao inicializar componente:\",\n      request: \"Erro ao processar solicitação:\",\n    },\n  },\n  it: {\n    modalTrigger: \"Migliorare con IA (Beta)\",\n    modalTitle: \"Migliorare il tuo testo con IA\",\n    tools: {\n      improve: \"Migliorare\",\n      summarize: \"Sommario\",\n      expand: \"Espandere\",\n      paraphrase: \"Parafrasare\",\n      \"more-formal\": \"Più Formale\",\n      \"more-casual\": \"Più Casual\",\n      \"chat-question\": \"Domanda\",\n      \"chat-response\": \"Risposta\",\n      \"chat-error\": \"Errore\",\n    },\n    actions: {\n      retry: \"Riprova\",\n      insert: \"Inserire\",\n      replace: \"Sostituire\",\n      generate: \"Generare\",\n      copy: \"Copiare\",\n      use: \"Usare\",\n      edit: \"Modificare\",\n    },\n    preview: {\n      placeholder: \"Il testo migliorato apparirà qui\",\n    },\n    chat: {\n      placeholder: \"Fai una domanda sulla descrizione del prodotto...\",\n      question: \"Domanda\",\n      contentPrompt: \"Potresti migliorare il testo che ho nell'editor?\",\n      contextPrompt:\n        \"Per favore, crea una descrizione professionale basata sul seguente contesto.\",\n      emptyPrompt: \"Che tipo di contenuto vorresti che ti aiutassi a creare?\",\n    },\n    errors: {\n      apiKey:\n        \"Errore: Chiave API non configurata. Fornisci una chiave API valida.\",\n      initialization: \"Errore inizializzazione componente:\",\n      request: \"Errore elaborazione richiesta:\",\n    },\n  },\n};\n","export const getToolIcon = (action) => {\n  const icons = {\n    improve: `\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n          <path d=\"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z\"/>\n          <path d=\"m14 7 3 3\"/>\n        </svg>\n      `,\n    summarize: `\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n          <path d=\"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20\"/>\n          <path d=\"M9 10h6\"/>\n        </svg>\n      `,\n    expand: `\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n          <path d=\"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20\"/>\n          <path d=\"M9 10h6\"/><path d=\"M12 7v6\"/>\n        </svg>\n      `,\n    paraphrase: `\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n          <path d=\"M21 6H3\"/><path d=\"M7 12H3\"/><path d=\"M7 18H3\"/>\n          <path d=\"M12 18a5 5 0 0 0 9-3 4.5 4.5 0 0 0-4.5-4.5c-1.33 0-2.54.54-3.41 1.41L11 14\"/>\n          <path d=\"M11 10v4h4\"/>\n        </svg>\n      `,\n    \"more-formal\": `\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n          <rect width=\"20\" height=\"14\" x=\"2\" y=\"7\" rx=\"2\" ry=\"2\"/>\n          <path d=\"M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16\"/>\n        </svg>\n      `,\n    \"more-casual\": `\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n          <circle cx=\"12\" cy=\"12\" r=\"10\"/>\n          <path d=\"M8 14s1.5 2 4 2 4-2 4-2\"/>\n          <line x1=\"9\" x2=\"9.01\" y1=\"9\" y2=\"9\"/>\n          <line x1=\"15\" x2=\"15.01\" y1=\"9\" y2=\"9\"/>\n        </svg>\n      `,\n    \"chat-question\": `\n      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n        <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"/>\n      </svg>\n    `,\n    \"chat-response\": `\n      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n        <path d=\"M3 15a2 2 0 0 0 2 2h14l4 4V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z\"/>\n      </svg>\n    `,\n    \"chat-error\": `\n      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n        <circle cx=\"12\" cy=\"12\" r=\"10\"/>\n        <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"12\"/>\n        <line x1=\"12\" y1=\"16\" x2=\"12.01\" y2=\"16\"/>\n      </svg>\n    `\n  };\n\n  return icons[action] || icons.improve;\n};","// styles/base/variables.js\nexport const variables = `\n  :host {\n    --ai-primary: #3b82f6;\n    --ai-primary-hover: #2563eb;\n    --ai-secondary: #e5e7eb;\n    --ai-secondary-hover: #d1d5db;\n    --ai-text: #1f2937;\n    --ai-text-light: #6b7280;\n    --ai-border: #e5e7eb;\n    --ai-success: #10b981;\n    --ai-warning: #f59e0b;\n    --ai-error: #dc2626;\n    --ai-background: #ffffff;\n    --ai-background-light: #f9fafb;\n    \n    --ai-shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);\n    --ai-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);\n    --ai-shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);\n    \n    --ai-radius-sm: 0.375rem;\n    --ai-radius: 0.5rem;\n    --ai-radius-md: 0.75rem;\n    --ai-radius-lg: 1rem;\n    \n    --ai-font-sans: system-ui, -apple-system, sans-serif;\n    --ai-z-modal: 99999;\n    --ai-z-content: 100000;\n\n    /* Gradient colors */\n    --ai-gradient-start: #da22ff;\n    --ai-gradient-middle: #9733ee;\n    --ai-gradient-end: #da22ff;\n  }\n`;\n","// styles/base/animations.js\nexport const animations = `\n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n      transform: translateY(10px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n\n  @keyframes blink {\n    0%, 100% { opacity: 1; }\n    50% { opacity: 0; }\n  }\n\n  @keyframes glow {\n    0% { background-position: 0 0; }\n    50% { background-position: 200% 0; }\n    100% { background-position: 0 0; }\n  }\n\n  @keyframes shake {\n    0%, 100% { transform: rotate(0deg); }\n    25% { transform: rotate(5deg); }\n    50% { transform: rotate(-5deg); }\n    75% { transform: rotate(5deg); }\n  }\n\n  @keyframes pulse {\n    0% { transform: scale(1); }\n    50% { transform: scale(1.05); }\n    100% { transform: scale(1); }\n  }\n`;\n","// styles/layout/preview.js\nexport const previewStyles = `\n  .preview {\n    flex: 1;\n    overflow-y: auto;\n    background: var(--ai-background);\n    border-radius: var(--ai-radius);\n  }\n\n  .response-tool {\n    font-weight: 500;\n    color: var(--ai-text);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n  }\n\n  .response-timestamp {\n    color: var(--ai-text-light);\n    font-size: 0.875rem;\n  }\n\n  .response-action.primary {\n    background: var(--ai-primary);\n    color: white;\n  }\n\n  .response-action.primary:hover {\n    background: var(--ai-primary-hover);\n  }\n`;\n","// src/components/ResponseHistory.js\nimport { TRANSLATIONS } from \"../constants/translations.js\";\nimport { getToolIcon } from \"../services/icon-service.js\";\nimport { variables } from \"../styles/base/variables.js\";\nimport { animations } from \"../styles/base/animations.js\";\nimport { previewStyles } from \"../styles/layout/preview.js\";\nimport { responseHistoryStyles } from \"../styles/components/response-history.js\";\n\nexport class ResponseHistory extends HTMLElement {\n  constructor() {\n    super();\n    this.attachShadow({ mode: \"open\" });\n    this.responses = [];\n    this.markdownHandler = null;\n  }\n\n  static get observedAttributes() {\n    return [\"language\"];\n  }\n\n  get language() {\n    const lang = this.getAttribute(\"language\");\n    console.log(\"[ResponseHistory] Getting language:\", lang);\n    return lang || \"en\";\n  }\n\n  connectedCallback() {\n    console.log(\"[ResponseHistory] Connected, language:\", this.language);\n    console.log(\n      \"[ResponseHistory] Has language attribute:\",\n      this.hasAttribute(\"language\")\n    );\n    console.log(\"[ResponseHistory] All attributes:\", this.getAttributeNames());\n\n    this.translations = TRANSLATIONS[this.language] || TRANSLATIONS.en;\n    console.log(\"[ResponseHistory] Initial translations:\", this.translations);\n\n    this.render();\n    this.setupEventListeners();\n  }\n\n  attributeChangedCallback(name, oldValue, newValue) {\n    console.log(\n      \"[ResponseHistory] Attribute changed:\",\n      name,\n      \"from\",\n      oldValue,\n      \"to\",\n      newValue\n    );\n    if (name === \"language\" && oldValue !== newValue) {\n      console.log(\n        \"[ResponseHistory] Updating translations for new language:\",\n        newValue\n      );\n      this.translations = TRANSLATIONS[newValue] || TRANSLATIONS.en;\n      console.log(\"[ResponseHistory] New translations:\", this.translations);\n      this.render();\n    }\n  }\n\n  // Versión optimizada de createResponseEntry para reducir espacios en blanco innecesarios\n  // Sobrescribir el método createResponseEntry para manejar específicamente mensajes info y preguntas\n  createResponseEntry(response) {\n    const entry = document.createElement(\"div\");\n    entry.className = \"response-entry\";\n    entry.dataset.id = response.id;\n    entry.dataset.action = response.action;\n\n    // Determinar el tipo de respuesta\n    const isInfo = [\"info\", \"error\", \"chat-error\"].includes(response.action);\n    const isQuestion = response.action === \"chat-question\";\n\n    // ===== CASO 1: MENSAJES DE INFORMACIÓN/ERROR - FORMATO SUPER COMPACTO =====\n    if (isInfo) {\n      entry.innerHTML = `\n      <div class=\"response-content-wrapper\">\n        <div class=\"response-content\">\n          ${\n            this.markdownHandler\n              ? this.markdownHandler.convert(response.content)\n              : response.content\n          }\n        </div>\n      </div>\n    `;\n      return entry;\n    }\n\n    // ===== CASO 2: PREGUNTAS - FORMATO COMPACTO =====\n    if (isQuestion) {\n      const hasImage = response.image !== undefined && response.image !== null;\n\n      // Si tiene imagen, usar un layout especial\n      if (hasImage) {\n        entry.innerHTML = `\n        <div class=\"response-content-wrapper\">\n          <div class=\"response-header mini\">\n            <div class=\"response-tool\">\n              ${getToolIcon(response.action)}\n              <span>Pregunta:</span>\n            </div>\n            <div class=\"response-timestamp\">${this.formatTimestamp(\n              response.timestamp\n            )}</div>\n          </div>\n          <div class=\"question-container\">\n            <div class=\"question-content\">\n              ${response.content.replace(/^\\*\\*Pregunta:\\*\\*\\s*/i, \"\")}\n            </div>\n            <div class=\"question-image mini\">\n              <img src=\"${URL.createObjectURL(\n                response.image\n              )}\" alt=\"Imagen adjunta\">\n            </div>\n          </div>\n        </div>\n      `;\n      } else {\n        // Sin imagen, aún más compacto\n        entry.innerHTML = `\n        <div class=\"response-content-wrapper\">\n          <div class=\"response-header mini\">\n            <div class=\"response-tool\">\n              ${getToolIcon(response.action)}\n              <span>Pregunta:</span>\n            </div>\n            <div class=\"response-timestamp\">${this.formatTimestamp(\n              response.timestamp\n            )}</div>\n          </div>\n          <div class=\"response-content\">\n            ${response.content.replace(/^\\*\\*Pregunta:\\*\\*\\s*/i, \"\")}\n          </div>\n        </div>\n        `;\n      }\n\n      return entry;\n    }\n\n    // Para todos los demás tipos de respuestas, mantener el comportamiento normal\n    const contentWrapper = document.createElement(\"div\");\n    contentWrapper.className = \"response-content-wrapper\";\n\n    // Verificar si está en proceso de escritura\n    const isLoading = response.content === \"\" || response.content.length < 5;\n    const contentClass = isLoading\n      ? \"response-content typing-animation\"\n      : \"response-content\";\n\n    // Crear el contenido principal como lo hacías antes\n    let mainContent;\n    if (response.action === \"image-upload\") {\n      mainContent = response.content;\n    } else if (isLoading) {\n      if (response.action === \"chat-response\") {\n        mainContent = `<div class=\"typing-indicator\">Escribiendo respuesta...</div>`;\n      } else if (\n        [\n          \"improve\",\n          \"summarize\",\n          \"expand\",\n          \"paraphrase\",\n          \"more-formal\",\n          \"more-casual\",\n        ].includes(response.action)\n      ) {\n        mainContent = `<div class=\"typing-indicator\">Pensando...</div>`;\n      } else {\n        mainContent = \"\";\n      }\n    } else {\n      mainContent = this.markdownHandler\n        ? this.markdownHandler.convert(response.content)\n        : response.content;\n    }\n\n    // Crear herramientas si no es pregunta ni mensaje del sistema\n    const isSystemMessage = [\"error\", \"info\", \"chat-error\"].includes(\n      response.action\n    );\n\n    // Generar los botones de herramientas\n    let toolsHtml = \"\";\n    if (!isQuestion && !isSystemMessage) {\n      toolsHtml = `\n        <button class=\"tool-button\" data-action=\"improve\" data-response-id=\"${\n          response.id\n        }\">\n          ${getToolIcon(\"improve\")}\n          ${this.translations?.tools?.improve || \"Improve\"}\n        </button>\n        <button class=\"tool-button\" data-action=\"summarize\" data-response-id=\"${\n          response.id\n        }\">\n          ${getToolIcon(\"summarize\")}\n          ${this.translations?.tools?.summarize || \"Summarize\"}\n        </button>\n        <button class=\"tool-button\" data-action=\"expand\" data-response-id=\"${\n          response.id\n        }\">\n          ${getToolIcon(\"expand\")}\n          ${this.translations?.tools?.expand || \"Expand\"}\n        </button>\n        <button class=\"tool-button\" data-action=\"paraphrase\" data-response-id=\"${\n          response.id\n        }\">\n          ${getToolIcon(\"paraphrase\")}\n          ${this.translations?.tools?.paraphrase || \"Paraphrase\"}\n        </button>\n        <button class=\"tool-button\" data-action=\"more-formal\" data-response-id=\"${\n          response.id\n        }\">\n          ${getToolIcon(\"more-formal\")}\n          ${this.translations?.tools?.[\"more-formal\"] || \"More Formal\"}\n        </button>\n        <button class=\"tool-button\" data-action=\"more-casual\" data-response-id=\"${\n          response.id\n        }\">\n          ${getToolIcon(\"more-casual\")}\n          ${this.translations?.tools?.[\"more-casual\"] || \"More Casual\"}\n        </button>\n      `;\n    }\n\n    // Botones de acción\n    const actionsHtml =\n      !isSystemMessage && !isQuestion\n        ? `\n<div class=\"response-footer\">\n  <div class=\"response-tools\">\n    ${toolsHtml}\n  </div>\n  <div class=\"response-actions\">\n    <button class=\"response-action copy-button\" data-response-id=\"${\n      response.id\n    }\" title=\"${this.translations?.actions?.copy || \"Copy\"}\">\n      <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" stroke=\"currentColor\" stroke-width=\"2\" fill=\"none\">\n        <rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" ry=\"2\"/>\n        <path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\"/>\n      </svg>\n      <span class=\"action-text\">${\n        this.translations?.actions?.copy || \"Copy\"\n      }</span>\n    </button>\n    <button class=\"response-action use-button\" data-response-id=\"${\n      response.id\n    }\" title=\"${this.translations?.actions?.use || \"Use\"}\">\n      <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" stroke=\"currentColor\" stroke-width=\"2\" fill=\"none\">\n        <polyline points=\"20 6 9 17 4 12\"/>\n      </svg>\n      <span class=\"action-text\">${\n        this.translations?.actions?.use || \"Use\"\n      }</span>\n    </button>\n    <button class=\"response-action retry-button\" data-response-id=\"${\n      response.id\n    }\" data-action=\"${response.action}\" title=\"${\n            this.translations?.actions?.retry || \"Retry\"\n          }\">\n      <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" stroke=\"currentColor\" stroke-width=\"2\" fill=\"none\">\n        <path d=\"M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3\"/>\n      </svg>\n      <span class=\"action-text\">${\n        this.translations?.actions?.retry || \"Retry\"\n      }</span>\n    </button>\n  </div>\n</div>\n`\n        : \"\";\n\n    // Construir el HTML para respuestas normales\n    contentWrapper.innerHTML = `\n    <div class=\"response-header\">\n      <div class=\"response-tool\">\n        ${getToolIcon(response.action)}\n        <span>${\n          this.translations?.tools[response.action] || response.action\n        }</span>\n      </div>\n      <div class=\"response-timestamp\">${this.formatTimestamp(\n        response.timestamp\n      )}</div>\n    </div>\n    <div class=\"${contentClass}\">\n      ${mainContent}\n    </div>\n    ${actionsHtml}\n  `;\n\n    // Añadir estilos específicos para elementos miniatura si no existen\n    if (!this.shadowRoot.querySelector(\"#mini-elements-style\")) {\n      const styleEl = document.createElement(\"style\");\n      styleEl.id = \"mini-elements-style\";\n      styleEl.textContent = `\n      /* Estilos para elementos miniatura */\n      .mini {\n        margin: 0 !important;\n        padding: 0 !important;\n      }\n      \n      .response-header.mini {\n        margin-bottom: 0.25rem !important;\n      }\n      \n      .response-footer.mini {\n        padding-top: 0.25rem !important;\n        display: flex;\n        justify-content: flex-end;\n      }\n      \n      .question-image.mini {\n        width: 60px !important;\n        height: 60px !important;\n      }\n      \n      .question-image.mini img {\n        width: 60px !important;\n        height: 60px !important;\n      }\n      \n      .response-action.mini {\n        padding: 0.25rem !important;\n      }\n      \n      /* Estilos específicos para mensajes de información */\n      .response-entry[data-action=\"info\"],\n      .response-entry[data-action=\"error\"],\n      .response-entry[data-action=\"chat-error\"] {\n        padding: 0.5rem 0.75rem !important;\n      }\n      \n      /* Estilos específicos para preguntas */\n      .response-entry[data-action=\"chat-question\"] {\n        padding: 0.5rem 0.75rem !important;\n      }\n      \n      .question-container {\n        display: flex;\n        gap: 0.5rem;\n        align-items: flex-start;\n        margin: 0;\n        padding: 0;\n      }\n    `;\n      this.shadowRoot.appendChild(styleEl);\n    }\n\n    entry.appendChild(contentWrapper);\n    return entry;\n  }\n\n  setupEventListeners() {\n    this.shadowRoot.addEventListener(\"click\", (e) => {\n      const button = e.target.closest(\"button\");\n      if (!button) return;\n\n      const responseId = button.dataset.responseId;\n      if (!responseId) return;\n\n      const response = this.getResponse(responseId);\n      if (!response) return;\n\n      // Manejar los eventos de las herramientas\n      if (button.classList.contains(\"tool-button\")) {\n        const action = button.dataset.action;\n        console.log(\"[ResponseHistory] Tool button clicked:\", {\n          action,\n          responseId,\n        });\n        this.dispatchEvent(\n          new CustomEvent(\"toolaction\", {\n            detail: {\n              action,\n              responseId,\n              content: response.content,\n            },\n            bubbles: true,\n            composed: true,\n          })\n        );\n      } else if (button.classList.contains(\"retry-button\")) {\n        const action = button.dataset.action;\n        this.dispatchEvent(\n          new CustomEvent(\"responseRetry\", {\n            detail: { responseId, action },\n            bubbles: true,\n            composed: true,\n          })\n        );\n      } else if (button.classList.contains(\"edit-button\")) {\n        this.dispatchEvent(\n          new CustomEvent(\"responseEdit\", {\n            detail: { responseId },\n            bubbles: true,\n            composed: true,\n          })\n        );\n      } else if (button.classList.contains(\"copy-button\")) {\n        this.dispatchEvent(\n          new CustomEvent(\"responseCopy\", {\n            detail: { responseId },\n            bubbles: true,\n            composed: true,\n          })\n        );\n      } else if (button.classList.contains(\"use-button\")) {\n        console.log(\"[ResponseHistory] Use button clicked\");\n\n        // Primero disparamos el evento de uso\n        this.dispatchEvent(\n          new CustomEvent(\"responseUse\", {\n            detail: { responseId },\n            bubbles: true,\n            composed: true,\n          })\n        );\n\n        // Esperar un momento antes de cerrar el modal\n        setTimeout(() => {\n          console.log(\"[ResponseHistory] Attempting to close modal\");\n\n          try {\n            // Buscar el modal más cercano usando la clase correcta\n            let element = this;\n            while (element) {\n              console.log(\n                \"[ResponseHistory] Checking element for modal class:\",\n                element\n              );\n              if (element.classList?.contains(\"modal\")) {\n                console.log(\"[ResponseHistory] Found modal element:\", element);\n                element.classList.remove(\"open\");\n                break;\n              }\n              // Navegar hacia arriba en el árbol del DOM\n              element = element.parentNode || element.getRootNode().host;\n            }\n          } catch (error) {\n            console.error(\"[ResponseHistory] Error closing modal:\", error);\n          }\n        }, 100); // Esperar 100ms\n      } else if (button.classList.contains(\"retry-button\")) {\n        const action = button.dataset.action;\n        this.dispatchEvent(\n          new CustomEvent(\"responseRetry\", {\n            detail: { responseId, action },\n            bubbles: true,\n            composed: true,\n          })\n        );\n      }\n    });\n  }\n\n  getResponse(id) {\n    console.log(\"[ResponseHistory] Getting response for ID:\", id);\n    console.log(\"[ResponseHistory] Available responses:\", this.responses);\n    const response = this.responses.find(\n      (response) => response.id === parseInt(id)\n    );\n    console.log(\"[ResponseHistory] Found response:\", response);\n    return response;\n  }\n\n  addResponse(response) {\n    console.log(\"[ResponseHistory] Adding response:\", response);\n    this.responses.push(response);\n    this.render();\n  }\n\n  // Método mejorado para updateResponse en ResponseHistory.js\n  updateResponse(id, contentOrCallback) {\n    const index = this.responses.findIndex((r) => r.id === id);\n    if (index === -1) return;\n\n    const response = this.responses[index];\n    const oldContent = response.content;\n\n    // Actualizar el contenido en el objeto de datos\n    if (typeof contentOrCallback === \"function\") {\n      response.content = contentOrCallback(response.content);\n    } else {\n      response.content = contentOrCallback;\n    }\n\n    // Determinar el tipo de actualización\n    const isFirstUpdate = oldContent === \"\";\n    const isIncrementalUpdate =\n      typeof contentOrCallback === \"function\" &&\n      response.content.length > oldContent.length &&\n      response.content.startsWith(oldContent);\n\n    // Obtener el elemento DOM\n    const responseEntry = this.shadowRoot.querySelector(`[data-id=\"${id}\"]`);\n    if (!responseEntry) {\n      // Si no hay elemento DOM, renderizar todo\n      this.render();\n      return;\n    }\n\n    // Obtener el elemento de contenido\n    const contentElement = responseEntry.querySelector(\".response-content\");\n    if (!contentElement) return;\n\n    // =========== ESTRATEGIA DE STREAMING SIN PARPADEO ===========\n\n    // CASO 1: Primera actualización - Configuración inicial\n    if (isFirstUpdate) {\n      console.log(\n        \"[ResponseHistory] Primera actualización, configurando streaming\"\n      );\n\n      // Verificar si hay texto de contenido\n      let firstChunk = response.content || \"\";\n\n      // Verificar si necesitamos reparar un inicio truncado\n      if (firstChunk.startsWith(\"aro,\") || firstChunk.startsWith(\"laro,\")) {\n        console.warn(\n          \"[ResponseHistory] Detectado inicio truncado, reparando...\"\n        );\n        firstChunk = \"C\" + firstChunk;\n        // Actualizar también el objeto de respuesta\n        response.content = firstChunk;\n      }\n\n      // Crear un nodo de texto para actualizaciones incrementales\n      const textNode = document.createTextNode(firstChunk);\n\n      // Asegurarnos de que el contenedor esté limpio\n      contentElement.innerHTML = \"\";\n      contentElement.appendChild(textNode);\n\n      // Marcar como streaming activo y añadir clase para cursor\n      contentElement.dataset.streamingActive = \"true\";\n      contentElement.classList.add(\"typing-animation\");\n    }\n\n    // CASO 2: Actualización incremental durante streaming\n    else if (\n      isIncrementalUpdate &&\n      contentElement.dataset.streamingActive === \"true\"\n    ) {\n      // Calcular solo el nuevo texto añadido\n      const newTextPart = response.content.substring(oldContent.length);\n\n      // Si tiene un nodo de texto como último hijo, actualizarlo directamente\n      if (\n        contentElement.lastChild &&\n        contentElement.lastChild.nodeType === Node.TEXT_NODE\n      ) {\n        // Actualizar el nodeValue para evitar parpadeo\n        contentElement.lastChild.nodeValue = response.content;\n      } else {\n        const textNode = document.createTextNode(response.content);\n        contentElement.innerHTML = \"\";\n        contentElement.appendChild(textNode);\n      }\n\n      // Mantener el scroll al final si está cerca del final\n      const container = responseEntry.parentNode;\n      if (container) {\n        const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;\n        if (isNearBottom) {\n          container.scrollTop = container.scrollHeight;\n        }\n      }\n    }\n\n    // CASO 3: Streaming ha terminado o es una actualización completa\n    else {\n      console.log(\n        \"[ResponseHistory] Streaming completo o actualización no incremental\"\n      );\n\n      // Comprobar si se debe finalizar el streaming\n      const isStreamingComplete = response.content.length > 50;\n\n      // Si el streaming ha terminado, quitar clase de animación\n      if (\n        isStreamingComplete &&\n        contentElement.dataset.streamingActive === \"true\"\n      ) {\n        contentElement.classList.remove(\"typing-animation\");\n        contentElement.dataset.streamingActive = \"false\";\n\n        // Preservar el contenido texto antes de aplicar markdown\n        const textContent = response.content;\n\n        // Hacer una copia del contenido para restaurar punto de scroll\n        const scrollTop = responseEntry.parentNode?.scrollTop || 0;\n\n        // Aplicar formato markdown si está disponible\n        if (this.markdownHandler) {\n          try {\n            contentElement.innerHTML =\n              this.markdownHandler.convert(textContent);\n          } catch (error) {\n            console.error(\"[ResponseHistory] Error applying markdown:\", error);\n            contentElement.textContent = textContent;\n          }\n        } else {\n          contentElement.textContent = textContent;\n        }\n\n        // Restaurar desplazamiento para evitar saltos\n        if (responseEntry.parentNode) {\n          responseEntry.parentNode.scrollTop = scrollTop;\n        }\n      }\n      // Si no es incremental pero no es final de streaming, actualizar normalmente\n      else if (!isIncrementalUpdate) {\n        if (this.markdownHandler) {\n          contentElement.innerHTML = this.markdownHandler.convert(\n            response.content\n          );\n        } else {\n          contentElement.textContent = response.content;\n        }\n      }\n    }\n  }\n\n  getTypingPlaceholder() {\n    return '<span class=\"typing\">|</span>';\n  }\n\n  getResponse(id) {\n    return this.responses.find((response) => response.id === parseInt(id));\n  }\n\n  removeResponse(id) {\n    this.responses = this.responses.filter((r) => r.id !== id);\n    this.render();\n  }\n\n  clear() {\n    this.responses = [];\n    this.render();\n  }\n\n  render() {\n    const style = document.createElement(\"style\");\n\n    // Añadir estilos base junto con mejoras para el layout compacto\n    style.textContent = `\n      ${variables}\n      ${animations}\n      ${previewStyles}\n      ${responseHistoryStyles}\n      \n      /* Optimizaciones de layout */\n      .response-container {\n        overflow-y: auto;\n        max-height: 100%;\n        padding: 0;\n        margin: 0;\n        display: flex;\n        flex-direction: column;\n      }\n      \n      /* Reducir tamaño de los contenedores de respuesta */\n      .response-entry {\n        margin-bottom: 0.75rem !important;\n        padding: 0.75rem !important;\n        border-radius: var(--ai-radius);\n        max-height: fit-content;\n        overflow: visible;\n      }\n      \n      /* Reducir margen entre elementos */\n      .response-content {\n        margin: 0.25rem 0 !important;\n        line-height: 1.4 !important;\n        padding: 0 !important;\n      }\n      \n      /* Ajustar espaciado de cabecera */\n      .response-header {\n        margin-bottom: 0.25rem !important;\n      }\n      \n      /* Ajustar espaciado de pie */\n      .response-footer {\n        padding-top: 0.5rem !important;\n        margin-top: 0.25rem !important;\n      }\n      \n      /* Optimizar espaciado de párrafos */\n      .response-content p,\n      .response-content ul,\n      .response-content ol {\n        margin: 0.25em 0 !important;\n      }\n      \n      /* Reducir margen en listas */\n      .response-content ul, \n      .response-content ol {\n        padding-left: 1.25em !important;\n      }\n      \n      /* Optimizar tamaño de imágenes */\n      .question-image img {\n        width: 80px !important;\n        height: 80px !important;\n      }\n      \n      /* Ajustar espaciado de preguntas con imágenes */\n      .question-container {\n        gap: 0.5rem !important;\n      }\n      \n      /* Optimizar tamaño de botones */\n      .response-action {\n        padding: 0.35rem !important;\n      }\n      \n      .tool-button {\n        padding: 0.35rem 0.75rem !important;\n      }\n      \n      /* Optimizar indicadores de escritura */\n      .typing-indicator {\n        padding: 0.125rem 0 !important;\n      }\n    `;\n\n    const container = document.createElement(\"div\");\n    container.className = \"response-container\";\n\n    // Crear entradas de respuesta con el nuevo método optimizado\n    this.responses.forEach((response) => {\n      container.appendChild(this.createResponseEntry(response));\n    });\n\n    // Limpiar y actualizar el shadow DOM\n    while (this.shadowRoot.firstChild) {\n      this.shadowRoot.removeChild(this.shadowRoot.firstChild);\n    }\n\n    this.shadowRoot.appendChild(style);\n    this.shadowRoot.appendChild(container);\n\n    // Auto-scroll al último mensaje si hay respuestas\n    if (this.responses.length > 0) {\n      requestAnimationFrame(() => {\n        container.scrollTop = container.scrollHeight;\n      });\n    }\n  }\n\n  formatTimestamp(timestamp) {\n    if (!timestamp) return \"\";\n\n    try {\n      console.log(\"[ResponseHistory] Formatting timestamp:\", timestamp);\n      return new Date(timestamp).toLocaleTimeString(this.language || \"en\", {\n        hour: \"2-digit\",\n        minute: \"2-digit\",\n      });\n    } catch (error) {\n      console.error(\"[ResponseHistory] Error formatting timestamp:\", error);\n      return \"\";\n    }\n  }\n}\n\ncustomElements.define(\"response-history\", ResponseHistory);\n","// Enhanced ChatWithImage.js\nimport { TRANSLATIONS } from \"../constants/translations.js\";\nimport { variables } from \"../styles/base/variables.js\";\nimport { animations } from \"../styles/base/animations.js\";\nimport { chatStyles } from \"../styles/components/chat.js\";\nimport { imagePreviewStyles } from \"../styles/components/image-preview.js\";\n\nexport class ChatWithImage extends HTMLElement {\n  constructor() {\n    super();\n    this.attachShadow({ mode: \"open\" });\n    this.tempImage = null;\n    // Don't initialize initialPrompt here since it's a getter\n  }\n\n  static get observedAttributes() {\n    return [\n      \"language\",\n      \"image-url\",\n      \"api-provider\",\n      \"initial-prompt\",\n      \"has-content\",\n      \"has-context\",\n    ];\n  }\n\n  get language() {\n    return this.getAttribute(\"language\") || \"en\";\n  }\n\n  get translations() {\n    return TRANSLATIONS[this.language] || TRANSLATIONS.en;\n  }\n\n  get imageUrl() {\n    return this.getAttribute(\"image-url\");\n  }\n\n  get apiProvider() {\n    return this.getAttribute(\"api-provider\") || \"openai\";\n  }\n\n  get supportsImages() {\n    return [\"openai\", \"anthropic\"].includes(this.apiProvider);\n  }\n\n  get initialPrompt() {\n    return this.getAttribute(\"initial-prompt\") || \"\";\n  }\n\n  get hasContent() {\n    return this.getAttribute(\"has-content\") === \"true\";\n  }\n\n  get hasContext() {\n    return this.getAttribute(\"has-context\") === \"true\";\n  }\n\n  async connectedCallback() {\n    this.render();\n    this.setupEventListeners();\n\n    if (this.imageUrl) {\n      await this.handleImageUrl(this.imageUrl);\n    }\n\n    // Set initial prompt if available\n    this.setInitialPrompt();\n  }\n\n  attributeChangedCallback(name, oldValue, newValue) {\n    if (oldValue === newValue) return;\n\n    switch (name) {\n      case \"language\":\n        this.updateTranslations();\n        break;\n      case \"image-url\":\n        if (newValue) {\n          this.handleImageUrl(newValue);\n        }\n        break;\n      case \"api-provider\":\n        this.updateUploadVisibility();\n        break;\n      case \"initial-prompt\":\n      case \"has-content\":\n      case \"has-context\":\n        this.updateInitialPrompt();\n        break;\n    }\n  }\n\n  setInitialPrompt() {\n    if (!this.shadowRoot) return;\n\n    const chatInput = this.shadowRoot.querySelector(\".chat-input\");\n    if (!chatInput) return;\n\n    // Determine which initial prompt to use\n    let prompt = \"\";\n\n    if (this.hasContent) {\n      prompt =\n        this.translations?.chat?.contentPrompt ||\n        \"Could you improve the text in the editor?\";\n    } else if (this.hasContext) {\n      prompt =\n        this.translations?.chat?.contextPrompt ||\n        \"Can you create a professional description based on this context?\";\n    } else if (this.initialPrompt) {\n      prompt = this.initialPrompt;\n    }\n\n    // Set the prompt in the input\n    if (prompt && chatInput.innerText.trim() === \"\") {\n      chatInput.innerText = prompt;\n\n      // Place cursor at end of text\n      if (document.activeElement === chatInput) {\n        const selection = window.getSelection();\n        const range = document.createRange();\n        range.selectNodeContents(chatInput);\n        range.collapse(false);\n        selection.removeAllRanges();\n        selection.addRange(range);\n      }\n    }\n  }\n\n  updateInitialPrompt() {\n    // Check if the input is empty before updating to avoid overwriting user input\n    const chatInput = this.shadowRoot?.querySelector(\".chat-input\");\n    if (chatInput && chatInput.innerText.trim() === \"\") {\n      this.setInitialPrompt();\n    }\n  }\n\n  updateImagePreview() {\n    // Remove this method's content - we don't want to show preview in chat\n    // Just keep track of the selected image\n    const existingPreview = this.shadowRoot.querySelector(\n      \".image-preview-container\"\n    );\n    if (existingPreview) {\n      existingPreview.remove();\n    }\n  }\n\n  render() {\n    const style = document.createElement(\"style\");\n    style.textContent = `\n      ${variables}\n      ${animations}\n      ${chatStyles}\n      \n      .chat-form {\n        display: flex;\n        gap: 8px;\n        align-items: flex-start;\n        padding: 8px;\n      }\n      \n      .chat-input-container {\n        position: relative;\n        flex: 1;\n        display: flex;\n        align-items: flex-end;\n      }\n      \n      .chat-submit {\n        flex-shrink: 0;\n        width: 32px;\n        height: 32px;\n        padding: 0;\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n      }\n      \n      .chat-input {\n        flex: 1;\n        min-height: 24px;\n        max-height: 150px;\n        padding: 12px;\n        padding-right: 40px;\n        background: var(--ai-background);\n        color: var(--ai-text);\n        font-size: 14px;\n        line-height: 1.5;\n        overflow-y: auto;\n        white-space: pre-wrap;\n        word-wrap: break-word;\n      }\n      \n      .chat-input:empty::before {\n        content: attr(data-placeholder);\n        color: var(--ai-text-light);\n      }\n      \n      .chat-input:focus {\n        outline: none;\n      }\n      \n      .chat-upload-button {\n        display: inline-flex;\n        cursor: pointer;\n        color: var(--ai-text-light);\n        width: 32px;\n        height: 32px;\n        background: lightgray;\n        padding: 0;\n        align-items: center;\n        justify-content: center;\n        border-radius: var(--ai-radius);\n        border: 0;\n        flex-shrink: 0;\n      }\n      \n      .chat-upload-button:hover {\n        color: var(--ai-text);\n      }\n      \n      .hidden {\n        display: none !important;\n      }\n    `;\n\n    const template = `\n      <div class=\"chat-container\">\n        <form class=\"chat-form\">\n          <div class=\"chat-input-container\">\n            <div class=\"chat-input\" \n                 contenteditable=\"true\" \n                 data-placeholder=\"${\n                   this.translations?.chat?.placeholder || \"Ask a question...\"\n                 }\"\n                 role=\"textbox\"\n                 aria-multiline=\"true\"></div>\n          </div>\n          ${\n            this.supportsImages\n              ? `\n            <label class=\"chat-upload-button\" title=\"Upload image\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                <path d=\"M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7\"/>\n                <circle cx=\"9\" cy=\"9\" r=\"2\"/>\n                <path d=\"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21\"/>\n              </svg>\n              <input type=\"file\" accept=\"image/*\" class=\"hidden\" id=\"imageInput\">\n            </label>\n          `\n              : \"\"\n          }\n          <button type=\"submit\" class=\"chat-submit\">\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n              <path d=\"M5 12h14\"/>\n              <path d=\"m12 5 7 7-7 7\"/>\n            </svg>\n          </button>\n        </form>\n      </div>\n    `;\n\n    this.shadowRoot.innerHTML = \"\";\n    this.shadowRoot.appendChild(style);\n    this.shadowRoot.appendChild(\n      document.createRange().createContextualFragment(template)\n    );\n  }\n\n  setupEventListeners() {\n    const form = this.shadowRoot.querySelector(\".chat-form\");\n    const input = this.shadowRoot.querySelector(\".chat-input\");\n    const uploadButton = this.shadowRoot.querySelector(\".chat-upload-button\");\n    const imageInput = this.shadowRoot.querySelector(\"#imageInput\");\n\n    form.addEventListener(\"submit\", this.handleSubmit.bind(this));\n\n    // Prevent default enter behavior and handle form submission\n    input.addEventListener(\"keydown\", (e) => {\n      if (e.key === \"Enter\" && !e.shiftKey) {\n        e.preventDefault();\n        form.dispatchEvent(new Event(\"submit\"));\n      }\n    });\n\n    // Focus event to set initial prompt if input is empty\n    input.addEventListener(\"focus\", () => {\n      if (input.innerText.trim() === \"\") {\n        this.setInitialPrompt();\n      }\n    });\n\n    if (uploadButton && imageInput) {\n      uploadButton.addEventListener(\"click\", (e) => {\n        // Prevent the click event from triggering multiple times\n        e.stopPropagation();\n      });\n\n      imageInput.addEventListener(\"change\", (e) => {\n        this.handleFileSelect(e);\n        // Reset the input value to allow selecting the same file again\n        e.target.value = \"\";\n      });\n    }\n  }\n\n  handleFileSelect(event) {\n    const file = event.target.files[0];\n    if (file) {\n      this.tempImage = file;\n    }\n  }\n\n  handleSubmit(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const input = this.shadowRoot.querySelector(\".chat-input\");\n    const message = input.innerText.trim();\n\n    if (message || this.tempImage) {\n      this.dispatchEvent(\n        new CustomEvent(\"chatMessage\", {\n          detail: { message, image: this.tempImage },\n          bubbles: true,\n          composed: true,\n        })\n      );\n      input.innerText = \"\";\n      this.tempImage = null;\n    }\n  }\n\n  updateTranslations() {\n    const input = this.shadowRoot.querySelector(\".chat-input\");\n    const submitButton = this.shadowRoot.querySelector(\".chat-submit\");\n\n    if (input && submitButton) {\n      input.setAttribute(\n        \"data-placeholder\",\n        this.translations?.chat?.placeholder || \"Ask a question...\"\n      );\n      submitButton.innerHTML = `\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n          <path d=\"M5 12h14\"/>\n          <path d=\"m12 5 7 7-7 7\"/>\n        </svg>\n      `;\n    }\n\n    // Update initial prompt based on new language\n    this.updateInitialPrompt();\n  }\n\n  updateUploadVisibility() {\n    const uploadButton = this.shadowRoot.querySelector(\".chat-upload-button\");\n    if (uploadButton) {\n      uploadButton.style.display = this.supportsImages ? \"inline-flex\" : \"none\";\n    }\n  }\n\n  async handleImageUrl(url) {\n    try {\n      const response = await fetch(url);\n      const blob = await response.blob();\n      const file = new File([blob], \"image.jpg\", { type: blob.type });\n      this.tempImage = file;\n      this.updateImagePreview();\n    } catch (error) {\n      console.error(\"Error loading image:\", error);\n    }\n  }\n}\n\ncustomElements.define(\"chat-with-image\", ChatWithImage);\n","// src/components/ToolBar.js\nimport { TRANSLATIONS } from \"../constants/translations.js\";\nimport { getToolIcon } from \"../services/icon-service.js\";\nimport { variables } from \"../styles/base/variables.js\";\nimport { toolbarStyles } from \"../styles/components/toolbar.js\";\n\nexport class ToolBar extends HTMLElement {\n  constructor() {\n    super();\n    this.attachShadow({ mode: \"open\" });\n    this.currentAction = \"improve\";\n  }\n\n  static get observedAttributes() {\n    return [\"has-content\", \"language\"];\n  }\n\n  get hasContent() {\n    return this.getAttribute(\"has-content\") === \"true\";\n  }\n\n  get language() {\n    return this.getAttribute(\"language\") || \"en\";\n  }\n\n  get translations() {\n    return TRANSLATIONS[this.language] || TRANSLATIONS.en;\n  }\n\n  connectedCallback() {\n    this.render();\n    this.bindEvents();\n  }\n\n  attributeChangedCallback(name, oldValue, newValue) {\n    if (oldValue === newValue) return;\n  \n    if (name === 'language') {\n      // Re-render the entire toolbar when language changes\n      this.render();\n    } else if (name === 'has-content') {\n      this.updateVisibleTools();\n    }\n  }\n\n  render() {\n    const style = document.createElement(\"style\");\n    style.textContent = `\n      :host {\n        display: block;\n      }\n\n      .tools {\n        display: flex;\n        gap: 8px;\n        margin-bottom: 16px;\n        flex-wrap: wrap;\n      }\n\n      .tool-button {\n        display: inline-flex;\n        align-items: center;\n        gap: 8px;\n        padding: 8px 16px;\n        border: none;\n        border-radius: 6px;\n        background: #e5e7eb;\n        cursor: pointer;\n        font-family: inherit;\n      }\n\n      .tool-button:hover {\n        background: #d1d5db;\n      }\n\n      .tool-button.active {\n        background: #3b82f6;\n        color: white;\n      }\n\n      .tool-button svg {\n        width: 16px;\n        height: 16px;\n      }\n    `;\n\n    this.shadowRoot.innerHTML = \"\";\n    this.shadowRoot.appendChild(style);\n    this.shadowRoot.appendChild(this.createToolbar());\n    \n    requestAnimationFrame(() => {\n      this.updateVisibleTools();\n    });\n  }\n\n  createToolbar() {\n    const toolbar = document.createElement(\"div\");\n    toolbar.className = \"tools\";\n\n    const tools = [\n      { action: \"improve\", label: this.translations.tools.improve },\n      { action: \"summarize\", label: this.translations.tools.summarize },\n      { action: \"expand\", label: this.translations.tools.expand },\n      { action: \"paraphrase\", label: this.translations.tools.paraphrase },\n      { action: \"more-formal\", label: this.translations.tools[\"more-formal\"] || this.translations.tools.formal },\n      { action: \"more-casual\", label: this.translations.tools[\"more-casual\"] || this.translations.tools.casual }\n    ];\n\n    tools.forEach((tool) => {\n      const button = document.createElement(\"button\");\n      button.className = \"tool-button\";\n      button.dataset.action = tool.action;\n      // Asegurarse de que siempre hay una etiqueta\n      const label = tool.label || tool.action;\n      button.innerHTML = `${getToolIcon(tool.action)}${label}`;\n      toolbar.appendChild(button);\n    });\n\n    return toolbar;\n  }\n\n  bindEvents() {\n    this.shadowRoot.querySelectorAll(\".tool-button\").forEach((button) => {\n      button.onclick = () => {\n        this.setActiveAction(button.dataset.action);\n        this.dispatchEvent(\n          new CustomEvent(\"toolaction\", {\n            detail: { action: button.dataset.action },\n            bubbles: true,\n            composed: true,\n          })\n        );\n      };\n    });\n  }\n\n  setActiveAction(action) {\n    this.currentAction = action;\n    this.shadowRoot.querySelectorAll(\".tool-button\").forEach((button) => {\n      button.classList.toggle(\"active\", button.dataset.action === action);\n    });\n  }\n\n  updateVisibleTools() {\n    const hasContent = this.hasContent;\n    const improveButton = this.shadowRoot.querySelector('[data-action=\"improve\"]');\n    const tools = this.shadowRoot.querySelectorAll(\".tool-button\");\n\n    if (!hasContent) {\n      improveButton.innerHTML = `\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n          <path d=\"m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z\"/>\n          <path d=\"M5 3v4\"/><path d=\"M19 17v4\"/><path d=\"M3 5h4\"/><path d=\"M17 19h4\"/>\n        </svg>\n        ${this.translations.tools.generate || 'Generate'}\n      `;\n    } else {\n      improveButton.innerHTML = `${getToolIcon(\"improve\")}${this.translations.tools.improve}`;\n    }\n\n    tools.forEach((tool) => {\n      const action = tool.dataset.action;\n      if (hasContent) {\n        tool.style.display = \"inline-flex\";\n      } else {\n        tool.style.display = action === \"improve\" ? \"inline-flex\" : \"none\";\n      }\n    });\n  }\n\n  getCurrentAction() {\n    return this.currentAction;\n  }\n}\n\ncustomElements.define(\"ai-toolbar\", ToolBar);\n","export const MODEL_CONFIG = {\n  openai: {\n    models: {\n      \"gpt-4-turbo\": {\n        name: \"GPT-4 Turbo\",\n        contextWindow: 128000,\n        description: \"Latest GPT-4 model with larger context window\",\n        suggested: true,\n        maxTokens: 4096,\n        costPer1k: 0.01,\n        supportsImages: true,\n      },\n      \"gpt-4\": {\n        name: \"GPT-4\",\n        contextWindow: 8192,\n        description: \"Most capable GPT-4 model\",\n        maxTokens: 4096,\n        costPer1k: 0.03,\n        supportsImages: true,\n      },\n      \"gpt-3.5-turbo\": {\n        name: \"GPT-3.5 Turbo\",\n        contextWindow: 16385,\n        description: \"Efficient and cost-effective model\",\n        maxTokens: 4096,\n        costPer1k: 0.0015,\n        supportsImages: false,\n      },\n    },\n    defaultModel: \"gpt-4-turbo\",\n    visionModel: \"gpt-4-turbo\", // Preferred model for vision tasks\n  },\n  anthropic: {\n    models: {\n      \"claude-3-opus-20240229\": {\n        name: \"Claude 3 Opus\",\n        contextWindow: 200000,\n        description: \"Most capable Claude model\",\n        suggested: true,\n        supportsImages: true,\n      },\n      \"claude-3-sonnet-20240229\": {\n        name: \"Claude 3 Sonnet\",\n        contextWindow: 200000,\n        description: \"Balance of intelligence and speed\",\n        supportsImages: true,\n      },\n    },\n    defaultModel: \"claude-3-opus-20240229\",\n    visionModel: \"claude-3-opus-20240229\", // Preferred model for vision tasks\n  },\n\n  deepseek: {\n    models: {\n      \"deepseek-chat\": {\n        name: \"DeepSeek Chat\",\n        contextWindow: 32768,\n        description: \"General purpose chat model\",\n        suggested: true,\n        maxTokens: 4096,\n      },\n      \"deepseek-coder\": {\n        name: \"DeepSeek Coder\",\n        contextWindow: 32768,\n        description: \"Specialized in code generation\",\n        maxTokens: 4096,\n      },\n    },\n    defaultModel: \"deepseek-chat\",\n  },\n\n  cohere: {\n    models: {\n      command: {\n        name: \"Command\",\n        contextWindow: 4096,\n        description: \"Latest generation model\",\n        suggested: true,\n        maxTokens: 4096,\n      },\n      \"command-light\": {\n        name: \"Command Light\",\n        contextWindow: 4096,\n        description: \"Faster, more efficient model\",\n        maxTokens: 4096,\n      },\n      \"command-nightly\": {\n        name: \"Command Nightly\",\n        contextWindow: 4096,\n        description: \"Experimental features\",\n        maxTokens: 4096,\n      },\n    },\n    defaultModel: \"command\",\n  },\n\n  google: {\n    models: {\n      \"gemini-pro\": {\n        name: \"Gemini Pro\",\n        contextWindow: 32768,\n        description: \"Most capable Gemini model\",\n        suggested: true,\n        maxTokens: 4096,\n        supportsImages: false,\n      },\n      \"gemini-pro-vision\": {\n        name: \"Gemini Pro Vision\",\n        contextWindow: 32768,\n        description: \"Multimodal capabilities\",\n        maxTokens: 4096,\n        supportsImages: true,\n      },\n    },\n    defaultModel: \"gemini-pro\",\n    visionModel: \"gemini-pro-vision\", // Preferred model for vision tasks\n  },\n\n  mistral: {\n    models: {\n      \"mistral-large-latest\": {\n        name: \"Mistral Large\",\n        contextWindow: 32768,\n        description: \"Most capable Mistral model\",\n        suggested: true,\n        maxTokens: 4096,\n      },\n      \"mistral-medium-latest\": {\n        name: \"Mistral Medium\",\n        contextWindow: 32768,\n        description: \"Balanced performance\",\n        maxTokens: 4096,\n      },\n      \"mistral-small-latest\": {\n        name: \"Mistral Small\",\n        contextWindow: 32768,\n        description: \"Fast and efficient\",\n        maxTokens: 4096,\n      },\n    },\n    defaultModel: \"mistral-large-latest\",\n  },\n\n  ollama: {\n    models: {\n      llama2: {\n        name: \"Llama 2\",\n        contextWindow: 4096,\n        description: \"Default Llama 2 model\",\n        suggested: true,\n        maxTokens: 4096,\n      },\n      \"llama2:13b\": {\n        name: \"Llama 2 13B\",\n        contextWindow: 4096,\n        description: \"Balanced 13B parameter model\",\n        maxTokens: 4096,\n      },\n      \"llama2:70b\": {\n        name: \"Llama 2 70B\",\n        contextWindow: 4096,\n        description: \"Large 70B parameter model\",\n        maxTokens: 4096,\n      },\n      mistral: {\n        name: \"Mistral\",\n        contextWindow: 8192,\n        description: \"Mistral base model\",\n        maxTokens: 4096,\n      },\n      mixtral: {\n        name: \"Mixtral\",\n        contextWindow: 32768,\n        description: \"Mixtral 8x7B model\",\n        maxTokens: 4096,\n      },\n    },\n    defaultModel: \"llama2\",\n  },\n};\n","import { MODEL_CONFIG } from \"../constants/model-config.js\";\n\nexport class ModelManager {\n  constructor(provider = \"openai\") {\n    this.provider = provider;\n    this.config = MODEL_CONFIG;\n  }\n\n  getModelConfig(modelId) {\n    const providerConfig = this.config[this.provider];\n    if (!providerConfig) {\n      throw new Error(`Provider ${this.provider} not supported`);\n    }\n\n    if (modelId && providerConfig.models[modelId]) {\n      return providerConfig.models[modelId];\n    }\n\n    return providerConfig.models[providerConfig.default];\n  }\n\n  getDefaultModel() {\n    const providerConfig = this.config[this.provider];\n    if (!providerConfig) {\n      throw new Error(`Provider ${this.provider} not supported`);\n    }\n    return providerConfig.default;\n  }\n\n  getAllModels() {\n    const providerConfig = this.config[this.provider];\n    if (!providerConfig) {\n      throw new Error(`Provider ${this.provider} not supported`);\n    }\n    return Object.values(providerConfig.models);\n  }\n  \n  isProviderSupported(provider) {\n    return !!this.config[provider];\n  }\n\n  isImageSupportedForProvider(provider) {\n    // Check if the provider exists and has vision capabilities\n    const providerConfig = this.config[provider];\n    if (!providerConfig) return false;\n    \n    // If provider has explicit vision model defined, it supports images\n    if (providerConfig.visionModel) return true;\n    \n    // These providers are known to support images\n    return [\"openai\", \"anthropic\", \"google\"].includes(provider);\n  }\n  \n  getVisionModelForProvider(provider) {\n    const providerConfig = this.config[provider];\n    if (!providerConfig) return null;\n    \n    // If there's a specific vision model defined, use it\n    if (providerConfig.visionModel) {\n      return providerConfig.visionModel;\n    }\n    \n    // Otherwise return the default model (assuming it supports vision)\n    return providerConfig.defaultModel;\n  }\n  \n  setProvider(provider) {\n    if (this.isProviderSupported(provider)) {\n      this.provider = provider;\n    } else {\n      throw new Error(`Provider ${provider} not supported`);\n    }\n  }\n}\n","// token-manager.js\nimport { ModelManager } from \"./model-manager.js\";\nimport { MODEL_CONFIG } from \"../constants/model-config.js\";\n\nexport class TokenManager {\n  constructor() {\n    this.modelManager = new ModelManager();\n    \n    // Average tokens per character for different languages\n    this.tokensPerChar = {\n      en: 0.25, // English: ~4 chars per token\n      es: 0.28, // Spanish: ~3.6 chars per token\n      fr: 0.28, // French: ~3.6 chars per token\n      de: 0.3, // German: ~3.3 chars per token (compound words)\n      zh: 0.5, // Chinese: ~2 chars per token\n      ja: 0.5, // Japanese: ~2 chars per token\n    };\n\n    this.defaultTokensPerChar = 0.25;\n  }\n}\n","// markdown-handler.js\nexport class MarkdownHandler {\n  constructor() {\n    this.marked = null;\n  }\n\n  async initialize() {\n    try {\n      const { marked } = await import('https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js');\n      this.marked = marked;\n      \n      this.marked.setOptions({\n        gfm: true,\n        breaks: true,\n        sanitize: false\n      });\n    } catch (error) {\n      console.error('Error initializing markdown handler:', error);\n      throw error;\n    }\n  }\n\n  convert(text) {\n    if (!text || !this.marked) return text;\n    return this.marked(text);\n  }\n}\n","// api-client.js - Versión mejorada con corrección del procesamiento de streams\nimport { ModelManager } from \"./model-manager.js\";\n\nclass APIClient {\n  constructor(config = {}) {\n    this.modelManager = new ModelManager(config.provider || \"openai\");\n\n    this.config = {\n      provider: config.provider || \"openai\",\n      // Punto de entrada al proxy CodeIgniter 3\n      proxyEndpoint:\n        config.proxyEndpoint || \"http://llmproxy2.test:8080/api/llm-proxy\", // Sin \"api/\"\n      models: {\n        openai: config.model || \"gpt-4-turbo\",\n        deepseek: \"deepseek-chat\",\n        anthropic: \"claude-3-opus-20240229\",\n        cohere: \"command\",\n        google: \"gemini-pro\",\n        mistral: \"mistral-large-latest\",\n      },\n      visionModels: {\n        openai: \"gpt-4-turbo\",\n        anthropic: \"claude-3-opus-20240229\",\n      },\n      temperature: config.temperature || 0.7,\n      // Ya no necesitas almacenar el API key en el cliente\n      sessionToken: config.sessionToken || \"\",\n      systemPrompt:\n        config.systemPrompt ||\n        \"Actúa como un experto en redacción de descripciones de productos para tiendas en línea.\\n\\n\" +\n          \"Tu tarea es generar o mejorar la descripción de un producto con un enfoque atractivo y persuasivo, destacando sus características principales, beneficios y posibles usos.\\n\\n\" +\n          \"Si el usuario ya ha escrito una descripción: Mejórala manteniendo su esencia, pero haciéndola más clara, persuasiva y optimizada para ventas.\\n\\n\" +\n          \"Si la descripción está vacía: Genera una nueva descripción atractiva, destacando características y beneficios. Usa un tono profesional y cercano, adaptado a una tienda en línea.\\n\\n\" +\n          \"Si hay una imagen del producto, aprovecha los detalles visuales para enriquecer la descripción.\\n\\n\" +\n          \"Si aplica, menciona información relevante del comercio para reforzar la confianza del comprador (envíos, garantía, atención al cliente, etc.).\\n\\n\" +\n          \"Mantén el texto claro, sin repeticiones innecesarias, y optimizado para SEO si es posible.\",\n      // Parámetros adicionales para el proxy\n      tenantId: config.tenantId || \"\",\n      userId: config.userId || \"\",\n      debugMode: config.debugMode || false,\n    };\n\n    // Inicializar contador para logging\n    this._streamCounter = 0;\n  }\n\n  setSessionToken(token) {\n    this.config.sessionToken = token;\n  }\n\n  setProvider(provider) {\n    if (this.modelManager.isProviderSupported(provider)) {\n      this.config.provider = provider;\n      this.modelManager.setProvider(provider);\n      // Reset to default model for new provider\n      this.config.models[provider] = this.modelManager.getDefaultModel();\n    } else {\n      throw new Error(`Provider ${provider} not supported`);\n    }\n  }\n\n  setModel(model) {\n    if (model) {\n      this.config.models[this.config.provider] = model;\n    }\n  }\n\n  updateConfig(config) {\n    if (config.provider) {\n      this.setProvider(config.provider);\n    }\n    if (config.model) {\n      this.setModel(config.model);\n    }\n    if (config.sessionToken) {\n      this.setSessionToken(config.sessionToken);\n    }\n    if (config.tenantId) {\n      this.config.tenantId = config.tenantId;\n    }\n    if (config.userId) {\n      this.config.userId = config.userId;\n    }\n    if (config.proxyEndpoint) {\n      this.config.proxyEndpoint = config.proxyEndpoint;\n    }\n    if (config.debugMode !== undefined) {\n      this.config.debugMode = config.debugMode;\n    }\n  }\n\n  // Método mejorado para processStream\n  async processStream(response, onProgress) {\n    const reader = response.body.getReader();\n    const decoder = new TextDecoder();\n    let buffer = \"\";\n    let completeText = \"\";\n    let accumulatedChunks = [];\n    let streamedChars = 0;\n    let chunkCounter = 0;\n\n    try {\n      console.log(\"[APIClient] Iniciando procesamiento de stream\");\n\n      // Función para procesar JSON y extraer contenido\n      const extractContentFromJSON = (data) => {\n        let content = \"\";\n\n        if (\n          data.choices &&\n          data.choices[0].delta &&\n          data.choices[0].delta.content !== undefined\n        ) {\n          // Formato OpenAI\n          content = data.choices[0].delta.content;\n        } else if (data.text !== undefined) {\n          // Formato común alternativo\n          content = data.text;\n        } else if (data.content !== undefined) {\n          // Otro formato común\n          content = data.content;\n        } else if (data.delta && data.delta.text !== undefined) {\n          // Formato específico de algunos modelos\n          content = data.delta.text;\n        }\n\n        return content;\n      };\n\n      // Verificar si es el inicio de la respuesta\n      let isFirstContentChunk = true;\n\n      while (true) {\n        const { done, value } = await reader.read();\n\n        if (done) {\n          console.log(\n            \"[APIClient] Stream completado con\",\n            streamedChars,\n            \"caracteres procesados\"\n          );\n\n          // Procesar cualquier contenido pendiente en el buffer\n          if (buffer.trim()) {\n            try {\n              // Intento final de extraer contenido estructurado\n              const jsonMatch = buffer.match(/data: ({.*})/);\n              if (jsonMatch) {\n                try {\n                  const data = JSON.parse(jsonMatch[1]);\n                  const content = extractContentFromJSON(data);\n                  if (content) {\n                    completeText += content;\n                    onProgress(content);\n                  }\n                } catch (e) {\n                  // Si falla, usar el buffer como texto plano\n                  completeText += buffer.trim();\n                  onProgress(buffer.trim());\n                }\n              } else {\n                // Usar como texto plano\n                const cleanBuffer = buffer.replace(/^data:\\s*/, \"\").trim();\n                if (cleanBuffer && cleanBuffer !== \"[DONE]\") {\n                  completeText += cleanBuffer;\n                  onProgress(cleanBuffer);\n                }\n              }\n            } catch (e) {\n              console.warn(\"[APIClient] Error procesando buffer final:\", e);\n            }\n          }\n          break;\n        }\n\n        // Decodificar el chunk recibido y añadirlo al buffer\n        const chunk = decoder.decode(value, { stream: true });\n        buffer += chunk;\n        chunkCounter++;\n\n        if (this.config.debugMode) {\n          console.log(\n            `[APIClient] Chunk #${chunkCounter} recibido:`,\n            chunk.length > 100\n              ? `${chunk.substring(0, 100)}... (${chunk.length} chars)`\n              : chunk\n          );\n          // Guardar para análisis\n          accumulatedChunks.push(chunk);\n        }\n\n        // Procesamos líneas completas\n        const lines = buffer.split(\"\\n\");\n        buffer = lines.pop() || \"\"; // El último elemento puede estar incompleto\n\n        let foundContent = false;\n\n        for (const line of lines) {\n          // Filtrar líneas que son datos de la API\n          if (line.startsWith(\"data: \")) {\n            const content = line.slice(5).trim();\n\n            if (content === \"[DONE]\") continue;\n\n            let jsonData;\n            try {\n              jsonData = JSON.parse(content);\n            } catch (e) {\n              // Si no es JSON válido y no está vacío, tratar como texto plano\n              if (content.trim()) {\n                foundContent = true;\n                completeText += content;\n                onProgress(content);\n              }\n              continue;\n            }\n\n            const extractedContent = extractContentFromJSON(jsonData);\n\n            if (extractedContent) {\n              foundContent = true;\n              completeText += extractedContent;\n              streamedChars += extractedContent.length;\n\n              // Llamar a onProgress con solo el nuevo contenido\n              onProgress(extractedContent);\n            }\n          }\n        }\n\n        // Si no hemos encontrado contenido en las líneas pero tenemos datos\n        // en el buffer, intentamos verificar si hay datos parciales\n        if (!foundContent && buffer.includes(\"data: {\")) {\n          try {\n            const parts = buffer.split(\"data: \");\n            for (let i = 1; i < parts.length; i++) {\n              if (parts[i].trim() && parts[i].includes('\"delta\":{\"content\":')) {\n                try {\n                  // Intentar extraer contenido de delta\n                  const match = parts[i].match(/\"content\":\"([^\"]*)\"/);\n                  if (match && match[1]) {\n                    const content = match[1];\n                    completeText += content;\n                    streamedChars += content.length;\n                    onProgress(content);\n\n                    // Limpiar la parte procesada del buffer\n                    const processed = parts[i].substring(\n                      0,\n                      match.index + match[0].length\n                    );\n                    buffer = buffer.replace(processed, \"\");\n\n                    if (isFirstContentChunk) {\n                      isFirstContentChunk = false;\n                      if (this.config.debugMode) {\n                        console.log(\n                          `[APIClient] Primer fragmento (buffer): \"${content}\"`\n                        );\n                      }\n                    }\n                  }\n                } catch (e) {\n                  console.warn(\n                    \"[APIClient] Error procesando buffer parcial:\",\n                    e\n                  );\n                }\n              }\n            }\n          } catch (e) {\n            console.warn(\"[APIClient] Error analizando buffer:\", e);\n          }\n        }\n      }\n\n      // Verificación final del resultado\n      if (this.config.debugMode) {\n        console.log(\n          `[APIClient] Texto completo (${completeText.length} chars):`,\n          completeText.substring(0, 50) +\n            (completeText.length > 50 ? \"...\" : \"\")\n        );\n\n        // Verificar si hay problemas con el inicio\n        if (completeText.startsWith(\"aro,\") && accumulatedChunks.length > 0) {\n          console.warn(\n            \"[APIClient] Posible pérdida del inicio. Primeros chunks:\",\n            accumulatedChunks.slice(0, 3)\n          );\n        }\n      }\n\n      return completeText;\n    } catch (error) {\n      console.error(\"[APIClient] Error en procesamiento de stream:\", error);\n      throw error;\n    }\n  }\n\n  async makeRequest(prompt, content, onProgress = () => {}) {\n    try {\n      const model = this.config.models[this.config.provider];\n      if (!model) {\n        throw new Error(\"Model not configured for provider\");\n      }\n\n      // Crear wrapper para onProgress que nos permita debugging\n      const progressHandler = this.config.debugMode\n        ? this._createDebugProgressHandler(onProgress)\n        : onProgress;\n\n      // Preparar el payload para el proxy\n      const payload = {\n        provider: this.config.provider,\n        model: model,\n        messages: [\n          {\n            role: \"system\",\n            content: this.config.systemPrompt,\n          },\n          {\n            role: \"user\",\n            content: `${prompt}\\n\\n${content || \"Crea una nueva descripción.\"}`,\n          },\n        ],\n        temperature: this.config.temperature,\n        stream: true,\n        tenantId: this.config.tenantId,\n        userId: this.config.userId,\n      };\n\n      console.log(\n        \"[APIClient] Enviando solicitud al proxy:\",\n        this.config.proxyEndpoint\n      );\n      if (this.config.debugMode) {\n        console.log(\"[APIClient] Payload:\", JSON.stringify(payload, null, 2));\n      }\n\n      // Reset stream counter for each request\n      this._streamCounter = 0;\n\n      const response = await fetch(this.config.proxyEndpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n      });\n\n      console.log(\"[APIClient] Respuesta del proxy:\", {\n        status: response.status,\n        ok: response.ok,\n        headers: Object.fromEntries([...response.headers.entries()]),\n      });\n\n      if (!response.ok) {\n        let errorMessage;\n        try {\n          const errorData = await response.json();\n          errorMessage =\n            errorData.error?.message ||\n            `API Error: ${response.status} ${response.statusText}`;\n        } catch (e) {\n          errorMessage = `API Error: ${response.status} ${response.statusText}`;\n        }\n        throw new Error(errorMessage);\n      }\n\n      return await this.processStream(response, progressHandler);\n    } catch (error) {\n      console.error(\"[APIClient] Error al hacer la solicitud:\", error);\n      throw new APIError(error.message, error);\n    }\n  }\n\n  async makeRequestWithImage(\n    prompt,\n    content,\n    imageSource,\n    onProgress = () => {}\n  ) {\n    try {\n      let imageData;\n      let imageUrl;\n      let mimeType = \"image/jpeg\"; // Default mime type\n\n      if (typeof imageSource === \"string\") {\n        imageUrl = imageSource;\n      } else if (imageSource instanceof File) {\n        imageData = await this.imageToBase64(imageSource);\n        mimeType = imageSource.type || mimeType; // Use the actual file type if available\n        console.log(\"[APIClient] Image file type:\", mimeType);\n      } else {\n        throw new Error(\"Invalid image source\");\n      }\n\n      // Crear wrapper para onProgress con debugging\n      const progressHandler = this.config.debugMode\n        ? this._createDebugProgressHandler(onProgress)\n        : onProgress;\n\n      // Construir el mensaje con la imagen\n      const messages = [];\n      if (this.config.provider === \"openai\") {\n        messages.push({\n          role: \"system\",\n          content: this.config.systemPrompt,\n        });\n        messages.push({\n          role: \"user\",\n          content: [\n            {\n              type: \"text\",\n              text: `${prompt}\\n\\n${\n                content || \"Please create a new description.\"\n              }`,\n            },\n            {\n              type: \"image_url\",\n              image_url: imageUrl\n                ? { url: imageUrl, detail: \"high\" }\n                : {\n                    url: `data:${mimeType};base64,${imageData}`,\n                    detail: \"high\",\n                  },\n            },\n          ],\n        });\n      } else if (this.config.provider === \"anthropic\") {\n        messages.push({\n          role: \"user\",\n          content: [\n            {\n              type: \"text\",\n              text: this.config.systemPrompt,\n            },\n            {\n              type: \"image\",\n              source: imageUrl\n                ? { type: \"url\", url: imageUrl }\n                : { type: \"base64\", media_type: mimeType, data: imageData },\n            },\n            {\n              type: \"text\",\n              text: `${prompt}\\n\\n${\n                content || \"Please create a new description.\"\n              }`,\n            },\n          ],\n        });\n      } else if (this.config.provider === \"google\") {\n        // Google Gemini format\n        messages.push({\n          role: \"user\",\n          parts: [\n            {\n              text: `${this.config.systemPrompt}\\n\\n${prompt}\\n\\n${\n                content || \"Please create a new description.\"\n              }`,\n            },\n            {\n              inline_data: {\n                mime_type: mimeType,\n                data: imageData,\n              },\n            },\n          ],\n        });\n      }\n\n      // Get the appropriate vision model\n      const visionModel = this.modelManager.getVisionModelForProvider(\n        this.config.provider\n      );\n\n      const payload = {\n        provider: this.config.provider,\n        model: visionModel || this.config.models[this.config.provider],\n        messages: messages,\n        temperature: this.config.temperature,\n        stream: true,\n        tenantId: this.config.tenantId,\n        userId: this.config.userId,\n        hasImage: true,\n      };\n\n      console.log(\"[APIClient] Sending image request to proxy:\", {\n        endpoint: this.config.proxyEndpoint,\n        provider: this.config.provider,\n        model: payload.model,\n        hasImage: true,\n        imageType: mimeType,\n      });\n\n      // Reset stream counter for each request\n      this._streamCounter = 0;\n\n      const response = await fetch(this.config.proxyEndpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...(this.config.sessionToken && {\n            Authorization: `Bearer ${this.config.sessionToken}`,\n          }),\n        },\n        body: JSON.stringify(payload),\n      });\n\n      console.log(\n        \"[APIClient] Image request response status:\",\n        response.status,\n        response.statusText\n      );\n\n      if (!response.ok) {\n        try {\n          const errorData = await response.json();\n          console.error(\"[APIClient] Image API Error Response:\", errorData);\n          throw new Error(\n            errorData.error?.message ||\n              `API Error: ${response.status} ${response.statusText}`\n          );\n        } catch (parseError) {\n          console.error(\n            \"[APIClient] Failed to parse error response:\",\n            parseError\n          );\n          const rawText = await response.text().catch(() => \"\");\n          console.error(\"[APIClient] Raw error response:\", rawText);\n          throw new Error(\n            `API Error: ${response.status} ${response.statusText}`\n          );\n        }\n      }\n\n      return await this.processStream(response, progressHandler);\n    } catch (error) {\n      console.error(\"[APIClient] Image processing error:\", error);\n      throw new Error(`Image processing failed: ${error.message}`);\n    }\n  }\n\n  async imageToBase64(imageFile) {\n    if (!imageFile) {\n      throw new Error(\"No image file provided\");\n    }\n\n    if (!imageFile.type.startsWith(\"image/\")) {\n      throw new Error(\"Invalid file type. Please provide an image file.\");\n    }\n\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onload = () => {\n        try {\n          const result = reader.result.split(\",\")[1];\n          if (!result) {\n            reject(new Error(\"Failed to convert image to base64\"));\n            return;\n          }\n          resolve(result);\n        } catch (error) {\n          reject(new Error(\"Failed to process image data\"));\n        }\n      };\n      reader.onerror = () => reject(new Error(\"Failed to read image file\"));\n      reader.readAsDataURL(imageFile);\n    });\n  }\n\n  async enhanceText(\n    content,\n    action = \"improve\",\n    imageFile = null,\n    context = \"\",\n    onProgress = () => {}\n  ) {\n    const prompts = {\n      improve: `Mejora esta descripción considerando estos detalles del producto:\\n${context}\\n\\nDescripción actual:`,\n      summarize: `Teniendo en cuenta estos detalles del producto:\\n${context}\\n\\nCrea un resumen conciso y efectivo de la siguiente descripción:`,\n      expand: `Basándote en estos detalles del producto:\\n${context}\\n\\nExpande esta descripción añadiendo más detalles, beneficios y casos de uso:`,\n      paraphrase: `Considerando estos detalles del producto:\\n${context}\\n\\nReescribe esta descripción manteniendo el mensaje principal pero con un enfoque fresco:`,\n      \"more-formal\": `Usando estos detalles del producto:\\n${context}\\n\\nReescribe esta descripción con un tono más formal, profesional y técnico, manteniendo la información clave pero usando un lenguaje más sofisticado y corporativo:`,\n      \"more-casual\": `Usando estos detalles del producto:\\n${context}\\n\\nReescribe esta descripción con un tono más casual y cercano, como si estuvieras explicándolo a un amigo, manteniendo un lenguaje accesible y conversacional pero sin perder profesionalismo:`,\n      empty: `Usando estos detalles del producto:\\n${context}\\n\\nCrea una descripción profesional y atractiva que destaque sus características principales:`,\n    };\n\n    const prompt = prompts[action] || prompts.improve;\n\n    // Función wrapper para el manejo de progreso\n    const progressHandler = this.config.debugMode\n      ? this._createDebugProgressHandler(onProgress)\n      : onProgress;\n\n    try {\n      if (\n        imageFile &&\n        this.modelManager.isImageSupportedForProvider(this.config.provider)\n      ) {\n        return await this.makeRequestWithImage(\n          prompt,\n          content,\n          imageFile,\n          progressHandler\n        );\n      } else {\n        return await this.makeRequest(prompt, content, progressHandler);\n      }\n    } catch (error) {\n      console.error(\"[APIClient] Error in enhanceText:\", error);\n      throw new Error(`Error al mejorar el texto: ${error.message}`);\n    }\n  }\n\n  async chatResponse(content, message, image = null, onProgress = () => {}) {\n    try {\n      // Wrapper para debugging de progreso\n      const progressHandler = this.config.debugMode\n        ? this._createDebugProgressHandler(onProgress)\n        : onProgress;\n\n      // Preparamos los mensajes para enviar al proxy\n      let messages = [\n        { role: \"system\", content: this.config.systemPrompt },\n        { role: \"user\", content: content },\n      ];\n\n      let hasImage = false;\n\n      if (message) {\n        // Si hay imagen y el proveedor la soporta, formatear adecuadamente\n        if (\n          image &&\n          this.modelManager.isImageSupportedForProvider(this.config.provider)\n        ) {\n          try {\n            const imageData = await this.imageToBase64(image);\n            const mimeType = image.type || \"image/jpeg\"; // Default to jpeg if type is not available\n            console.log(\"[APIClient] Chat with image - file type:\", mimeType);\n\n            hasImage = true;\n\n            if (this.config.provider === \"openai\") {\n              messages.push({\n                role: \"user\",\n                content: [\n                  { type: \"text\", text: message },\n                  {\n                    type: \"image_url\",\n                    image_url: {\n                      url: `data:${mimeType};base64,${imageData}`,\n                      detail: \"auto\",\n                    },\n                  },\n                ],\n              });\n            } else if (this.config.provider === \"anthropic\") {\n              messages.push({\n                role: \"user\",\n                content: [\n                  { type: \"text\", text: message },\n                  {\n                    type: \"image\",\n                    source: {\n                      type: \"base64\",\n                      media_type: mimeType,\n                      data: imageData,\n                    },\n                  },\n                ],\n              });\n            } else if (this.config.provider === \"google\") {\n              // Google Gemini format\n              messages.push({\n                role: \"user\",\n                parts: [\n                  { text: message },\n                  {\n                    inline_data: {\n                      mime_type: mimeType,\n                      data: imageData,\n                    },\n                  },\n                ],\n              });\n            } else {\n              // Para proveedores que no soportan imágenes, enviar solo texto\n              messages.push({ role: \"user\", content: message });\n              hasImage = false;\n            }\n          } catch (imageError) {\n            console.error(\n              \"[APIClient] Failed to process image for chat:\",\n              imageError\n            );\n            // Fallback to text-only message\n            messages.push({ role: \"user\", content: message });\n            hasImage = false;\n          }\n        } else {\n          // Sin imagen, solo añadir el mensaje normal\n          messages.push({ role: \"user\", content: message });\n        }\n      }\n\n      // Select the appropriate model based on whether we're sending an image\n      const model = hasImage\n        ? this.modelManager.getVisionModelForProvider(this.config.provider)\n        : this.config.models[this.config.provider];\n\n      const payload = {\n        provider: this.config.provider,\n        model: model,\n        messages: messages,\n        temperature: this.config.temperature,\n        stream: true,\n        tenantId: this.config.tenantId,\n        userId: this.config.userId,\n        hasImage: hasImage,\n      };\n\n      console.log(\"[APIClient] Sending chat request to proxy:\", {\n        endpoint: this.config.proxyEndpoint,\n        provider: this.config.provider,\n        model: payload.model,\n        hasImage: hasImage,\n      });\n\n      // Reset stream counter for each request\n      this._streamCounter = 0;\n\n      const response = await fetch(this.config.proxyEndpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          ...(this.config.sessionToken && {\n            Authorization: `Bearer ${this.config.sessionToken}`,\n          }),\n        },\n        body: JSON.stringify(payload),\n      });\n\n      console.log(\n        \"[APIClient] Chat response status:\",\n        response.status,\n        response.statusText\n      );\n\n      if (!response.ok) {\n        try {\n          const errorData = await response.json();\n          console.error(\"[APIClient] Chat API Error Response:\", errorData);\n          throw new Error(\n            errorData.error?.message ||\n              `API Error: ${response.status} ${response.statusText}`\n          );\n        } catch (parseError) {\n          console.error(\n            \"[APIClient] Failed to parse error response:\",\n            parseError\n          );\n          const rawText = await response.text().catch(() => \"\");\n          console.error(\"[APIClient] Raw error response:\", rawText);\n          throw new Error(\n            `API Error: ${response.status} ${response.statusText}`\n          );\n        }\n      }\n\n      return await this.processStream(response, progressHandler);\n    } catch (error) {\n      console.error(\"[APIClient] Chat response error:\", error);\n      throw new APIError(`Chat response failed: ${error.message}`, error);\n    }\n  }\n\n  get supportsImages() {\n    return this.modelManager.isImageSupportedForProvider(this.config.provider);\n  }\n\n  // Método auxiliar para crear wrapper de debug para onProgress\n  _createDebugProgressHandler(originalHandler) {\n    let chunkIndex = 0;\n\n    return (chunk) => {\n      // Log del chunk recibido\n      console.log(\n        `[APIClient] Progress chunk #${chunkIndex}:`,\n        chunk.length > 30\n          ? `${chunk.substring(0, 30)}... (${chunk.length} chars)`\n          : chunk,\n        `[${Array.from(chunk.substring(0, 5))\n          .map((c) => c.charCodeAt(0))\n          .join(\",\")}]`\n      );\n\n      // Verificar primeros chunks con cuidado\n      if (chunkIndex < 3) {\n        // Análisis específico para los primeros fragmentos\n        if (chunkIndex === 0 && chunk.length < 5) {\n          console.warn(\"[APIClient] ⚠️ Primer fragmento es muy corto:\", chunk);\n        }\n\n        // Verificar si parece un fragmento incompleto\n        if ((chunkIndex === 0 && chunk === \"aro\") || chunk === \"laro\") {\n          console.warn(\n            \"[APIClient] ⚠️ PROBLEMA DETECTADO: Fragmento inicial incompleto:\",\n            chunk\n          );\n        }\n      }\n\n      // Llamar al manejador original\n      if (typeof originalHandler === \"function\") {\n        originalHandler(chunk);\n      }\n\n      chunkIndex++;\n    };\n  }\n}\n\nclass APIError extends Error {\n  constructor(message, originalError = null) {\n    super(message);\n    this.name = \"APIError\";\n    this.originalError = originalError;\n  }\n}\n\nexport function createAPIClient(config = {}) {\n  return new APIClient(config);\n}\n","// cache-manager.js\n\nexport class CacheManager {\n  constructor(options = {}) {\n    this.options = {\n      prefix: options.prefix || \"ai-text-enhancer-cache\",\n      maxItems: options.maxItems || 20,\n      ttl: options.ttl || 30 * 60 * 1000, // 30 minutes in milliseconds\n      storage: options.storage || window.sessionStorage,\n    };\n\n    // Ensure storage is available\n    this.validateStorage();\n  }\n\n  /**\n   * Validates that storage is available and working\n   * @throws {Error} If storage is not available\n   */\n  validateStorage() {\n    try {\n      const testKey = `${this.options.prefix}-test`;\n      this.options.storage.setItem(testKey, \"test\");\n      this.options.storage.removeItem(testKey);\n    } catch (error) {\n      throw new Error(\"Storage is not available: \" + error.message);\n    }\n  }\n\n  /**\n   * Generates a cache key for a given action and content\n   * @param {string} action - The action being performed\n   * @param {string} content - The content being processed\n   * @returns {string} The generated cache key\n   */\n  generateKey(action, content) {\n    const hash = this.hashString(content);\n    return `${this.options.prefix}-${action}-${hash}`;\n  }\n\n  /**\n   * Creates a hash from a string\n   * @param {string} str - The string to hash\n   * @returns {string} The hashed string\n   */\n  hashString(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n      const char = str.charCodeAt(i);\n      hash = (hash << 5) - hash + char;\n      hash = hash & hash;\n    }\n    return Math.abs(hash).toString(36);\n  }\n\n  /**\n   * Gets a value from cache\n   * @param {string} action - The action associated with the cached content\n   * @param {string} content - The original content\n   * @returns {string|null} The cached value or null if not found/expired\n   */\n  get(action, content) {\n    try {\n      const key = this.generateKey(action, content);\n      const cachedItem = this.options.storage.getItem(key);\n\n      if (!cachedItem) return null;\n\n      const item = JSON.parse(cachedItem);\n\n      // Check if item has expired\n      if (Date.now() - item.timestamp > this.options.ttl) {\n        this.delete(action, content);\n        return null;\n      }\n\n      return item.value;\n    } catch (error) {\n      console.error(\"Error reading from cache:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Stores a value in cache\n   * @param {string} action - The action associated with the content\n   * @param {string} content - The original content\n   * @param {string} value - The value to cache\n   */\n  set(action, content, value) {\n    try {\n      const key = this.generateKey(action, content);\n      const item = {\n        value,\n        timestamp: Date.now(),\n      };\n\n      // Ensure we don't exceed max items\n      this.enforceSizeLimit();\n\n      this.options.storage.setItem(key, JSON.stringify(item));\n    } catch (error) {\n      console.error(\"Error writing to cache:\", error);\n      this.cleanup(); // Attempt to free up space\n    }\n  }\n\n  /**\n   * Deletes a specific item from cache\n   * @param {string} action - The action associated with the content\n   * @param {string} content - The original content\n   */\n  delete(action, content) {\n    const key = this.generateKey(action, content);\n    this.options.storage.removeItem(key);\n  }\n\n  /**\n   * Enforces the cache size limit\n   */\n  enforceSizeLimit() {\n    try {\n      const keys = this.getCacheKeys();\n      if (keys.length >= this.options.maxItems) {\n        // Remove oldest items first\n        const itemsToRemove = keys\n          .map((key) => ({\n            key,\n            timestamp: JSON.parse(this.options.storage.getItem(key)).timestamp,\n          }))\n          .sort((a, b) => a.timestamp - b.timestamp)\n          .slice(0, keys.length - this.options.maxItems + 1);\n\n        itemsToRemove.forEach((item) => {\n          this.options.storage.removeItem(item.key);\n        });\n      }\n    } catch (error) {\n      console.error(\"Error enforcing cache size limit:\", error);\n    }\n  }\n\n  /**\n   * Gets all cache keys for this instance\n   * @returns {string[]} Array of cache keys\n   */\n  getCacheKeys() {\n    const keys = [];\n    for (let i = 0; i < this.options.storage.length; i++) {\n      const key = this.options.storage.key(i);\n      if (key.startsWith(this.options.prefix)) {\n        keys.push(key);\n      }\n    }\n    return keys;\n  }\n\n  /**\n   * Cleans up expired items\n   */\n  cleanup() {\n    try {\n      const now = Date.now();\n      const keys = this.getCacheKeys();\n\n      keys.forEach((key) => {\n        const item = JSON.parse(this.options.storage.getItem(key));\n        if (now - item.timestamp > this.options.ttl) {\n          this.options.storage.removeItem(key);\n        }\n      });\n    } catch (error) {\n      console.error(\"Error during cache cleanup:\", error);\n    }\n  }\n\n  /**\n   * Clears all cached items for this instance\n   */\n  clear() {\n    const keys = this.getCacheKeys();\n    keys.forEach((key) => {\n      this.options.storage.removeItem(key);\n    });\n  }\n\n  /**\n   * Gets cache statistics\n   * @returns {Object} Cache statistics\n   */\n  getStats() {\n    try {\n      const keys = this.getCacheKeys();\n      const now = Date.now();\n      let totalSize = 0;\n      let expiredCount = 0;\n\n      keys.forEach((key) => {\n        const item = JSON.parse(this.options.storage.getItem(key));\n        totalSize += JSON.stringify(item).length;\n        if (now - item.timestamp > this.options.ttl) {\n          expiredCount++;\n        }\n      });\n\n      return {\n        totalItems: keys.length,\n        expiredItems: expiredCount,\n        totalSize: totalSize,\n        maxItems: this.options.maxItems,\n      };\n    } catch (error) {\n      console.error(\"Error getting cache stats:\", error);\n      return null;\n    }\n  }\n}\n\n// Factory function for creating cache managers\nexport function createCacheManager(options = {}) {\n  return new CacheManager(options);\n}\n","// src/utils/tinymce-adapter.js\n/**\n * Adaptador especializado para la integración con TinyMCE\n * Mejorado para soportar múltiples versiones (v3, v4, v5, v6)\n */\nexport class TinyMCEAdapter {\n  /**\n   * Crea un nuevo adaptador para TinyMCE\n   * @param {string} editorId - ID del elemento contenedor de TinyMCE\n   * @param {Object} options - Opciones adicionales\n   */\n  constructor(editorId, options = {}) {\n    this.editorId = editorId;\n    this.options = {\n      debug: options.debug || false,\n      waitTimeout: options.waitTimeout || 2000,\n      useGlobalReference: options.useGlobalReference !== false, // Por defecto usa referencias globales\n      ...options,\n    };\n\n    this.editorInstance = null;\n    this._initialized = false;\n    this.tmceVersion = null; // Versión de TinyMCE detectada\n\n    // Intentar obtener la instancia de TinyMCE (si ya está inicializada)\n    this._findEditorInstance();\n  }\n\n  /**\n   * Detecta la versión de TinyMCE\n   * @private\n   * @returns {number|null} Versión principal de TinyMCE (3, 4, 5 o 6) o null si no se puede detectar\n   */\n  _detectTinyMCEVersion() {\n    try {\n      if (typeof window.tinymce === \"undefined\") {\n        return null;\n      }\n\n      // Intentar detectar por la versión\n      if (window.tinymce.majorVersion) {\n        return parseInt(window.tinymce.majorVersion, 10);\n      }\n\n      // Alternativa: detectar por características específicas de cada versión\n      if (typeof window.tinymce.createEditor === \"function\") {\n        return 6; // Característica de v6\n      } else if (typeof window.tinymce.dom?.TreeWalker === \"function\") {\n        return 5; // Característica de v5\n      } else if (typeof window.tinymce.dom?.EventUtils === \"function\") {\n        return 4; // Característica de v4\n      } else if (typeof window.tinymce.dom?.Event === \"function\") {\n        return 3; // Característica de v3\n      }\n\n      // Si no podemos detectar específicamente, asumimos v4 como fallback común\n      return 4;\n    } catch (error) {\n      console.error(\"[TinyMCEAdapter] Error detecting TinyMCE version:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Busca la instancia de TinyMCE ya sea por ID o en el objeto global\n   * @private\n   */\n  _findEditorInstance() {\n    try {\n      // Detectar versión de TinyMCE\n      this.tmceVersion = this._detectTinyMCEVersion();\n\n      if (this.options.debug) {\n        console.log(\n          `[TinyMCEAdapter] Detected TinyMCE version: ${\n            this.tmceVersion || \"unknown\"\n          }`\n        );\n      }\n\n      // Verificar si tinymce existe en el contexto global\n      if (typeof window.tinymce !== \"undefined\") {\n        // Obtener la instancia del editor\n        let instance = null;\n\n        // Diferentes métodos según la versión\n        if (this.tmceVersion >= 3) {\n          instance = window.tinymce.get(this.editorId);\n        }\n\n        // Verificar opciones adicionales de búsqueda\n        if (!instance && this.options.useGlobalReference) {\n          // Verificar si hay una instancia global para este ID específico\n          const globalInstanceKey = `tinyMCE_${this.editorId}`;\n          if (window[globalInstanceKey]) {\n            instance = window[globalInstanceKey];\n          }\n\n          // Verificar si hay una instancia marcada específicamente\n          if (window.tinyMCEInstance) {\n            instance = window.tinyMCEInstance;\n          }\n        }\n\n        if (instance) {\n          this.editorInstance = instance;\n          this._initialized = true;\n\n          if (this.options.debug) {\n            console.log(\n              `[TinyMCEAdapter] Found editor instance for \"${this.editorId}\"`,\n              instance\n            );\n          }\n\n          return true;\n        }\n      }\n\n      if (this.options.debug) {\n        console.warn(\n          `[TinyMCEAdapter] TinyMCE instance not found for \"${this.editorId}\"`\n        );\n      }\n\n      return false;\n    } catch (error) {\n      console.error(`[TinyMCEAdapter] Error finding TinyMCE instance:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Espera a que TinyMCE esté inicializado\n   * @returns {Promise<boolean>} Promesa que se resuelve cuando el editor está listo\n   */\n  async waitForEditor() {\n    if (this._initialized && this.editorInstance) {\n      return true;\n    }\n\n    return new Promise((resolve) => {\n      // Intentar encontrar la instancia inmediatamente\n      if (this._findEditorInstance()) {\n        resolve(true);\n        return;\n      }\n\n      // Configurar un intervalo para verificar periódicamente\n      const startTime = Date.now();\n      const checkInterval = setInterval(() => {\n        if (this._findEditorInstance()) {\n          clearInterval(checkInterval);\n          resolve(true);\n          return;\n        }\n\n        // Verificar si hemos excedido el tiempo de espera\n        if (Date.now() - startTime > this.options.waitTimeout) {\n          clearInterval(checkInterval);\n          console.warn(\n            `[TinyMCEAdapter] Timeout waiting for TinyMCE to initialize`\n          );\n          resolve(false);\n        }\n      }, 100);\n    });\n  }\n\n  /**\n   * Verifica si el método existe en la instancia del editor y es una función\n   * @param {string} methodName - Nombre del método a verificar\n   * @returns {boolean} true si el método existe y es una función\n   */\n  _hasMethod(methodName) {\n    return (\n      this.editorInstance &&\n      typeof this.editorInstance[methodName] === \"function\"\n    );\n  }\n\n  /**\n   * Obtiene el contenido del editor\n   * @returns {string} El contenido HTML del editor o cadena vacía si no está disponible\n   */\n  async getContent() {\n    await this.waitForEditor();\n\n    try {\n      if (!this.editorInstance) {\n        throw new Error(\"No editor instance available\");\n      }\n\n      // Estrategia 1: Usar el método getContent directamente (v4+ principalmente)\n      if (this._hasMethod(\"getContent\")) {\n        try {\n          // Algunos editores necesitan especificar el formato\n          const content = this.editorInstance.getContent({ format: \"html\" });\n\n          if (this.options.debug) {\n            console.log(\n              `[TinyMCEAdapter] Retrieved content using getContent() (${\n                content?.length || 0\n              } chars)`\n            );\n          }\n\n          return content || \"\";\n        } catch (err) {\n          console.warn(\"[TinyMCEAdapter] Error using getContent():\", err);\n          // Continuar con otras estrategias\n        }\n      }\n\n      // Estrategia 2: Acceder al contenido mediante el DOM (v3-v4 fallback)\n      if (this.editorInstance.getBody) {\n        try {\n          const body = this.editorInstance.getBody();\n          if (body) {\n            const content = body.innerHTML;\n\n            if (this.options.debug) {\n              console.log(\n                `[TinyMCEAdapter] Retrieved content from body (${\n                  content?.length || 0\n                } chars)`\n              );\n            }\n\n            return content || \"\";\n          }\n        } catch (err) {\n          console.warn(\"[TinyMCEAdapter] Error accessing body content:\", err);\n        }\n      }\n\n      // Estrategia 3: Usar el área de contenido (v3 principalmente)\n      if (this.editorInstance.contentDocument) {\n        try {\n          const doc = this.editorInstance.contentDocument;\n          if (doc && doc.body) {\n            const content = doc.body.innerHTML;\n\n            if (this.options.debug) {\n              console.log(\n                `[TinyMCEAdapter] Retrieved content from contentDocument (${\n                  content?.length || 0\n                } chars)`\n              );\n            }\n\n            return content || \"\";\n          }\n        } catch (err) {\n          console.warn(\n            \"[TinyMCEAdapter] Error accessing contentDocument:\",\n            err\n          );\n        }\n      }\n\n      // Estrategia 4: Intentar con el original textarea\n      const textareaElement = document.getElementById(this.editorId);\n      if (textareaElement && textareaElement.value) {\n        if (this.options.debug) {\n          console.log(\n            `[TinyMCEAdapter] Retrieved content from textarea (${\n              textareaElement.value?.length || 0\n            } chars)`\n          );\n        }\n        return textareaElement.value;\n      }\n\n      // Si llegamos aquí, no pudimos obtener el contenido\n      console.error(\"[TinyMCEAdapter] All content retrieval methods failed\");\n      return \"\";\n    } catch (error) {\n      console.error(`[TinyMCEAdapter] Error getting content:`, error);\n      return \"\";\n    }\n  }\n\n  /**\n   * Establece el contenido del editor\n   * @param {string} content - El contenido HTML a establecer\n   * @returns {boolean} true si se estableció correctamente, false en caso contrario\n   */\n  async setContent(content) {\n    await this.waitForEditor();\n\n    try {\n      if (!this.editorInstance) {\n        throw new Error(\"No editor instance available\");\n      }\n\n      // Estrategia 1: Usar el método setContent directamente (v4+ principalmente)\n      if (this._hasMethod(\"setContent\")) {\n        try {\n          this.editorInstance.setContent(content);\n\n          // Agregar la acción al historial de deshacer si está disponible\n          if (\n            this._hasMethod(\"undoManager\") &&\n            this.editorInstance.undoManager &&\n            this._hasMethod(\"undoManager.add\")\n          ) {\n            this.editorInstance.undoManager.add();\n          }\n\n          if (this.options.debug) {\n            console.log(\n              `[TinyMCEAdapter] Content set successfully using setContent (${\n                content?.length || 0\n              } chars)`\n            );\n          }\n\n          return true;\n        } catch (err) {\n          console.warn(\"[TinyMCEAdapter] Error using setContent():\", err);\n          // Continuar con otras estrategias\n        }\n      }\n\n      // Estrategia 2: Establecer el contenido mediante el DOM (v3-v4 fallback)\n      if (this.editorInstance.getBody) {\n        try {\n          const body = this.editorInstance.getBody();\n          if (body) {\n            body.innerHTML = content;\n\n            if (this.options.debug) {\n              console.log(\n                `[TinyMCEAdapter] Content set successfully using body (${\n                  content?.length || 0\n                } chars)`\n              );\n            }\n\n            return true;\n          }\n        } catch (err) {\n          console.warn(\"[TinyMCEAdapter] Error setting body content:\", err);\n        }\n      }\n\n      // Estrategia 3: Usar el área de contenido (v3 principalmente)\n      if (this.editorInstance.contentDocument) {\n        try {\n          const doc = this.editorInstance.contentDocument;\n          if (doc && doc.body) {\n            doc.body.innerHTML = content;\n\n            if (this.options.debug) {\n              console.log(\n                `[TinyMCEAdapter] Content set successfully using contentDocument (${\n                  content?.length || 0\n                } chars)`\n              );\n            }\n\n            return true;\n          }\n        } catch (err) {\n          console.warn(\"[TinyMCEAdapter] Error setting contentDocument:\", err);\n        }\n      }\n\n      // Estrategia 4: Intentar con el original textarea\n      const textareaElement = document.getElementById(this.editorId);\n      if (textareaElement) {\n        textareaElement.value = content;\n\n        // Tratar de actualizar el editor desde el textarea\n        if (this._hasMethod(\"load\")) {\n          this.editorInstance.load();\n        }\n\n        if (this.options.debug) {\n          console.log(\n            `[TinyMCEAdapter] Content set using textarea (${\n              content?.length || 0\n            } chars)`\n          );\n        }\n\n        return true;\n      }\n\n      // Si llegamos aquí, no pudimos establecer el contenido\n      console.error(\"[TinyMCEAdapter] All content setting methods failed\");\n      return false;\n    } catch (error) {\n      console.error(`[TinyMCEAdapter] Error setting content:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Inserta contenido en la posición actual del cursor\n   * @param {string} content - El contenido HTML a insertar\n   * @returns {boolean} true si se insertó correctamente, false en caso contrario\n   */\n  async insertContent(content) {\n    await this.waitForEditor();\n\n    try {\n      if (!this.editorInstance) {\n        throw new Error(\"No editor instance available\");\n      }\n\n      // Estrategia 1: Usar commandExec con mceInsertContent (v4-v6)\n      if (this._hasMethod(\"execCommand\")) {\n        try {\n          this.editorInstance.execCommand(\"mceInsertContent\", false, content);\n\n          // Tratar de registrar para deshacer si disponible\n          if (\n            this._hasMethod(\"undoManager\") &&\n            this.editorInstance.undoManager &&\n            this._hasMethod(\"undoManager.add\")\n          ) {\n            this.editorInstance.undoManager.add();\n          }\n\n          if (this.options.debug) {\n            console.log(\n              `[TinyMCEAdapter] Content inserted successfully using execCommand`\n            );\n          }\n\n          return true;\n        } catch (err) {\n          console.warn(\"[TinyMCEAdapter] Error using execCommand():\", err);\n          // Continuar con otras estrategias\n        }\n      }\n\n      // Estrategia 2: Insertar directamente en la selección (v3-v4 fallback)\n      if (this._hasMethod(\"selection\") && this.editorInstance.selection) {\n        try {\n          const selection = this.editorInstance.selection;\n\n          if (this._hasMethod(\"selection.setContent\")) {\n            selection.setContent(content);\n\n            if (this.options.debug) {\n              console.log(\n                `[TinyMCEAdapter] Content inserted successfully using selection.setContent`\n              );\n            }\n\n            return true;\n          }\n        } catch (err) {\n          console.warn(\n            \"[TinyMCEAdapter] Error using selection.setContent():\",\n            err\n          );\n        }\n      }\n\n      // Estrategia 3: Fallback a reemplazar todo el contenido\n      return await this.setContent(content);\n    } catch (error) {\n      console.error(`[TinyMCEAdapter] Error inserting content:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Verifica si el editor está inicializado\n   * @returns {boolean} true si el editor está inicializado, false en caso contrario\n   */\n  isInitialized() {\n    return this._initialized && this.editorInstance !== null;\n  }\n\n  /**\n   * Obtiene la versión detectada de TinyMCE\n   * @returns {number|null} Versión principal de TinyMCE (3, 4, 5, 6) o null si no se detectó\n   */\n  getVersion() {\n    return this.tmceVersion;\n  }\n}\n\n/**\n * Función de ayuda para crear un adaptador TinyMCE\n * @param {string} editorId - ID del elemento contenedor de TinyMCE\n * @param {Object} options - Opciones adicionales\n * @returns {TinyMCEAdapter} Una nueva instancia del adaptador\n */\nexport function createTinyMCEAdapter(editorId, options = {}) {\n  return new TinyMCEAdapter(editorId, options);\n}\n","// src/utils/ckeditor-adapter.js\n/**\n * Adaptador especializado para la integración con CKEditor\n * Proporciona métodos para la interacción entre AITextEnhancer y CKEditor\n */\nexport class CKEditorAdapter {\n  /**\n   * Crea un nuevo adaptador para CKEditor\n   * @param {string} editorId - ID del elemento contenedor de CKEditor\n   * @param {Object} options - Opciones adicionales\n   */\n  constructor(editorId, options = {}) {\n    this.editorId = editorId;\n    this.options = {\n      debug: options.debug || false,\n      waitTimeout: options.waitTimeout || 2000,\n      ...options,\n    };\n\n    this.editorInstance = null;\n    this._initialized = false;\n\n    // Intentar obtener la instancia de CKEditor (si ya está inicializada)\n    this._findEditorInstance();\n  }\n\n  /**\n   * Busca la instancia de CKEditor ya sea por ID o en el objeto global\n   * @private\n   */\n  _findEditorInstance() {\n    try {\n      // Verificar si hay una instancia global (enfoque común para demos)\n      if (typeof window.ckeditorInstance !== \"undefined\") {\n        this.editorInstance = window.ckeditorInstance;\n        this._initialized = true;\n\n        if (this.options.debug) {\n          console.log(\n            `[CKEditorAdapter] Found editor instance from global variable`\n          );\n        }\n\n        return true;\n      }\n\n      // Alternativa: Buscar el elemento y verificar si tiene la propiedad ckeditorInstance\n      const editorElement = document.getElementById(this.editorId);\n      if (editorElement && editorElement.ckeditorInstance) {\n        this.editorInstance = editorElement.ckeditorInstance;\n        this._initialized = true;\n\n        if (this.options.debug) {\n          console.log(\n            `[CKEditorAdapter] Found editor instance from element property`\n          );\n        }\n\n        return true;\n      }\n\n      if (this.options.debug) {\n        console.warn(\n          `[CKEditorAdapter] CKEditor instance not found for \"${this.editorId}\"`\n        );\n      }\n\n      return false;\n    } catch (error) {\n      console.error(\n        `[CKEditorAdapter] Error finding CKEditor instance:`,\n        error\n      );\n      return false;\n    }\n  }\n\n  /**\n   * Espera a que CKEditor esté inicializado\n   * @returns {Promise<boolean>} Promesa que se resuelve cuando el editor está listo\n   */\n  async waitForEditor() {\n    if (this._initialized && this.editorInstance) {\n      return true;\n    }\n\n    return new Promise((resolve) => {\n      // Intentar encontrar la instancia inmediatamente\n      if (this._findEditorInstance()) {\n        resolve(true);\n        return;\n      }\n\n      // Configurar un intervalo para verificar periódicamente\n      const startTime = Date.now();\n      const checkInterval = setInterval(() => {\n        if (this._findEditorInstance()) {\n          clearInterval(checkInterval);\n          resolve(true);\n          return;\n        }\n\n        // Verificar si hemos excedido el tiempo de espera\n        if (Date.now() - startTime > this.options.waitTimeout) {\n          clearInterval(checkInterval);\n          console.warn(\n            `[CKEditorAdapter] Timeout waiting for CKEditor to initialize`\n          );\n          resolve(false);\n        }\n      }, 100);\n    });\n  }\n\n  /**\n   * Obtiene el contenido del editor\n   * @returns {string} El contenido HTML del editor o cadena vacía si no está disponible\n   */\n  async getContent() {\n    await this.waitForEditor();\n\n    try {\n      if (this.editorInstance) {\n        const content = this.editorInstance.getData();\n\n        if (this.options.debug) {\n          console.log(\n            `[CKEditorAdapter] Retrieved content (${content.length} chars)`\n          );\n        }\n\n        return content;\n      }\n    } catch (error) {\n      console.error(`[CKEditorAdapter] Error getting content:`, error);\n    }\n\n    return \"\";\n  }\n\n  /**\n   * Establece el contenido del editor\n   * @param {string} content - El contenido HTML a establecer\n   * @returns {boolean} true si se estableció correctamente, false en caso contrario\n   */\n  async setContent(content) {\n    await this.waitForEditor();\n\n    try {\n      if (this.editorInstance) {\n        this.editorInstance.setData(content);\n\n        if (this.options.debug) {\n          console.log(\n            `[CKEditorAdapter] Content set successfully (${content.length} chars)`\n          );\n        }\n\n        return true;\n      }\n    } catch (error) {\n      console.error(`[CKEditorAdapter] Error setting content:`, error);\n    }\n\n    return false;\n  }\n\n  /**\n   * Inserta contenido en la posición actual del cursor\n   * @param {string} content - El contenido HTML a insertar\n   * @returns {boolean} true si se insertó correctamente, false en caso contrario\n   */\n  async insertContent(content) {\n    await this.waitForEditor();\n\n    try {\n      if (this.editorInstance) {\n        const viewFragment = this.editorInstance.data.processor.toView(content);\n        const modelFragment = this.editorInstance.data.toModel(viewFragment);\n        this.editorInstance.model.insertContent(modelFragment);\n\n        if (this.options.debug) {\n          console.log(`[CKEditorAdapter] Content inserted successfully`);\n        }\n\n        return true;\n      }\n    } catch (error) {\n      console.error(`[CKEditorAdapter] Error inserting content:`, error);\n    }\n\n    return false;\n  }\n\n  /**\n   * Verifica si el editor está inicializado\n   * @returns {boolean} true si el editor está inicializado, false en caso contrario\n   */\n  isInitialized() {\n    return this._initialized && this.editorInstance !== null;\n  }\n}\n\n/**\n * Función de ayuda para crear un adaptador CKEditor\n * @param {string} editorId - ID del elemento contenedor de CKEditor\n * @param {Object} options - Opciones adicionales\n * @returns {CKEditorAdapter} Una nueva instancia del adaptador\n */\nexport function createCKEditorAdapter(editorId, options = {}) {\n  return new CKEditorAdapter(editorId, options);\n}\n","// src/utils/quill-adapter.js\n/**\n * Adaptador especializado para la integración con Quill Editor\n * Proporciona métodos para la interacción entre AITextEnhancer y Quill\n */\nexport class QuillAdapter {\n  /**\n   * Crea un nuevo adaptador para Quill\n   * @param {string} editorId - ID del elemento contenedor de Quill\n   * @param {Object} options - Opciones adicionales\n   */\n  constructor(editorId, options = {}) {\n    this.editorId = editorId;\n    this.options = {\n      debug: options.debug || false,\n      waitTimeout: options.waitTimeout || 2000,\n      ...options,\n    };\n\n    this.editorInstance = null;\n    this._initialized = false;\n\n    // Intentar obtener la instancia de Quill (si ya está inicializada)\n    this._findEditorInstance();\n  }\n\n  /**\n   * Busca la instancia de Quill ya sea por ID o en el objeto global\n   * @private\n   */\n  _findEditorInstance() {\n    try {\n      // Verificar si hay una instancia global (enfoque común para demos)\n      if (typeof window.quillInstance !== \"undefined\") {\n        this.editorInstance = window.quillInstance;\n        this._initialized = true;\n\n        if (this.options.debug) {\n          console.log(\n            `[QuillAdapter] Found editor instance from global variable`\n          );\n        }\n\n        return true;\n      }\n\n      // Alternativa: Buscar por el selector de Quill y su propiedad __quill\n      const editorElement = document.getElementById(this.editorId);\n      if (editorElement) {\n        // Intentar encontrar el editor por su ID y la propiedad __quill\n        const quillContainer = editorElement;\n        if (quillContainer && quillContainer.__quill) {\n          this.editorInstance = quillContainer.__quill;\n          this._initialized = true;\n\n          if (this.options.debug) {\n            console.log(\n              `[QuillAdapter] Found editor instance from element __quill property`\n            );\n          }\n\n          return true;\n        }\n\n        // Segundo intento: buscar el primer elemento con la clase ql-editor\n        const editor = quillContainer.querySelector(\".ql-editor\");\n        if (editor && editor.__quill) {\n          this.editorInstance = editor.__quill;\n          this._initialized = true;\n\n          if (this.options.debug) {\n            console.log(\n              `[QuillAdapter] Found editor instance from ql-editor element`\n            );\n          }\n\n          return true;\n        }\n      }\n\n      if (this.options.debug) {\n        console.warn(\n          `[QuillAdapter] Quill instance not found for \"${this.editorId}\"`\n        );\n      }\n\n      return false;\n    } catch (error) {\n      console.error(`[QuillAdapter] Error finding Quill instance:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Espera a que Quill esté inicializado\n   * @returns {Promise<boolean>} Promesa que se resuelve cuando el editor está listo\n   */\n  async waitForEditor() {\n    if (this._initialized && this.editorInstance) {\n      return true;\n    }\n\n    return new Promise((resolve) => {\n      // Intentar encontrar la instancia inmediatamente\n      if (this._findEditorInstance()) {\n        resolve(true);\n        return;\n      }\n\n      // Configurar un intervalo para verificar periódicamente\n      const startTime = Date.now();\n      const checkInterval = setInterval(() => {\n        if (this._findEditorInstance()) {\n          clearInterval(checkInterval);\n          resolve(true);\n          return;\n        }\n\n        // Verificar si hemos excedido el tiempo de espera\n        if (Date.now() - startTime > this.options.waitTimeout) {\n          clearInterval(checkInterval);\n          console.warn(\n            `[QuillAdapter] Timeout waiting for Quill to initialize`\n          );\n          resolve(false);\n        }\n      }, 100);\n    });\n  }\n\n  /**\n   * Obtiene el contenido del editor\n   * @returns {string} El contenido HTML del editor o cadena vacía si no está disponible\n   */\n  async getContent() {\n    await this.waitForEditor();\n\n    try {\n      if (this.editorInstance) {\n        // Quill tiene dos formas de obtener contenido:\n        // 1. getContents() - Devuelve un objeto Delta con formato interno de Quill\n        // 2. root.innerHTML - Devuelve el HTML del contenido\n\n        // Para compatibilidad con otros editores, devolvemos el HTML\n        const content = this.editorInstance.root.innerHTML;\n\n        if (this.options.debug) {\n          console.log(\n            `[QuillAdapter] Retrieved content (${content.length} chars)`\n          );\n        }\n\n        return content;\n      }\n    } catch (error) {\n      console.error(`[QuillAdapter] Error getting content:`, error);\n    }\n\n    return \"\";\n  }\n\n  /**\n   * Establece el contenido del editor\n   * @param {string} content - El contenido HTML a establecer\n   * @returns {boolean} true si se estableció correctamente, false en caso contrario\n   */\n  async setContent(content) {\n    await this.waitForEditor();\n\n    try {\n      if (this.editorInstance) {\n        // Quill puede configurar contenido como HTML\n        this.editorInstance.clipboard.dangerouslyPasteHTML(content);\n\n        if (this.options.debug) {\n          console.log(\n            `[QuillAdapter] Content set successfully (${content.length} chars)`\n          );\n        }\n\n        return true;\n      }\n    } catch (error) {\n      console.error(`[QuillAdapter] Error setting content:`, error);\n    }\n\n    return false;\n  }\n\n  /**\n   * Inserta contenido en la posición actual del cursor\n   * @param {string} content - El contenido HTML a insertar\n   * @returns {boolean} true si se insertó correctamente, false en caso contrario\n   */\n  async insertContent(content) {\n    await this.waitForEditor();\n\n    try {\n      if (this.editorInstance) {\n        const range = this.editorInstance.getSelection();\n        if (range) {\n          // Si hay una selección, inserta en esa posición\n          this.editorInstance.clipboard.dangerouslyPasteHTML(\n            range.index,\n            content,\n            \"user\"\n          );\n        } else {\n          // Si no hay selección, inserta al final\n          const length = this.editorInstance.getLength();\n          this.editorInstance.clipboard.dangerouslyPasteHTML(\n            length,\n            content,\n            \"user\"\n          );\n        }\n\n        if (this.options.debug) {\n          console.log(`[QuillAdapter] Content inserted successfully`);\n        }\n\n        return true;\n      }\n    } catch (error) {\n      console.error(`[QuillAdapter] Error inserting content:`, error);\n    }\n\n    return false;\n  }\n\n  /**\n   * Verifica si el editor está inicializado\n   * @returns {boolean} true si el editor está inicializado, false en caso contrario\n   */\n  isInitialized() {\n    return this._initialized && this.editorInstance !== null;\n  }\n}\n\n/**\n * Función de ayuda para crear un adaptador Quill\n * @param {string} editorId - ID del elemento contenedor de Quill\n * @param {Object} options - Opciones adicionales\n * @returns {QuillAdapter} Una nueva instancia del adaptador\n */\nexport function createQuillAdapter(editorId, options = {}) {\n  return new QuillAdapter(editorId, options);\n}\n","// src/utils/froala-adapter.js\n/**\n * Adaptador especializado para la integración con Froala Editor\n * Proporciona métodos para la interacción entre AITextEnhancer y Froala\n */\nexport class FroalaAdapter {\n  /**\n   * Crea un nuevo adaptador para Froala\n   * @param {string} editorId - ID del elemento contenedor de Froala\n   * @param {Object} options - Opciones adicionales\n   */\n  constructor(editorId, options = {}) {\n    this.editorId = editorId;\n    this.options = {\n      debug: options.debug || false,\n      waitTimeout: options.waitTimeout || 2000,\n      ...options,\n    };\n\n    this.editorInstance = null;\n    this._initialized = false;\n\n    // Intentar obtener la instancia de Froala (si ya está inicializada)\n    this._findEditorInstance();\n  }\n\n  /**\n   * Busca la instancia de Froala ya sea por ID o en el objeto global\n   * @private\n   */\n  _findEditorInstance() {\n    try {\n      // Verificar si hay una instancia global (enfoque común para demos)\n      if (typeof window.froalaInstance !== \"undefined\") {\n        this.editorInstance = window.froalaInstance;\n        this._initialized = true;\n\n        if (this.options.debug) {\n          console.log(\n            `[FroalaAdapter] Found editor instance from global variable`\n          );\n        }\n\n        return true;\n      }\n\n      // Verificar si el elemento tiene la instancia de Froala\n      const editorElement = document.getElementById(this.editorId);\n      if (editorElement && editorElement.froalaEditor) {\n        this.editorInstance = editorElement.froalaEditor;\n        this._initialized = true;\n\n        if (this.options.debug) {\n          console.log(\n            `[FroalaAdapter] Found editor instance from element property`\n          );\n        }\n\n        return true;\n      }\n\n      // Buscar el contenedor de Froala con la clase fr-box\n      const froalaContainer = document.querySelector(\n        `.fr-box[id^=\"${this.editorId}\"]`\n      );\n      if (froalaContainer) {\n        // Encontrar la instancia de editor dentro del contenedor\n        const editorElement = froalaContainer.querySelector(\n          \"[contenteditable=true]\"\n        );\n        if (\n          editorElement &&\n          editorElement.parentNode.querySelector(\".fr-element\")\n        ) {\n          const instanceKey = Object.keys(window).find(\n            (key) =>\n              key.startsWith(\"FE_\") &&\n              window[key] &&\n              typeof window[key] === \"object\" &&\n              window[key].$\n          );\n\n          if (instanceKey) {\n            this.editorInstance = window[instanceKey];\n            this._initialized = true;\n\n            if (this.options.debug) {\n              console.log(\n                `[FroalaAdapter] Found editor instance from global FE key`\n              );\n            }\n\n            return true;\n          }\n        }\n      }\n\n      if (this.options.debug) {\n        console.warn(\n          `[FroalaAdapter] Froala instance not found for \"${this.editorId}\"`\n        );\n      }\n\n      return false;\n    } catch (error) {\n      console.error(`[FroalaAdapter] Error finding Froala instance:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Espera a que Froala esté inicializado\n   * @returns {Promise<boolean>} Promesa que se resuelve cuando el editor está listo\n   */\n  async waitForEditor() {\n    if (this._initialized && this.editorInstance) {\n      return true;\n    }\n\n    return new Promise((resolve) => {\n      // Intentar encontrar la instancia inmediatamente\n      if (this._findEditorInstance()) {\n        resolve(true);\n        return;\n      }\n\n      // Configurar un intervalo para verificar periódicamente\n      const startTime = Date.now();\n      const checkInterval = setInterval(() => {\n        if (this._findEditorInstance()) {\n          clearInterval(checkInterval);\n          resolve(true);\n          return;\n        }\n\n        // Verificar si hemos excedido el tiempo de espera\n        if (Date.now() - startTime > this.options.waitTimeout) {\n          clearInterval(checkInterval);\n          console.warn(\n            `[FroalaAdapter] Timeout waiting for Froala to initialize`\n          );\n          resolve(false);\n        }\n      }, 100);\n    });\n  }\n\n  /**\n   * Obtiene el contenido del editor\n   * @returns {string} El contenido HTML del editor o cadena vacía si no está disponible\n   */\n  async getContent() {\n    await this.waitForEditor();\n\n    try {\n      if (this.editorInstance) {\n        // En Froala, el método .html() se usa para obtener el contenido\n        const content = this.editorInstance.html.get();\n\n        if (this.options.debug) {\n          console.log(\n            `[FroalaAdapter] Retrieved content (${content?.length || 0} chars)`\n          );\n        }\n\n        return content || \"\";\n      }\n    } catch (error) {\n      console.error(`[FroalaAdapter] Error getting content:`, error);\n    }\n\n    // Fallback: intentar obtener el HTML directamente del elemento editable\n    try {\n      const element = document.querySelector(\n        `#${this.editorId} div.fr-element`\n      );\n      if (element) {\n        return element.innerHTML || \"\";\n      }\n    } catch (e) {\n      console.error(`[FroalaAdapter] Error in fallback content retrieval:`, e);\n    }\n\n    return \"\";\n  }\n\n  /**\n   * Establece el contenido del editor\n   * @param {string} content - El contenido HTML a establecer\n   * @returns {boolean} true si se estableció correctamente, false en caso contrario\n   */\n  async setContent(content) {\n    await this.waitForEditor();\n\n    try {\n      if (this.editorInstance) {\n        // En Froala, el método .html.set() se usa para establecer el contenido\n        this.editorInstance.html.set(content);\n\n        // Asegurarse de que el editor esté enfocado y triggerea un evento change\n        this.editorInstance.events.trigger(\"contentChanged\");\n\n        if (this.options.debug) {\n          console.log(\n            `[FroalaAdapter] Content set successfully (${content.length} chars)`\n          );\n        }\n\n        return true;\n      }\n    } catch (error) {\n      console.error(`[FroalaAdapter] Error setting content:`, error);\n    }\n\n    // Fallback: intentar establecer el HTML directamente en el elemento editable\n    try {\n      const element = document.querySelector(\n        `#${this.editorId} div.fr-element`\n      );\n      if (element) {\n        element.innerHTML = content;\n        return true;\n      }\n    } catch (e) {\n      console.error(`[FroalaAdapter] Error in fallback content setting:`, e);\n    }\n\n    return false;\n  }\n\n  /**\n   * Inserta contenido en la posición actual del cursor\n   * @param {string} content - El contenido HTML a insertar\n   * @returns {boolean} true si se insertó correctamente, false en caso contrario\n   */\n  async insertContent(content) {\n    await this.waitForEditor();\n\n    try {\n      if (this.editorInstance) {\n        // En Froala, insertHTML inserta contenido en la posición del cursor\n        this.editorInstance.html.insert(content, true);\n\n        // Trigger para actualizar UI y historial\n        this.editorInstance.events.trigger(\"contentChanged\");\n\n        if (this.options.debug) {\n          console.log(`[FroalaAdapter] Content inserted successfully`);\n        }\n\n        return true;\n      }\n    } catch (error) {\n      console.error(`[FroalaAdapter] Error inserting content:`, error);\n    }\n\n    return false;\n  }\n\n  /**\n   * Verifica si el editor está inicializado\n   * @returns {boolean} true si el editor está inicializado, false en caso contrario\n   */\n  isInitialized() {\n    return this._initialized && this.editorInstance !== null;\n  }\n}\n\n/**\n * Función de ayuda para crear un adaptador Froala\n * @param {string} editorId - ID del elemento contenedor de Froala\n * @param {Object} options - Opciones adicionales\n * @returns {FroalaAdapter} Una nueva instancia del adaptador\n */\nexport function createFroalaAdapter(editorId, options = {}) {\n  return new FroalaAdapter(editorId, options);\n}\n","// editor-adapter.js - Actualizado con soporte para Froala\n\n// Importar los adaptadores específicos\nimport { createTinyMCEAdapter } from \"../utils/tinymce-adapter.js\";\nimport { createCKEditorAdapter } from \"../utils/ckeditor-adapter.js\";\nimport { createQuillAdapter } from \"../utils/quill-adapter.js\";\nimport { createFroalaAdapter } from \"../utils/froala-adapter.js\";\n\n/**\n * Clase adaptadora para diferentes tipos de editores\n * @class EditorAdapter\n */\nexport class EditorAdapter {\n  /**\n   * Constructor del adaptador de editor\n   * @param {string} editorId - ID del elemento editor\n   * @param {string} editorType - Tipo de editor ('textarea', 'tinymce', 'ckeditor', 'froala', etc.)\n   * @param {Object} options - Opciones adicionales\n   */\n  constructor(editorId, editorType = \"textarea\", options = {}) {\n    this.editorId = editorId;\n    this.editorType = editorType.toLowerCase();\n    this.options = {\n      debug: options.debug || false,\n      ...options,\n    };\n\n    // Inicializar contenedor para adaptadores específicos\n    this.specificAdapters = {};\n\n    // Inicializar el adaptador específico según el tipo\n    this._initializeSpecificAdapter();\n  }\n\n  /**\n   * Inicializa el adaptador específico según el tipo de editor\n   * @private\n   */\n  _initializeSpecificAdapter() {\n    switch (this.editorType) {\n      case \"tinymce\":\n        try {\n          this.specificAdapters.tinymce = createTinyMCEAdapter(this.editorId, {\n            debug: this.options.debug,\n          });\n\n          if (this.options.debug) {\n            console.log(\"[EditorAdapter] TinyMCE adapter initialized\");\n          }\n        } catch (error) {\n          console.error(\n            \"[EditorAdapter] Failed to initialize TinyMCE adapter:\",\n            error\n          );\n        }\n        break;\n\n      case \"ckeditor\":\n        try {\n          this.specificAdapters.ckeditor = createCKEditorAdapter(this.editorId, {\n            debug: this.options.debug,\n          });\n\n          if (this.options.debug) {\n            console.log(\"[EditorAdapter] CKEditor adapter initialized\");\n          }\n        } catch (error) {\n          console.error(\n            \"[EditorAdapter] Failed to initialize CKEditor adapter:\",\n            error\n          );\n        }\n        break;\n\n      case \"quill\":\n        try {\n          this.specificAdapters.quill = createQuillAdapter(this.editorId, {\n            debug: this.options.debug,\n          });\n\n          if (this.options.debug) {\n            console.log(\"[EditorAdapter] Quill adapter initialized\");\n          }\n        } catch (error) {\n          console.error(\n            \"[EditorAdapter] Failed to initialize Quill adapter:\",\n            error\n          );\n        }\n        break;\n\n      case \"froala\":\n        try {\n          this.specificAdapters.froala = createFroalaAdapter(this.editorId, {\n            debug: this.options.debug,\n          });\n\n          if (this.options.debug) {\n            console.log(\"[EditorAdapter] Froala adapter initialized\");\n          }\n        } catch (error) {\n          console.error(\n            \"[EditorAdapter] Failed to initialize Froala adapter:\",\n            error\n          );\n        }\n        break;\n\n      // Aquí se pueden agregar más adaptadores específicos para otros editores\n\n      default:\n        if (this.options.debug) {\n          console.log(\n            `[EditorAdapter] Using default textarea adapter for type: ${this.editorType}`\n          );\n        }\n        break;\n    }\n  }\n\n  /**\n   * Obtiene el contenido del editor\n   * @returns {string} Contenido del editor\n   */\n  getContent() {\n    try {\n      switch (this.editorType) {\n        case \"tinymce\":\n          // TinyMCE - usar adaptador específico si está disponible\n          if (this.specificAdapters.tinymce) {\n            return this.specificAdapters.tinymce.getContent() || \"\";\n          }\n\n          // Fallback: intentar obtener contenido directamente\n          if (typeof tinymce !== \"undefined\") {\n            const editor = tinymce.get(this.editorId);\n            if (editor) {\n              return editor.getContent() || \"\";\n            }\n          }\n\n          console.warn(\"[EditorAdapter] TinyMCE not initialized properly\");\n          return \"\";\n\n        case \"ckeditor\":\n          // CKEditor - usar adaptador específico si está disponible\n          if (this.specificAdapters.ckeditor) {\n            return this.specificAdapters.ckeditor.getContent() || \"\";\n          }\n\n          // Fallback: intentar obtener contenido directamente\n          if (typeof CKEDITOR !== \"undefined\") {\n            const editor = CKEDITOR.instances[this.editorId];\n            if (editor) {\n              return editor.getData() || \"\";\n            }\n          }\n\n          console.warn(\"[EditorAdapter] CKEditor not initialized properly\");\n          return \"\";\n\n        case \"quill\":\n          // Quill - usar adaptador específico si está disponible\n          if (this.specificAdapters.quill) {\n            return this.specificAdapters.quill.getContent() || \"\";\n          }\n\n          // Fallback: intentar obtener contenido directamente\n          const quillElement = document.querySelector(`#${this.editorId}`);\n          if (quillElement && quillElement.__quill) {\n            return quillElement.__quill.root.innerHTML || \"\";\n          }\n\n          console.warn(\"[EditorAdapter] Quill not initialized properly\");\n          return \"\";\n\n        case \"froala\":\n          // Froala - usar adaptador específico si está disponible\n          if (this.specificAdapters.froala) {\n            return this.specificAdapters.froala.getContent() || \"\";\n          }\n\n          // Fallback: intentar obtener contenido directamente\n          if (typeof window.froalaInstance !== \"undefined\") {\n            return window.froalaInstance.html.get() || \"\";\n          }\n\n          // Otro intento: buscar el elemento editable de Froala\n          const froalaElement = document.querySelector(\n            `#${this.editorId} div.fr-element`\n          );\n          if (froalaElement) {\n            return froalaElement.innerHTML || \"\";\n          }\n\n          console.warn(\"[EditorAdapter] Froala not initialized properly\");\n          return \"\";\n\n        case \"textarea\":\n        default:\n          // Textarea o elemento HTML genérico\n          const element = document.getElementById(this.editorId);\n          if (element) {\n            if (element.tagName.toLowerCase() === \"textarea\") {\n              return element.value || \"\";\n            } else {\n              return element.innerHTML || \"\";\n            }\n          }\n\n          console.warn(\"[EditorAdapter] Element not found:\", this.editorId);\n          return \"\";\n      }\n    } catch (error) {\n      console.error(\"[EditorAdapter] Error getting content:\", error);\n      return \"\";\n    }\n  }\n\n  /**\n   * Establece el contenido del editor\n   * @param {string} content - Contenido a establecer\n   * @returns {boolean} true si se estableció correctamente, false en caso contrario\n   */\n  setContent(content) {\n    try {\n      switch (this.editorType) {\n        case \"tinymce\":\n          // TinyMCE - usar adaptador específico si está disponible\n          if (this.specificAdapters.tinymce) {\n            return this.specificAdapters.tinymce.setContent(content);\n          }\n\n          // Fallback: intentar establecer contenido directamente\n          if (typeof tinymce !== \"undefined\") {\n            const editor = tinymce.get(this.editorId);\n            if (editor) {\n              editor.setContent(content);\n              return true;\n            }\n          }\n\n          console.warn(\"[EditorAdapter] TinyMCE not initialized properly\");\n          return false;\n\n        case \"ckeditor\":\n          // CKEditor - usar adaptador específico si está disponible\n          if (this.specificAdapters.ckeditor) {\n            return this.specificAdapters.ckeditor.setContent(content);\n          }\n\n          // Fallback: intentar establecer contenido directamente\n          if (typeof CKEDITOR !== \"undefined\") {\n            const editor = CKEDITOR.instances[this.editorId];\n            if (editor) {\n              editor.setData(content);\n              return true;\n            }\n          }\n\n          console.warn(\"[EditorAdapter] CKEditor not initialized properly\");\n          return false;\n\n        case \"quill\":\n          // Quill - usar adaptador específico si está disponible\n          if (this.specificAdapters.quill) {\n            return this.specificAdapters.quill.setContent(content);\n          }\n\n          // Fallback: intentar establecer contenido directamente\n          const quillElement = document.querySelector(`#${this.editorId}`);\n          if (quillElement && quillElement.__quill) {\n            quillElement.__quill.root.innerHTML = content;\n            return true;\n          }\n\n          console.warn(\"[EditorAdapter] Quill not initialized properly\");\n          return false;\n\n        case \"froala\":\n          // Froala - usar adaptador específico si está disponible\n          if (this.specificAdapters.froala) {\n            return this.specificAdapters.froala.setContent(content);\n          }\n\n          // Fallback: intentar establecer contenido directamente\n          if (typeof window.froalaInstance !== \"undefined\") {\n            window.froalaInstance.html.set(content);\n            window.froalaInstance.events.trigger(\"contentChanged\");\n            return true;\n          }\n\n          // Otro intento: buscar el elemento editable de Froala\n          const froalaElement = document.querySelector(\n            `#${this.editorId} div.fr-element`\n          );\n          if (froalaElement) {\n            froalaElement.innerHTML = content;\n            return true;\n          }\n\n          console.warn(\"[EditorAdapter] Froala not initialized properly\");\n          return false;\n\n        case \"textarea\":\n        default:\n          // Textarea o elemento HTML genérico\n          const element = document.getElementById(this.editorId);\n          if (element) {\n            if (element.tagName.toLowerCase() === \"textarea\") {\n              element.value = content;\n            } else {\n              element.innerHTML = content;\n            }\n            return true;\n          }\n\n          console.warn(\"[EditorAdapter] Element not found:\", this.editorId);\n          return false;\n      }\n    } catch (error) {\n      console.error(\"[EditorAdapter] Error setting content:\", error);\n      return false;\n    }\n  }\n}","// Actualización de la clase NotificationManager en src/services/notification-manager.js\n\nexport class NotificationManager {\n  constructor(container) {\n    if (!container) {\n      console.error(\"[NotificationManager] No se proporcionó un contenedor\");\n      this.container = null;\n      return;\n    }\n\n    // Si el contenedor es un componente o elemento HTML con shadowRoot\n    if (container.shadowRoot) {\n      // Buscar el contenedor de notificaciones en el shadowRoot\n      this.container = container.shadowRoot.querySelector(\n        \".notifications-container\"\n      );\n\n      // Si no existe, crearlo\n      if (!this.container) {\n        this.container = document.createElement(\"div\");\n        this.container.className = \"notifications-container\";\n        container.shadowRoot.appendChild(this.container);\n      }\n    } else {\n      // Si es un elemento DOM normal\n      this.container = container;\n    }\n\n    this.notifications = new Set();\n    console.log(\n      \"[NotificationManager] Inicializado con contenedor:\",\n      this.container\n    );\n  }\n\n  show(message, type = \"info\", duration = 5000) {\n    if (!this.container) {\n      console.error(\n        \"[NotificationManager] No hay contenedor de notificaciones disponible\"\n      );\n      // Fallback: mostrar en la consola\n      console.log(`[${type.toUpperCase()}] ${message}`);\n      return null;\n    }\n\n    try {\n      const notification = document.createElement(\"div\");\n      notification.className = `ai-notification ${type}`;\n      notification.setAttribute(\"role\", \"alert\");\n\n      // Usar un símbolo apropiado según el tipo\n      const icon = this.getIconForType(type);\n\n      notification.innerHTML = `\n        ${icon}\n        <div class=\"notification-content\">${message}</div>\n        <button class=\"notification-close\" aria-label=\"Close notification\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\">\n            <path d=\"M4 4l8 8m0-8l-8 8\" stroke=\"currentColor\" stroke-width=\"2\"/>\n          </svg>\n        </button>\n      `;\n\n      // Función para cerrar la notificación\n      const close = () => {\n        notification.style.animation = \"slideOut 0.3s ease-out\";\n        setTimeout(() => {\n          if (notification.parentNode) {\n            notification.remove();\n          }\n          this.notifications.delete(notification);\n        }, 300);\n      };\n\n      // Agregar manejador de eventos al botón de cierre\n      const closeButton = notification.querySelector(\".notification-close\");\n      if (closeButton) {\n        closeButton.onclick = close;\n      }\n\n      // Cierre automático si la duración es mayor que 0\n      if (duration > 0) {\n        setTimeout(close, duration);\n      }\n\n      // Agregar la notificación al contenedor\n      this.container.appendChild(notification);\n      this.notifications.add(notification);\n\n      console.log(`[NotificationManager] Notificación mostrada: ${type}`);\n\n      // Auto-eliminar notificaciones antiguas si hay demasiadas\n      this.cleanupOldNotifications();\n\n      return notification;\n    } catch (error) {\n      console.error(\n        \"[NotificationManager] Error al mostrar notificación:\",\n        error\n      );\n      return null;\n    }\n  }\n\n  // Métodos de conveniencia para diferentes tipos de notificaciones\n  error(message, duration = 7000) {\n    return this.show(message, \"error\", duration);\n  }\n\n  warning(message, duration = 5000) {\n    return this.show(message, \"warning\", duration);\n  }\n\n  info(message, duration = 4000) {\n    return this.show(message, \"info\", duration);\n  }\n\n  success(message, duration = 3000) {\n    return this.show(message, \"success\", duration);\n  }\n\n  // Limitar el número de notificaciones simultáneas\n  cleanupOldNotifications(maxNotifications = 3) {\n    const notificationsArray = Array.from(this.notifications);\n\n    if (notificationsArray.length > maxNotifications) {\n      // Eliminar las notificaciones más antiguas\n      const oldNotifications = notificationsArray.slice(\n        0,\n        notificationsArray.length - maxNotifications\n      );\n\n      oldNotifications.forEach((notification) => {\n        if (notification.parentNode) {\n          notification.remove();\n        }\n        this.notifications.delete(notification);\n      });\n    }\n  }\n\n  // Obtener un ícono SVG según el tipo de notificación\n  getIconForType(type) {\n    switch (type) {\n      case \"error\":\n        return `\n          <svg class=\"notification-icon\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <circle cx=\"12\" cy=\"12\" r=\"10\"/>\n            <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"12\"/>\n            <line x1=\"12\" y1=\"16\" x2=\"12.01\" y2=\"16\"/>\n          </svg>\n        `;\n      case \"warning\":\n        return `\n          <svg class=\"notification-icon\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <path d=\"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z\"/>\n            <line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"/>\n            <line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/>\n          </svg>\n        `;\n      case \"success\":\n        return `\n          <svg class=\"notification-icon\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <path d=\"M22 11.08V12a10 10 0 1 1-5.93-9.14\"/>\n            <polyline points=\"22 4 12 14.01 9 11.01\"/>\n          </svg>\n        `;\n      case \"info\":\n      default:\n        return `\n          <svg class=\"notification-icon\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <circle cx=\"12\" cy=\"12\" r=\"10\"/>\n            <line x1=\"12\" y1=\"16\" x2=\"12\" y2=\"12\"/>\n            <line x1=\"12\" y1=\"8\" x2=\"12.01\" y2=\"8\"/>\n          </svg>\n        `;\n    }\n  }\n\n  // Limpiar todas las notificaciones\n  clearAll() {\n    this.notifications.forEach((notification) => {\n      if (notification.parentNode) {\n        notification.remove();\n      }\n    });\n    this.notifications.clear();\n  }\n}\n\n// Función de fábrica para crear gestores de notificaciones\nexport function createNotificationManager(container) {\n  return new NotificationManager(container);\n}\n","export function setupKeyboardNavigation(component) {\n  document.addEventListener('keydown', component.handleKeyboard.bind(component));\n  \n  const modal = component.shadowRoot.querySelector('.modal');\n  if (modal) {\n    modal.addEventListener('keydown', component.handleModalKeyboard.bind(component));\n  }\n}\n\nexport const keyboardNavigationMixin = {\n  handleKeyboard(event) {\n    if (event.ctrlKey || event.metaKey) {\n      switch(event.key.toLowerCase()) {\n        case 'e':\n          event.preventDefault();\n          this.shadowRoot.querySelector('.modal-trigger').click();\n          break;\n        case 'i':\n          event.preventDefault();\n          if (this.isModalOpen()) {\n            this.handleToolAction('improve');\n          }\n          break;\n        case 's':\n          event.preventDefault();\n          if (this.isModalOpen()) {\n            this.handleToolAction('summarize');\n          }\n          break;\n      }\n    }\n  },\n\n  handleModalKeyboard(event) {\n    if (!this.isModalOpen()) return;\n\n    switch (event.key) {\n      case 'Escape':\n        this.shadowRoot.querySelector('.close-button').click();\n        break;\n      case 'Tab':\n        this.handleTabNavigation(event);\n        break;\n      case 'ArrowRight':\n      case 'ArrowLeft':\n        if (event.target.closest('.tools-container')) {\n          this.handleToolNavigation(event);\n        }\n        break;\n    }\n  },\n\n  handleTabNavigation(event) {\n    const modal = this.shadowRoot.querySelector('.modal');\n    const focusableElements = modal.querySelectorAll(\n      'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n    );\n    const firstFocusable = focusableElements[0];\n    const lastFocusable = focusableElements[focusableElements.length - 1];\n\n    if (event.shiftKey) {\n      if (document.activeElement === firstFocusable) {\n        event.preventDefault();\n        lastFocusable.focus();\n      }\n    } else {\n      if (document.activeElement === lastFocusable) {\n        event.preventDefault();\n        firstFocusable.focus();\n      }\n    }\n  },\n\n  handleToolNavigation(event) {\n    const toolbar = this.shadowRoot.querySelector('ai-toolbar');\n    const tools = toolbar.shadowRoot.querySelectorAll('.tool-button');\n    const currentTool = toolbar.shadowRoot.querySelector('.tool-button:focus');\n\n    if (!currentTool) return;\n\n    const currentIndex = Array.from(tools).indexOf(currentTool);\n    let nextIndex;\n\n    if (event.key === 'ArrowRight') {\n      nextIndex = (currentIndex + 1) % tools.length;\n    } else {\n      nextIndex = (currentIndex - 1 + tools.length) % tools.length;\n    }\n\n    tools[nextIndex].focus();\n    event.preventDefault();\n  }\n};","export const responseHandlerMixin = {\n  /**\n   * Maneja el evento responseCopy para copiar el contenido al portapapeles\n   * @param {CustomEvent} event - El evento con el ID de la respuesta\n   */\n  handleResponseCopy(event) {\n    console.log(\"[ResponseHandlers] Copy event received:\", event.detail);\n    const { responseId } = event.detail;\n\n    if (!responseId) {\n      console.warn(\"[ResponseHandlers] No responseId provided in copy event\");\n      return;\n    }\n\n    const response = this.responseHistory?.getResponse(responseId);\n    if (!response) {\n      console.warn(\"[ResponseHandlers] No response found for ID:\", responseId);\n      return;\n    }\n\n    navigator.clipboard\n      .writeText(response.content)\n      .then(() => {\n        console.log(\"[ResponseHandlers] Content copied to clipboard\");\n\n        // Mostrar notificación al usuario si está disponible\n        if (this.notificationManager) {\n          this.notificationManager.success(\"Content copied to clipboard\", 2000);\n        }\n      })\n      .catch((err) => {\n        console.error(\"[ResponseHandlers] Copy failed:\", err);\n\n        // Mostrar error si hay un problema\n        if (this.notificationManager) {\n          this.notificationManager.error(\"Failed to copy to clipboard\");\n        }\n      });\n  },\n\n  /**\n   * Maneja el evento responseUse para utilizar una respuesta generada\n   * Versión mejorada con mejor manejo de errores y diagnóstico\n   * @param {CustomEvent} event - El evento con la respuesta\n   */\n  handleResponseUse(event) {\n    try {\n      console.log(\"[ResponseHandlers] Use event received:\", event.detail);\n\n      // Verificar si el evento tiene los datos necesarios\n      if (!event.detail || !event.detail.responseId) {\n        console.warn(\"[ResponseHandlers] Invalid event data:\", event.detail);\n        throw new Error(\"Invalid response data\");\n      }\n\n      const { responseId } = event.detail;\n\n      // Obtener la respuesta del historial\n      if (!this.responseHistory) {\n        console.error(\"[ResponseHandlers] No response history available\");\n        throw new Error(\"Response history not available\");\n      }\n\n      const response = this.responseHistory.getResponse(responseId);\n\n      if (!response) {\n        console.warn(\"[ResponseHandlers] No response found for ID:\", responseId);\n        throw new Error(\"Response not found\");\n      }\n\n      // Verificar que la respuesta tenga contenido\n      if (!response.content || typeof response.content !== \"string\" || response.content.trim() === \"\") {\n        console.warn(\"[ResponseHandlers] Empty content in response:\", responseId);\n        throw new Error(\"Response content is empty\");\n      }\n\n      // Convertir el contenido markdown a HTML si es necesario\n      let contentToInsert = response.content;\n      if (this.markdownHandler && [\"tinymce\", \"ckeditor\", \"froala\"].includes(this.editorAdapter?.editorType)) {\n        contentToInsert = this.markdownHandler.convert(response.content);\n        console.log(\"[ResponseHandlers] Content converted to HTML for WYSIWYG editor\");\n      }\n\n      // Primero intentar aplicar usando TinyMCE directamente (si está disponible)\n      if (window.tinymce && this.editorId && tinymce.get(this.editorId)) {\n        const editor = tinymce.get(this.editorId);\n        if (editor && editor.initialized) {\n          editor.setContent(contentToInsert);\n          editor.undoManager.add();\n          console.log(\"[ResponseHandlers] Content applied directly to TinyMCE\");\n\n          // Cerrar el modal\n          setTimeout(() => {\n            const modal = this.shadowRoot.querySelector(\".modal\");\n            if (modal) {\n              modal.classList.remove(\"open\");\n            }\n          }, 100);\n\n          return true;\n        }\n      }\n\n      // Intentar usar el adaptador del editor como fallback\n      if (this.editorAdapter) {\n        console.log(\"[ResponseHandlers] Applying content via editor adapter\");\n\n        // Usar el método setContent del adaptador del editor\n        const success = this.editorAdapter.setContent(contentToInsert);\n\n        if (success) {\n          console.log(\"[ResponseHandlers] Response content applied to editor\");\n\n          // Disparar evento ai-content-generated para plugins\n          this.dispatchEvent(\n            new CustomEvent(\"ai-content-generated\", {\n              detail: { content: contentToInsert },\n              bubbles: true,\n              composed: true,\n            })\n          );\n\n          // Cerrar el modal\n          const modal = this.shadowRoot.querySelector(\".modal\");\n          if (modal) {\n            modal.classList.remove(\"open\");\n          }\n\n          // Mostrar notificación\n          if (this.notificationManager) {\n            this.notificationManager.success(\"Content applied successfully\");\n          }\n\n          return true;\n        } else {\n          console.error(\"[ResponseHandlers] Failed to apply content to editor\");\n          throw new Error(\"Failed to apply content to editor\");\n        }\n      } else {\n        console.error(\"[ResponseHandlers] No editor adapter available\");\n        throw new Error(\"No editor connected\");\n      }\n    } catch (error) {\n      console.error(\"[ResponseHandlers] Error in handleResponseUse:\", error);\n\n      if (this.notificationManager) {\n        this.notificationManager.error(`Error: ${error.message}`);\n      }\n\n      return false;\n    }\n  },\n\n  /**\n   * Maneja el evento responseRetry para volver a ejecutar una acción\n   * @param {CustomEvent} event - El evento con la información de la acción a reintentar\n   */\n  handleResponseRetry(event) {\n    console.log(\"[ResponseHandlers] Retry event received:\", event.detail);\n    const { responseId, action } = event.detail;\n\n    if (!responseId) {\n      console.warn(\"[ResponseHandlers] No responseId provided in retry event\");\n      return;\n    }\n\n    const response = this.responseHistory?.getResponse(responseId);\n    if (!response) {\n      console.warn(\"[ResponseHandlers] No response found for ID:\", responseId);\n      return;\n    }\n\n    console.log(\"[ResponseHandlers] Retrying action:\", response.action);\n\n    // Crear un evento sintético con la estructura necesaria\n    const syntheticEvent = {\n      detail: {\n        action: action || response.action,\n        responseId: responseId,\n        content: response.content,\n      },\n    };\n\n    // Llamar al método handleToolAction con el evento sintético\n    this.handleToolAction(syntheticEvent);\n  },\n\n  /**\n   * Maneja el evento responseEdit para editar una respuesta\n   * @param {CustomEvent} event - El evento con el ID de la respuesta a editar\n   */\n  handleResponseEdit(event) {\n    console.log(\"[ResponseHandlers] Edit event received:\", event.detail);\n    const { responseId } = event.detail;\n\n    if (!responseId) {\n      console.warn(\"[ResponseHandlers] No responseId provided in edit event\");\n      return;\n    }\n\n    const response = this.responseHistory?.getResponse(responseId);\n    if (!response) {\n      console.warn(\"[ResponseHandlers] No response found for ID:\", responseId);\n      return;\n    }\n\n    // La implementación de la edición dependerá de tu diseño UI\n    // Aquí podría mostrarse un modal, o enviar el contenido a un área de edición, etc.\n    console.log(\"[ResponseHandlers] Edit functionality not fully implemented\");\n\n    // Mostrar notificación informativa\n    if (this.notificationManager) {\n      this.notificationManager.info(\"Edit functionality coming soon\");\n    }\n  },\n};\n","// src/features/image-handlers.js\n\nexport const imageHandlerMixin = {\n  isImageUsed(image) {\n    if (!this.responseHistory) return false;\n\n    const imageId = image instanceof File ? image.name : image;\n    return this.responseHistory.responses.some(\n      (response) =>\n        response.action !== \"image-upload\" && response.imageUsed === imageId\n    );\n  },\n\n  handleImageChange(file) {\n    if (file) {\n      this.productImage = file;\n      this.productImageUrl = null;\n\n      // Encontrar el último mensaje de pregunta en el historial\n      const lastQuestion = this.responseHistory.responses.findLast(\n        (response) => response.action === \"chat-question\"\n      );\n\n      if (lastQuestion) {\n        // Mover el contenido de la imagen al contenido de la pregunta\n        const imagePreviewHTML = this.renderImagePreview(file);\n\n        // Buscar el elemento response-content en el DOM\n        const questionEntry = this.shadowRoot.querySelector(\n          `.response-entry[data-response-id=\"${lastQuestion.id}\"]`\n        );\n\n        if (questionEntry) {\n          const responseContent =\n            questionEntry.querySelector(\".response-content\");\n          if (responseContent) {\n            // Insertar la imagen directamente en el response-content\n            responseContent.insertAdjacentHTML(\"beforeend\", imagePreviewHTML);\n          }\n        }\n\n        // Eliminar las entradas de image-upload existentes del DOM\n        const imageUploadEntries = this.shadowRoot.querySelectorAll(\n          '.response-entry[data-action=\"image-upload\"]'\n        );\n        imageUploadEntries.forEach((entry) => entry.remove());\n\n        // Eliminar las entradas de image-upload del historial\n        this.responseHistory.responses = this.responseHistory.responses.filter(\n          (response) => response.action !== \"image-upload\"\n        );\n      }\n    }\n  },\n\n  removeImage() {\n    if (this.productImage || this.productImageUrl) {\n      this.productImage = null;\n      this.productImageUrl = null;\n\n      // Encontrar y actualizar el último mensaje de pregunta en el historial\n      const lastQuestion = this.responseHistory.responses.findLast(\n        (response) => response.action === \"chat-question\"\n      );\n\n      if (lastQuestion) {\n        // Eliminar el HTML de la imagen del contenido\n        lastQuestion.content = lastQuestion.content.replace(\n          /<div class=\"image-preview-card\"[\\s\\S]*?<\\/div><\\/div><\\/div>/g,\n          \"\"\n        );\n\n        // En lugar de usar this.requestUpdate (que no existe), forzamos una actualización\n        // renderizando de nuevo el historial de respuestas\n        if (this.responseHistory) {\n          this.responseHistory.render();\n        }\n      }\n    }\n  },\n\n  renderImagePreview(image = null, isInitial = false) {\n    const imageToRender = image || this.productImage || this.productImageUrl;\n    if (!imageToRender) return \"\";\n\n    const imageUrl =\n      imageToRender instanceof File\n        ? URL.createObjectURL(imageToRender)\n        : imageToRender;\n\n    const filename =\n      imageToRender instanceof File\n        ? imageToRender.name\n        : new URL(imageToRender).pathname.split(\"/\").pop() || \"From URL\";\n\n    return `\n      <div class=\"image-preview-card\" \n           data-image-id=\"${Date.now()}\"\n           role=\"figure\"\n           aria-label=\"${\n             isInitial ? \"Initial product image\" : \"Uploaded product image\"\n           }\">\n        <div class=\"image-preview-content\">\n          <div class=\"image-preview-thumbnail\">\n            <img src=\"${imageUrl}\" alt=\"Product preview - ${filename}\">\n          </div>\n        </div>\n      </div>\n    `;\n  },\n};\n","// src/features/state-integration.js\nimport { createStateManager } from \"../utils/state-utils.js\";\n\nexport const stateManagementMixin = {\n  initializeStateManager() {\n    this.stateManager = createStateManager(this);\n\n    // Configuración de escuchadores para eventos de estado\n    this.addEventListener(\"stateChange\", this.handleStateChange.bind(this));\n    this.addEventListener(\n      \"stateBatchChange\",\n      this.handleStateBatchChange.bind(this)\n    );\n  },\n\n  handleStateChange(event) {\n    const { property, oldValue, newValue } = event.detail;\n    console.log(\n      `[StateManager] Property '${property}' changed:`,\n      oldValue,\n      \"->\",\n      newValue\n    );\n\n    // Manejar cambios específicos de propiedades\n    switch (property) {\n      case \"productImage\":\n        this.handleProductImageChange(oldValue, newValue);\n        break;\n      case \"enhancedText\":\n        this.handleEnhancedTextChange(oldValue, newValue);\n        break;\n      // Agregar más manejadores según sea necesario\n    }\n  },\n\n  handleStateBatchChange(event) {\n    console.log(\"[StateManager] Batch state change:\", event.detail.changes);\n\n    // Detectar tipos de cambios en el lote\n    const changedProps = event.detail.changes.map((c) => c.property);\n\n    if (changedProps.includes(\"productImage\")) {\n      const change = event.detail.changes.find(\n        (c) => c.property === \"productImage\"\n      );\n      this.handleProductImageChange(change.oldValue, change.newValue);\n    }\n\n    // Manejar más cambios según sea necesario\n  },\n\n  handleProductImageChange(oldImage, newImage) {\n    // Actualizar la interfaz de usuario basada en la imagen\n    if (newImage) {\n      console.log(\"[StateManager] New product image set:\", newImage.name);\n\n      // Si responseHistory existe, actualiza la vista\n      if (this.responseHistory) {\n        const lastQuestion = this.responseHistory.responses.findLast(\n          (response) => response.action === \"chat-question\"\n        );\n\n        if (lastQuestion) {\n          // Agregar la imagen a la última pregunta si existe\n          this.responseHistory.render();\n        }\n      }\n    } else if (oldImage) {\n      console.log(\"[StateManager] Product image removed\");\n    }\n  },\n\n  handleEnhancedTextChange(oldText, newText) {\n    // Manejar cambios en el texto mejorado\n    console.log(\"[StateManager] Enhanced text updated\");\n  },\n\n  // Método para solicitar una actualización de la interfaz de usuario\n  requestUpdate(target = null) {\n    console.log(\n      \"[StateManager] Update requested for:\",\n      target || \"entire component\"\n    );\n\n    if (!target) {\n      // Actualización general del componente\n      if (this.responseHistory) {\n        this.responseHistory.render();\n      }\n      this.updateVisibleTools();\n      return;\n    }\n\n    // Actualizaciones específicas de componentes\n    switch (target) {\n      case \"responseHistory\":\n        if (this.responseHistory) {\n          this.responseHistory.render();\n        }\n        break;\n      case \"toolbar\":\n        this.updateVisibleTools();\n        break;\n      // Otros casos según sea necesario\n    }\n  },\n};\n","// src/utils/state-utils.js\n\n/**\n * Utilidad para gestionar actualizaciones de estado y renderizado en componentes web\n *\n * @param {HTMLElement} component - El componente web que se va a ampliar con funcionalidades de estado\n * @returns {Object} - Métodos para manipular el estado del componente\n */\nexport const createStateManager = (component) => {\n  // Estado interno privado\n  const _state = {};\n\n  return {\n    /**\n     * Actualiza una propiedad de estado y opcionalmente vuelve a renderizar partes del componente\n     *\n     * @param {string} propName - Nombre de la propiedad a actualizar\n     * @param {any} value - Nuevo valor\n     * @param {Object} options - Opciones de actualización\n     * @param {Boolean} options.rerender - Si se debe volver a renderizar después de la actualización\n     * @param {String} options.targetSelector - Selector CSS del elemento que debería actualizarse\n     */\n    updateState(propName, value, options = {}) {\n      const oldValue = _state[propName];\n      _state[propName] = value;\n\n      // Disparar evento de cambio de propiedad\n      component.dispatchEvent(\n        new CustomEvent(\"stateChange\", {\n          detail: { property: propName, oldValue, newValue: value },\n          bubbles: false,\n        })\n      );\n\n      // Opcionalmente re-renderizar\n      if (options.rerender && component.shadowRoot) {\n        if (options.targetSelector) {\n          // Renderizado selectivo\n          const target = component.shadowRoot.querySelector(\n            options.targetSelector\n          );\n          if (target && typeof component.renderPart === \"function\") {\n            component.renderPart(target, propName);\n          }\n        } else if (typeof component.render === \"function\") {\n          // Renderizado completo\n          component.render();\n        }\n      }\n\n      return value;\n    },\n\n    /**\n     * Obtiene el valor actual de una propiedad de estado\n     *\n     * @param {string} propName - Nombre de la propiedad\n     * @param {any} defaultValue - Valor por defecto si la propiedad no existe\n     * @returns {any} - Valor actual de la propiedad\n     */\n    getState(propName, defaultValue = null) {\n      return propName in _state ? _state[propName] : defaultValue;\n    },\n\n    /**\n     * Devuelve una copia de todo el estado actual\n     *\n     * @returns {Object} - Copia del estado actual\n     */\n    getAllState() {\n      return { ..._state };\n    },\n\n    /**\n     * Actualiza múltiples propiedades de estado a la vez\n     *\n     * @param {Object} stateUpdates - Objeto con las actualizaciones {propiedad: nuevoValor}\n     * @param {Object} options - Opciones de actualización (igual que updateState)\n     */\n    batchUpdate(stateUpdates, options = {}) {\n      const changedProps = [];\n\n      for (const [propName, value] of Object.entries(stateUpdates)) {\n        const oldValue = _state[propName];\n        if (oldValue !== value) {\n          _state[propName] = value;\n          changedProps.push({ property: propName, oldValue, newValue: value });\n        }\n      }\n\n      // Solo disparar evento si hubo cambios\n      if (changedProps.length > 0) {\n        component.dispatchEvent(\n          new CustomEvent(\"stateBatchChange\", {\n            detail: { changes: changedProps },\n            bubbles: false,\n          })\n        );\n\n        // Renderizado tras actualización por lotes\n        if (options.rerender && component.shadowRoot) {\n          if (\n            options.targetSelector &&\n            typeof component.renderPart === \"function\"\n          ) {\n            const target = component.shadowRoot.querySelector(\n              options.targetSelector\n            );\n            if (target) {\n              component.renderPart(\n                target,\n                changedProps.map((c) => c.property)\n              );\n            }\n          } else if (typeof component.render === \"function\") {\n            component.render();\n          }\n        }\n      }\n\n      return changedProps.length > 0;\n    },\n  };\n};\n","// Mejora de la función createTemplate en src/template.js\n// Esta función crea el HTML del componente AITextEnhancer\n\nimport { variables } from \"./styles/base/variables.js\";\nimport { animations } from \"./styles/base/animations.js\";\nimport { modalTriggerStyles } from \"./styles/components/modal-trigger.js\";\nimport { modalStyles } from \"./styles/layout/modal.js\";\nimport { previewStyles } from \"./styles/layout/preview.js\";\nimport { imagePreviewStyles } from \"./styles/components/image-preview.js\";\nimport { notificationStyles } from \"./styles/components/notifications.js\";\n\nexport function createTemplate(component) {\n  if (!component) {\n    console.error(\"[createTemplate] Error: No se proporcionó un componente\");\n    return \"\";\n  }\n\n  try {\n    console.log(\n      \"[createTemplate] Creando template para el componente\",\n      component.tagName\n    );\n\n    // Acceder a las traducciones con validación para evitar errores\n    const t = component.translations || {};\n\n    // Determinar si hay contenido y contexto con validación\n    const currentContent =\n      typeof component.currentContent === \"function\"\n        ? component.currentContent()\n        : component.currentContent || \"\";\n\n    const context = component.context || \"\";\n\n    const hasContent = Boolean(currentContent?.trim && currentContent.trim());\n    const hasContext = Boolean(context?.trim && context.trim());\n\n    // Verificar si el botón modal-trigger debe ser ocultado\n    // Añadir esta línea para comprobar el atributo hide-trigger\n    const showTrigger = !component.hideTrigger;\n\n    console.log(\"[createTemplate] Estado del componente:\", {\n      hasContent,\n      hasContext,\n      language: component.language || \"en\",\n      showTrigger, // Añadir esta línea para mostrar el estado en logs\n    });\n\n    // HTML del componente con comentarios para facilitar la depuración\n    return `\n    <!-- Estilos del componente -->\n    <style>\n      ${variables}\n      ${animations}\n      ${modalTriggerStyles}\n      ${modalStyles}\n      ${previewStyles}\n      ${imagePreviewStyles}\n      ${notificationStyles}\n      \n      /* Estilos específicos del componente */\n      :host {\n        display: inline-block;\n        font-family: var(--ai-font-sans);\n        position: relative;\n      }\n\n      .editor-section {\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        min-height: 0;\n      }\n\n      .chat-section {\n        position: relative;\n        width: 100%;\n        bottom: 0;\n        left: 0;\n      }\n\n      .tools-container {\n        margin-bottom: 1rem;\n      }\n\n      response-history {\n        flex: 1;\n        min-height: 0;\n        max-height: calc(85vh - 120px);\n        background: var(--ai-background);\n        border-radius: var(--ai-radius);\n        margin-bottom: 1rem;\n        overflow: auto;\n        display: block;\n      }\n      \n      /* Contenedor de notificaciones */\n      .notifications-container {\n        position: fixed;\n        top: 1rem;\n        right: 1rem;\n        z-index: var(--ai-z-notification, 100001);\n        pointer-events: none;\n      }\n      \n      .notifications-container > * {\n        pointer-events: auto;\n      }\n      \n      /* Estilos de ayuda y depuración */\n      .debug-info {\n        display: none;\n        padding: 10px;\n        margin: 10px 0;\n        background: #f8f9fa;\n        border: 1px solid #dee2e6;\n        border-radius: 4px;\n        font-size: 12px;\n      }\n      \n      /* Mostrar en modo depuración */\n      :host([debug]) .debug-info {\n        display: block;\n      }\n    </style>\n\n    <!-- Botón para abrir el modal (CONDICIONAL) -->\n    ${\n      showTrigger\n        ? `\n    <button class=\"modal-trigger\" id=\"modal-trigger-button\">\n       <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" fill-opacity=\"0\" stroke=\"#ffffff\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n                        <path d=\"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72\"/>\n                        <path d=\"m14 7 3 3\"/>\n                        <path d=\"M5 6v4\"/>\n                        <path d=\"M19 14v4\"/>\n                        <path d=\"M10 2v2\"/>\n                        <path d=\"M7 8H3\"/>\n                        <path d=\"M21 16h-4\"/>\n                        <path d=\"M11 3H9\"/>\n                      </svg>\n      <span>${t?.modalTrigger || \"Enhance with AI\"}</span>\n    </button>\n    `\n        : \"\"\n    }\n    \n    <!-- Modal principal -->\n    <div class=\"modal\" id=\"ai-enhancer-modal\">\n      <div class=\"modal-content\">\n        <button class=\"close-button\" aria-label=\"Close modal\">×</button>\n        <div class=\"modal-header\">\n          <h2>${t?.modalTitle || \"Enhance Text\"}</h2>\n        </div>\n        \n        <div class=\"modal-body\">\n          <!-- Historial de respuestas -->\n          <div class=\"editor-section\">\n            <response-history language=\"${\n              component.language || \"en\"\n            }\"></response-history>\n          </div>\n          \n          <!-- Sección de chat -->\n          <div class=\"chat-section\">\n            <chat-with-image\n              language=\"${component.language || \"en\"}\"\n              image-url=\"${component.imageUrl || \"\"}\"\n              api-provider=\"${component.apiProvider || \"openai\"}\"\n              has-content=\"${hasContent.toString()}\"\n              has-context=\"${hasContext.toString()}\">\n            </chat-with-image>\n          </div>\n        </div>\n      </div>\n    </div>\n    \n    <!-- Contenedor de notificaciones -->\n    <div class=\"notifications-container\"></div>`;\n  } catch (error) {\n    console.error(\"[createTemplate] Error creando template:\", error);\n\n    // Retornar un template básico en caso de error\n    return `\n    <div style=\"color: red; padding: 10px; border: 1px solid red;\">\n      Error creating component template: ${error.message}\n    </div>\n    <button class=\"modal-trigger\">Enhance Text</button>\n    <div class=\"modal\">\n      <div class=\"modal-content\">\n        <button class=\"close-button\">×</button>\n        <div class=\"modal-header\">\n          <h2>Enhance Text</h2>\n        </div>\n        <div class=\"modal-body\">\n          <p>Error loading component. Please try refreshing the page.</p>\n        </div>\n      </div>\n    </div>`;\n  }\n}\n","// Versión mejorada del archivo index.js con todas las correcciones integradas\n\nimport { ResponseHistory } from \"./components/ResponseHistory.js\";\nimport { ChatWithImage } from \"./components/ChatWithImage.js\";\nimport { ToolBar } from \"./components/ToolBar.js\";\nimport { TokenManager } from \"./services/token-manager.js\";\nimport { MarkdownHandler } from \"./services/markdown-handler.js\";\nimport { createAPIClient } from \"./services/api-client.js\";\nimport { createCacheManager } from \"./services/cache-manager.js\";\nimport { ModelManager } from \"./services/model-manager.js\";\nimport { EditorAdapter } from \"./services/editor-adapter.js\";\nimport { createEventEmitter } from \"./utils/event-utils.js\";\nimport { attachShadowTemplate } from \"./utils/dom-utils.js\";\nimport { TRANSLATIONS } from \"./constants/translations.js\";\nimport { createNotificationManager } from \"./services/notification-manager.js\";\n\n// Feature imports\nimport {\n  setupKeyboardNavigation,\n  keyboardNavigationMixin,\n} from \"./features/keyboard-navigation.js\";\nimport { responseHandlerMixin } from \"./features/response-handlers.js\";\nimport { imageHandlerMixin } from \"./features/image-handlers.js\";\nimport { stateManagementMixin } from \"./features/state-integration.js\";\nimport { createTemplate } from \"./template.js\";\n\nclass AITextEnhancer extends HTMLElement {\n  constructor() {\n    super();\n\n    // Apply mixins first\n    Object.assign(\n      this,\n      keyboardNavigationMixin,\n      responseHandlerMixin,\n      imageHandlerMixin,\n      stateManagementMixin\n    );\n\n    // Register required components\n    if (!customElements.get(\"ai-toolbar\")) {\n      customElements.define(\"ai-toolbar\", ToolBar);\n    }\n    if (!customElements.get(\"chat-with-image\")) {\n      customElements.define(\"chat-with-image\", ChatWithImage);\n    }\n    if (!customElements.get(\"response-history\")) {\n      customElements.define(\"response-history\", ResponseHistory);\n    }\n\n    // Initialize core components\n    this.eventEmitter = createEventEmitter(this);\n    this.responseHistory = null;\n    this.editorAdapter = null;\n    this.currentAction = \"improve\";\n    this.modelManager = new ModelManager();\n    this.markdownHandler = new MarkdownHandler();\n    this.tokenManager = new TokenManager();\n\n    // Inicializar el gestor de estado\n    this.initializeStateManager();\n\n    // Initialize cache\n    this.cacheManager = createCacheManager({\n      prefix: \"ai-text-enhancer\",\n      maxItems: 20,\n      ttl: 30 * 60 * 1000,\n    });\n\n    // State initialization\n    this.stateManager.batchUpdate({\n      enhancedText: \"\",\n      chatMessages: [],\n      isInitialized: false,\n      productImage: null,\n      usageControl: null,\n    });\n\n    // Bind methods after mixins are applied\n    this.bindMethods();\n  }\n\n  bindMethods() {\n    // Core methods\n    this.handleToolAction = this.handleToolAction?.bind(this);\n    this.handleChatMessage = this.handleChatMessage?.bind(this);\n\n    // Response handler methods\n    this.handleResponseCopy = this.handleResponseCopy?.bind(this);\n    this.handleResponseUse = this.handleResponseUse?.bind(this);\n    this.handleResponseRetry = this.handleResponseRetry?.bind(this);\n    this.handleResponseEdit = this.handleResponseEdit?.bind(this);\n\n    // Keyboard navigation methods\n    this.handleKeyboard = this.handleKeyboard?.bind(this);\n    this.handleModalKeyboard = this.handleModalKeyboard?.bind(this);\n\n    // Modal trigger handler\n    this.modalTriggerHandler = this.modalTriggerHandler?.bind(this);\n  }\n\n  // Getters\n  static get observedAttributes() {\n    return [\n      \"editor-id\",\n      \"api-key\",\n      \"api-provider\",\n      \"api-model\",\n      \"language\",\n      \"prompt\",\n      \"context\",\n      \"image-url\",\n      \"tenant-id\",\n      \"user-id\",\n      \"quota-endpoint\",\n      \"proxy-endpoint\",\n      \"editor-type\",\n      \"hide-trigger\",\n    ];\n  }\n\n  get language() {\n    return this.getAttribute(\"language\") || \"en\";\n  }\n\n  get translations() {\n    return TRANSLATIONS[this.language] || TRANSLATIONS.en;\n  }\n\n  get editorId() {\n    return this.getAttribute(\"editor-id\");\n  }\n\n  get editorType() {\n    return this.getAttribute(\"editor-type\") || \"textarea\";\n  }\n\n  get apiKey() {\n    return this.getAttribute(\"api-key\");\n  }\n\n  get prompt() {\n    return (\n      this.getAttribute(\"prompt\") ||\n      \"You are a professional content enhancer. Improve the text while maintaining its core message and intent.\"\n    );\n  }\n\n  get currentContent() {\n    return this.editorAdapter?.getContent() || \"\";\n  }\n\n  get apiProvider() {\n    return this.getAttribute(\"api-provider\") || \"openai\";\n  }\n\n  get apiModel() {\n    const model = this.getAttribute(\"api-model\");\n    try {\n      return this.modelManager.getModelConfig(model)?.id;\n    } catch {\n      return this.modelManager.getDefaultModel();\n    }\n  }\n\n  get imageUrl() {\n    return this.getAttribute(\"image-url\");\n  }\n\n  get context() {\n    return this.getAttribute(\"context\") || \"\";\n  }\n\n  get proxyEndpoint() {\n    return this.getAttribute(\"proxy-endpoint\");\n  }\n\n  get hideTrigger() {\n    return this.hasAttribute(\"hide-trigger\");\n  }\n\n  // Método mejorado para connectedCallback\n  async connectedCallback() {\n    try {\n      console.log(\"[AITextEnhancer] Component connected, initializing...\");\n\n      // Crear el template y adjuntarlo al shadowRoot\n      const template = createTemplate(this);\n      attachShadowTemplate(this, template);\n      console.log(\"[AITextEnhancer] Shadow DOM created\");\n\n      // Inicializar el NotificationManager\n      const notificationsContainer = this.shadowRoot.querySelector(\n        \".notifications-container\"\n      );\n      if (notificationsContainer) {\n        this.notificationManager = createNotificationManager(\n          notificationsContainer\n        );\n        console.log(\"[AITextEnhancer] Notification manager initialized\");\n      }\n\n      // Asegurar que el modal exista y esté configurado correctamente\n      this.ensureModalExists();\n\n      // Configurar idioma para los hijos\n      this.updateLanguageForChildren(this.language);\n\n      // Configurar eventos\n      this.setupEventListeners();\n      setupKeyboardNavigation(this);\n\n      // Inicializar componentes - esperar a que completen\n      await this.initializeComponents();\n      console.log(\"[AITextEnhancer] Components initialized\");\n\n      // Configurar listener del editor\n      this.setupEditorListener();\n\n      // Actualizar estado inicial del chat\n      this.updateChatState();\n\n      // Reforzar la vinculación de eventos después de la inicialización\n      setTimeout(() => {\n        console.log(\"[AITextEnhancer] Re-binding events after initialization\");\n        this.bindEvents();\n\n        // Verificación final\n        const modalTrigger = this.shadowRoot.querySelector(\".modal-trigger\");\n        if (modalTrigger) {\n          console.log(\"[AITextEnhancer] Modal trigger element:\", modalTrigger);\n        } else {\n          console.warn(\n            \"[AITextEnhancer] Modal trigger still not found after initialization\"\n          );\n        }\n      }, 200);\n\n      console.log(\"[AITextEnhancer] Component fully initialized\");\n    } catch (error) {\n      console.error(\"[AITextEnhancer] Error initializing component:\", error);\n\n      // Intentar mostrar notificación de error\n      try {\n        if (this.notificationManager) {\n          this.notificationManager.error(\n            `Initialization error: ${error.message}`\n          );\n        } else {\n          // Fallback: mostrar error en el shadowRoot si está disponible\n          if (this.shadowRoot) {\n            const errorElement = document.createElement(\"div\");\n            errorElement.style.color = \"red\";\n            errorElement.style.padding = \"10px\";\n            errorElement.style.margin = \"10px 0\";\n            errorElement.style.border = \"1px solid red\";\n            errorElement.textContent = `Error initializing component: ${error.message}`;\n            this.shadowRoot.appendChild(errorElement);\n          }\n        }\n      } catch (notifError) {\n        console.error(\n          \"[AITextEnhancer] Error showing notification:\",\n          notifError\n        );\n      }\n    }\n  }\n\n  // Método mejorado para attributeChangedCallback\n  attributeChangedCallback(name, oldValue, newValue) {\n    console.log(\n      \"[AITextEnhancer] Attribute changed:\",\n      name,\n      \"from\",\n      oldValue,\n      \"to\",\n      newValue\n    );\n    if (oldValue === newValue) return;\n\n    switch (name) {\n      case \"api-key\":\n        if (this.apiClient) {\n          this.apiClient.setApiKey(newValue);\n        } else if (!this.isInitialized) {\n          this.initializeComponents();\n        }\n        break;\n      case \"language\":\n        this.updateLanguageForChildren(newValue);\n        break;\n      case \"context\":\n        // Update chat state when context changes\n        setTimeout(() => this.updateChatState(), 100);\n        break;\n      case \"api-provider\":\n      case \"api-model\":\n      case \"proxy-endpoint\":\n        if (this.isInitialized && this.apiClient) {\n          this.apiClient.updateConfig({\n            provider: this.apiProvider,\n            model: this.apiModel,\n            proxyEndpoint: this.proxyEndpoint,\n          });\n        }\n        break;\n      case \"image-url\":\n        if (this.isInitialized) {\n          const chatComponent =\n            this.shadowRoot.querySelector(\"chat-with-image\");\n          if (chatComponent) {\n            chatComponent.setAttribute(\"image-url\", newValue || \"\");\n          }\n        }\n        break;\n    }\n  }\n\n  // Método mejorado para setupEditorListener\n  setupEditorListener() {\n    if (!this.editorId) {\n      console.warn(\"[AITextEnhancer] No editor ID provided\");\n      return;\n    }\n\n    const editorElement = document.getElementById(this.editorId);\n    if (!editorElement) {\n      console.warn(\n        `[AITextEnhancer] Editor element with ID \"${this.editorId}\" not found`\n      );\n\n      if (this.notificationManager) {\n        this.notificationManager.warning(\n          `Editor element \"${this.editorId}\" not found. Text enhancement functionality may be limited.`\n        );\n      }\n      return;\n    }\n\n    // Función para actualizar el estado del chat cuando cambia el contenido del editor\n    const updateChatOnChange = () => {\n      // Update only if modal is open to avoid unnecessary updates\n      if (this.isModalOpen()) {\n        this.updateChatState();\n\n        // También actualizar las herramientas visibles basado en el contenido\n        this.updateVisibleTools();\n      }\n    };\n\n    // Eliminar listeners anteriores si existen\n    if (this._editorChangeListener) {\n      editorElement.removeEventListener(\"input\", this._editorChangeListener);\n      editorElement.removeEventListener(\"change\", this._editorChangeListener);\n    }\n\n    // Guardar referencia al listener para poder eliminarlo después\n    this._editorChangeListener = updateChatOnChange;\n\n    // Añadir listeners para diferentes tipos de editores\n    editorElement.addEventListener(\"input\", this._editorChangeListener);\n    editorElement.addEventListener(\"change\", this._editorChangeListener);\n\n    console.log(\n      `[AITextEnhancer] Editor listener set up for \"${this.editorId}\"`\n    );\n  }\n\n  // Método mejorado para updateLanguageForChildren\n  updateLanguageForChildren(language) {\n    console.log(\"[AITextEnhancer] Updating language for children:\", language);\n\n    if (!this.shadowRoot) {\n      console.warn(\"[AITextEnhancer] No shadowRoot available yet\");\n      return;\n    }\n\n    // Update modal texts\n    const modalTrigger = this.shadowRoot.querySelector(\".modal-trigger span\");\n    const modalTitle = this.shadowRoot.querySelector(\".modal-header h2\");\n\n    if (modalTrigger) {\n      modalTrigger.textContent =\n        this.translations.modalTrigger || \"Enhance Text\";\n      console.log(\n        \"[AITextEnhancer] Updated modal trigger text:\",\n        modalTrigger.textContent\n      );\n    }\n\n    if (modalTitle) {\n      modalTitle.textContent = this.translations.modalTitle || \"Enhance Text\";\n      console.log(\n        \"[AITextEnhancer] Updated modal title text:\",\n        modalTitle.textContent\n      );\n    }\n\n    // Asegurar que el manejador de eventos siga funcionando\n    if (this.modalTriggerHandler) {\n      const trigger = this.shadowRoot.querySelector(\".modal-trigger\");\n      if (trigger) {\n        trigger.removeEventListener(\"click\", this.modalTriggerHandler);\n        trigger.addEventListener(\"click\", this.modalTriggerHandler);\n      }\n    }\n\n    // Actualizar componentes con el atributo de language\n    const components = this.shadowRoot.querySelectorAll(\"[language]\");\n    console.log(\n      \"[AITextEnhancer] Found components to update:\",\n      components.length\n    );\n\n    components.forEach((component) => {\n      const oldLang = component.getAttribute(\"language\");\n      component.setAttribute(\"language\", language);\n      console.log(\"[AITextEnhancer] Updated component language:\", {\n        component: component.tagName,\n        from: oldLang,\n        to: language,\n      });\n    });\n\n    // Forzar la actualización en componentes específicos\n    const toolbar = this.shadowRoot.querySelector(\"ai-toolbar\");\n    const chatComponent = this.shadowRoot.querySelector(\"chat-with-image\");\n    const responseHistory = this.shadowRoot.querySelector(\"response-history\");\n\n    [toolbar, chatComponent, responseHistory].forEach((component) => {\n      if (component) {\n        component.setAttribute(\"language\", language);\n        console.log(\n          \"[AITextEnhancer] Forced language update on:\",\n          component.tagName\n        );\n      }\n    });\n  }\n\n  // Método mejorado para modalTriggerHandler\n  modalTriggerHandler() {\n    console.log(\"[AITextEnhancer] Modal trigger clicked, checking shadowRoot\");\n\n    if (!this.shadowRoot) {\n      console.error(\"[AITextEnhancer] Shadow root not available\");\n      return;\n    }\n\n    const modal = this.shadowRoot.querySelector(\".modal\");\n    if (!modal) {\n      console.error(\"[AITextEnhancer] Modal element not found in shadowRoot\");\n\n      // Intentar recrear el modal\n      if (this.notificationManager) {\n        this.notificationManager.warning(\n          \"Modal not found, trying to recreate it...\"\n        );\n      }\n\n      if (this.ensureModalExists()) {\n        const newModal = this.shadowRoot.querySelector(\".modal\");\n        if (newModal) {\n          modal = newModal;\n        } else {\n          if (this.notificationManager) {\n            this.notificationManager.error(\"Failed to recreate modal\");\n          }\n          return;\n        }\n      } else {\n        return;\n      }\n    }\n\n    console.log(\"[AITextEnhancer] Opening modal with current state:\", {\n      apiProvider: this.apiProvider,\n      model: this.apiModel,\n      language: this.language,\n      context:\n        this.context?.substring(0, 50) +\n        (this.context?.length > 50 ? \"...\" : \"\"),\n      imageUrl: this.imageUrl,\n      hasContent: Boolean(this.currentContent?.trim()),\n      hasContext: Boolean(this.context?.trim()),\n    });\n\n    modal.classList.add(\"open\");\n\n    // Asegurar que se actualice el estado de las herramientas\n    setTimeout(() => {\n      this.updateVisibleTools();\n      this.updateChatState();\n\n      // Enfocar el primer elemento interactivo para mejorar la accesibilidad\n      const firstFocusable = modal.querySelector(\n        'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n      );\n      if (firstFocusable) {\n        firstFocusable.focus();\n      }\n    }, 100);\n  }\n\n  // Método público para abrir el modal programáticamente\n  openModal() {\n    const modal = this.shadowRoot.querySelector(\".modal\");\n    if (modal) {\n      modal.classList.add(\"open\");\n\n      // Asegurar que se actualice el estado de las herramientas\n      setTimeout(() => {\n        this.updateVisibleTools();\n        this.updateChatState();\n\n        // Enfocar el primer elemento interactivo para mejorar la accesibilidad\n        const firstFocusable = modal.querySelector(\n          'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n        );\n        if (firstFocusable) {\n          firstFocusable.focus();\n        }\n      }, 100);\n    }\n  }\n\n  // Función para asegurar que el modal exista\n  ensureModalExists() {\n    // Esta función garantiza que el modal esté presente en el DOM\n    if (!this.shadowRoot) {\n      console.error(\"[AITextEnhancer] No shadowRoot available for modal check\");\n      return false;\n    }\n\n    let modal = this.shadowRoot.querySelector(\".modal\");\n    if (!modal) {\n      console.warn(\"[AITextEnhancer] Modal not found, attempting to recreate\");\n\n      // Intentar recrear el modal desde la plantilla\n      const template = createTemplate(this);\n      const fragment = document\n        .createRange()\n        .createContextualFragment(template);\n      const newModal = fragment.querySelector(\".modal\");\n\n      if (newModal) {\n        this.shadowRoot.appendChild(newModal);\n        console.log(\"[AITextEnhancer] Modal recreated successfully\");\n\n        // Asegurar que los eventos estén vinculados\n        const closeButton = newModal.querySelector(\".close-button\");\n        if (closeButton) {\n          closeButton.onclick = () => newModal.classList.remove(\"open\");\n        }\n\n        newModal.onclick = (e) => {\n          if (e.target === newModal) {\n            newModal.classList.remove(\"open\");\n          }\n        };\n\n        modal = newModal;\n      } else {\n        console.error(\"[AITextEnhancer] Failed to recreate modal\");\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  // Método mejorado para setupEventListeners\n  setupEventListeners() {\n    // Obtener el componente de chat\n    const chatComponent = this.shadowRoot.querySelector(\"chat-with-image\");\n    if (chatComponent) {\n      // Eliminar listener anterior si existe\n      chatComponent.removeEventListener(\"chatMessage\", this.handleChatMessage);\n      // Agregar nuevo listener\n      chatComponent.addEventListener(\"chatMessage\", this.handleChatMessage);\n      console.log(\"[AITextEnhancer] Chat message event listener set up\");\n    } else {\n      console.warn(\"[AITextEnhancer] Chat component not found\");\n    }\n\n    // Obtener el componente de historial de respuestas\n    this.responseHistory = this.shadowRoot.querySelector(\"response-history\");\n    if (this.responseHistory) {\n      // Configurar markdown handler\n      if (this.markdownHandler) {\n        this.responseHistory.markdownHandler = this.markdownHandler;\n      }\n\n      // Configurar eventos\n      this.responseHistory.addEventListener(\n        \"responseCopy\",\n        this.handleResponseCopy\n      );\n      this.responseHistory.addEventListener(\n        \"responseUse\",\n        this.handleResponseUse\n      );\n      this.responseHistory.addEventListener(\n        \"responseRetry\",\n        this.handleResponseRetry\n      );\n      this.responseHistory.addEventListener(\n        \"responseEdit\",\n        this.handleResponseEdit\n      );\n      this.responseHistory.addEventListener(\n        \"toolaction\",\n        this.handleToolAction\n      );\n\n      console.log(\"[AITextEnhancer] Response history events set up\");\n    } else {\n      console.warn(\"[AITextEnhancer] Response history component not found\");\n    }\n\n    // Configurar evento para actualización de configuración\n    this.addEventListener(\"configurationUpdated\", (event) => {\n      console.log(\"[AITextEnhancer] Configuration updated:\", event.detail);\n      if (this.isInitialized) {\n        this.initializeComponents().catch((error) => {\n          console.error(\"Error reinitializing components:\", error);\n          if (this.notificationManager) {\n            this.notificationManager.error(\n              `Failed to update configuration: ${error.message}`\n            );\n          }\n        });\n      }\n    });\n\n    // Vincular eventos UI\n    this.bindEvents();\n  }\n\n  // Método mejorado para bindEvents\n  bindEvents() {\n    // Verificar que el shadowRoot exista\n    if (!this.shadowRoot) {\n      console.error(\"[AITextEnhancer] No shadowRoot available in bindEvents\");\n      return;\n    }\n\n    // Modal events\n    const modal = this.shadowRoot.querySelector(\".modal\");\n    const modalTrigger = this.shadowRoot.querySelector(\".modal-trigger\");\n\n    if (modalTrigger) {\n      // Define the handler as a bound method if not already bound\n      if (!this.modalTriggerHandler) {\n        this.modalTriggerHandler = this.modalTriggerHandler.bind(this);\n      }\n\n      // Remove any existing event listener before adding new one\n      modalTrigger.removeEventListener(\"click\", this.modalTriggerHandler);\n      modalTrigger.addEventListener(\"click\", this.modalTriggerHandler);\n      console.log(\"[AITextEnhancer] Modal trigger event bound\");\n    } else {\n      console.warn(\"[AITextEnhancer] Modal trigger not found in bindEvents\");\n    }\n\n    // Modal and close button\n    if (modal) {\n      // Set up click outside to close\n      modal.onclick = (e) => {\n        if (e.target === modal) {\n          modal.classList.remove(\"open\");\n        }\n      };\n\n      // Close button\n      const closeButton = modal.querySelector(\".close-button\");\n      if (closeButton) {\n        closeButton.onclick = () => modal.classList.remove(\"open\");\n        console.log(\"[AITextEnhancer] Close button event bound\");\n      } else {\n        console.warn(\"[AITextEnhancer] Close button not found in modal\");\n      }\n    } else {\n      console.warn(\"[AITextEnhancer] Modal element not found in bindEvents\");\n    }\n\n    // Tool buttons\n    const toolbar = this.shadowRoot.querySelector(\"ai-toolbar\");\n    if (toolbar) {\n      // Remove previous listener if it exists\n      toolbar.removeEventListener(\"toolaction\", this.handleToolAction);\n      toolbar.addEventListener(\"toolaction\", this.handleToolAction);\n      console.log(\"[AITextEnhancer] Toolbar events bound\");\n    } else {\n      console.warn(\"[AITextEnhancer] Toolbar not found in bindEvents\");\n    }\n\n    // Chat component\n    const chatComponent = this.shadowRoot.querySelector(\"chat-with-image\");\n    if (chatComponent) {\n      // Remove previous listener if it exists\n      chatComponent.removeEventListener(\"chatMessage\", this.handleChatMessage);\n      chatComponent.addEventListener(\"chatMessage\", this.handleChatMessage);\n      console.log(\"[AITextEnhancer] Chat component events bound\");\n    }\n\n    // Response history\n    if (this.responseHistory) {\n      // Remove previous listeners\n      this.responseHistory.removeEventListener(\n        \"responseCopy\",\n        this.handleResponseCopy\n      );\n      this.responseHistory.removeEventListener(\n        \"responseUse\",\n        this.handleResponseUse\n      );\n      this.responseHistory.removeEventListener(\n        \"responseRetry\",\n        this.handleResponseRetry\n      );\n      this.responseHistory.removeEventListener(\n        \"responseEdit\",\n        this.handleResponseEdit\n      );\n      this.responseHistory.removeEventListener(\n        \"toolaction\",\n        this.handleToolAction\n      );\n\n      // Add new listeners\n      this.responseHistory.addEventListener(\n        \"responseCopy\",\n        this.handleResponseCopy\n      );\n      this.responseHistory.addEventListener(\n        \"responseUse\",\n        this.handleResponseUse\n      );\n      this.responseHistory.addEventListener(\n        \"responseRetry\",\n        this.handleResponseRetry\n      );\n      this.responseHistory.addEventListener(\n        \"responseEdit\",\n        this.handleResponseEdit\n      );\n      this.responseHistory.addEventListener(\n        \"toolaction\",\n        this.handleToolAction\n      );\n      console.log(\"[AITextEnhancer] Response history events bound\");\n    }\n\n    // Set up editor listener\n    this.setupEditorListener();\n\n    console.log(\"[AITextEnhancer] All events bound successfully\");\n  }\n\n  setupTinyMCEIntegration(editorInstance) {\n    // Añadir un listener adicional directamente en response-history para mayor robustez\n    if (this.responseHistory) {\n      this.responseHistory.addEventListener(\"responseUse\", (event) => {\n        try {\n          const { responseId } = event.detail || {};\n          if (!responseId) return;\n\n          // Obtener la respuesta\n          const response = this.responseHistory.getResponse(responseId);\n          if (response && response.content) {\n            // Aplicar directamente a TinyMCE\n            if (editorInstance && editorInstance.initialized) {\n              editorInstance.setContent(response.content);\n              editorInstance.undoManager.add();\n\n              // Cerrar el modal\n              setTimeout(() => {\n                const modal = this.shadowRoot.querySelector(\".modal\");\n                if (modal) {\n                  modal.classList.remove(\"open\");\n                }\n              }, 100);\n            }\n          }\n        } catch (error) {\n          console.error(\n            \"[AITextEnhancer] Error in direct responseUse handler:\",\n            error\n          );\n        }\n      });\n    }\n  }\n\n  // Método actualizado para initializeComponents\n  async initializeComponents() {\n    if (this.isInitialized) {\n      console.log(\"[AITextEnhancer] Components already initialized, skipping\");\n      return;\n    }\n\n    if (this.editorType === \"tinymce\" && window.tinymce) {\n      try {\n        const tinyMceInstance = window.tinymce.get(this.editorId);\n        if (tinyMceInstance) {\n          console.log(\n            \"[AITextEnhancer] TinyMCE detected, configuring special handling\"\n          );\n\n          // Configuración especial para TinyMCE\n          this.setupTinyMCEIntegration(tinyMceInstance);\n        }\n      } catch (error) {\n        console.warn(\n          \"[AITextEnhancer] Error setting up TinyMCE integration:\",\n          error\n        );\n      }\n    }\n\n    try {\n      console.log(\"[AITextEnhancer] Initializing components...\");\n\n      // Inicializar markdown handler\n      await this.markdownHandler.initialize();\n      console.log(\"[AITextEnhancer] Markdown handler initialized\");\n\n      // Obtener el endpoint del proxy del atributo o usar el valor predeterminado\n      const proxyEndpoint =\n        this.proxyEndpoint || \"http://llmproxy2.test:8080/api/llm-proxy\";\n\n      // Inicializar API client con proxy\n      this.apiClient = createAPIClient({\n        provider: this.apiProvider,\n        model: this.apiModel,\n        systemPrompt: this.prompt,\n        temperature: 0.7,\n        proxyEndpoint: proxyEndpoint,\n        tenantId: this.getAttribute(\"tenant-id\") || \"default\",\n        userId: this.getAttribute(\"user-id\") || \"default\",\n        debugMode: true,\n      });\n\n      console.log(\n        \"[AITextEnhancer] API client initialized with provider\",\n        this.apiProvider\n      );\n\n      // Inicializar editor adapter si editor ID es proporcionado\n      if (this.editorId) {\n        // Pasar el tipo de editor al crear EditorAdapter\n        this.editorAdapter = new EditorAdapter(this.editorId, this.editorType);\n        console.log(\n          \"[AITextEnhancer] Editor adapter initialized for\",\n          this.editorId,\n          \"with type\",\n          this.editorType\n        );\n      } else {\n        console.warn(\n          \"[AITextEnhancer] No editor ID provided, editor adapter not initialized\"\n        );\n      }\n\n      // Pasar markdown handler a response history\n      const responseHistory = this.shadowRoot.querySelector(\"response-history\");\n      if (responseHistory) {\n        responseHistory.markdownHandler = this.markdownHandler;\n        console.log(\n          \"[AITextEnhancer] Markdown handler passed to response history\"\n        );\n      }\n\n      // Establecer estado inicial\n      this.isInitialized = true;\n\n      // Notificar éxito\n      if (this.notificationManager) {\n        this.notificationManager.success(\n          \"AI Text Enhancer initialized successfully\"\n        );\n      }\n\n      // Actualizar herramientas visibles basadas en contenido\n      this.updateVisibleTools();\n\n      return true;\n    } catch (error) {\n      console.error(\"Error in initializeComponents:\", error);\n\n      // Notificar error\n      if (this.notificationManager) {\n        this.notificationManager.error(\n          `Initialization error: ${error.message}`\n        );\n      }\n\n      this.addResponseToHistory(\n        \"error\",\n        `Initialization error: ${error.message}`\n      );\n\n      throw error;\n    }\n  }\n\n  isModalOpen() {\n    const modal = this.shadowRoot?.querySelector(\".modal\");\n    return modal ? modal.classList.contains(\"open\") : false;\n  }\n\n  // Método mejorado de updateVisibleTools\n  updateVisibleTools() {\n    try {\n      // Implementación segura que evita errores con .trim()\n      let content = \"\";\n\n      // Intentar obtener el contenido de forma segura\n      if (\n        this.editorAdapter &&\n        typeof this.editorAdapter.getContent === \"function\"\n      ) {\n        try {\n          const rawContent = this.editorAdapter.getContent();\n          content = typeof rawContent === \"string\" ? rawContent : \"\";\n        } catch (error) {\n          console.warn(\n            \"[AITextEnhancer] Error obteniendo contenido del editor:\",\n            error\n          );\n        }\n      }\n\n      // Verificar si hay contenido de forma segura\n      const hasContent = content.trim().length > 0;\n\n      // Actualizar la barra de herramientas\n      const toolbar = this.shadowRoot?.querySelector(\"ai-toolbar\");\n      if (toolbar) {\n        toolbar.setAttribute(\"has-content\", hasContent.toString());\n      }\n    } catch (error) {\n      console.warn(\"[AITextEnhancer] Error en updateVisibleTools:\", error);\n      // No propagar el error para no romper la inicialización\n    }\n  }\n\n  // Getter mejorado de currentContent\n  get currentContent() {\n    try {\n      // Primero intentar usando el editorAdapter\n      if (\n        this.editorAdapter &&\n        typeof this.editorAdapter.getContent === \"function\"\n      ) {\n        const content = this.editorAdapter.getContent();\n        return typeof content === \"string\" ? content : \"\";\n      }\n\n      // Fallback para TinyMCE (si está presente en la página)\n      if (window.tinymce && this.editorId && tinymce.get(this.editorId)) {\n        return tinymce.get(this.editorId).getContent() || \"\";\n      }\n\n      return \"\";\n    } catch (error) {\n      console.warn(\"[AITextEnhancer] Error en getter currentContent:\", error);\n      return \"\";\n    }\n  }\n\n  // Manejador de mensajes de chat actualizado\n  async handleChatMessage(event) {\n    const { message, image } = event.detail;\n\n    try {\n      // Validar mensaje\n      if (!message?.trim() && !image) {\n        throw new Error(\"Message cannot be empty\");\n      }\n\n      // Agregar la pregunta con imagen al historial\n      const questionResponse = {\n        id: Date.now(),\n        action: \"chat-question\",\n        content: `**${this.translations.chat.question}:** ${message}`,\n        timestamp: new Date(),\n        image: image,\n      };\n      this.responseHistory.addResponse(questionResponse);\n\n      // Crear un ID para el streaming de respuestas\n      const responseId = Date.now() + 1;\n\n      // Agregar respuesta inicial vacía\n      this.responseHistory.addResponse({\n        id: responseId,\n        action: \"chat-response\",\n        content: \"\", // Empezar con contenido vacío para streaming adecuado\n        timestamp: new Date(),\n      });\n\n      // Manejador de streaming optimizado para evitar parpadeo\n      const onProgress = (chunk) => {\n        this.responseHistory.updateResponse(\n          responseId,\n          (prevContent) => prevContent + chunk\n        );\n      };\n\n      // Hacer solicitud API con streaming\n      await this.apiClient.chatResponse(\n        this.currentContent,\n        message.trim(),\n        image,\n        onProgress\n      );\n\n      // Un último scroll para asegurar que todo el contenido sea visible\n      setTimeout(() => {\n        const responseContainer = this.shadowRoot.querySelector(\n          \".response-container\"\n        );\n        if (responseContainer) {\n          responseContainer.scrollTop = responseContainer.scrollHeight;\n        }\n      }, 200);\n\n      // Mostrar notificación de éxito sutil\n      if (this.notificationManager) {\n        this.notificationManager.success(\"Response received\", 2000);\n      }\n    } catch (error) {\n      console.error(\"Chat Error:\", error);\n      const errorMessage = this.formatErrorMessage(error);\n      this.addResponseToHistory(\"chat-error\", errorMessage);\n\n      // Mostrar notificación de error\n      if (this.notificationManager) {\n        this.notificationManager.error(`Chat error: ${error.message}`);\n      }\n    }\n  }\n\n  // Agrega este método para solicitar actualizaciones explícitas\n  requestUpdate(part = null) {\n    // Este método delegará en el stateManager\n    if (\n      this.stateManager &&\n      typeof this.stateManager.triggerUpdate === \"function\"\n    ) {\n      return this.stateManager.triggerUpdate(part);\n    } else {\n      console.warn(\n        \"[AITextEnhancer] StateManager or triggerUpdate method not available\"\n      );\n      return false;\n    }\n  }\n\n  /**\n   * Updates the ChatWithImage component with current content and context state\n   * This should be called whenever editor content or context changes\n   */\n  updateChatState() {\n    if (!this.shadowRoot) return;\n\n    const chatComponent = this.shadowRoot.querySelector(\"chat-with-image\");\n    if (!chatComponent) return;\n\n    const hasContent = Boolean(this.currentContent?.trim());\n    const hasContext = Boolean(this.context?.trim());\n\n    // Update attributes\n    chatComponent.setAttribute(\"has-content\", hasContent.toString());\n    chatComponent.setAttribute(\"has-context\", hasContext.toString());\n\n    // Log for debugging\n    console.log(\"[AITextEnhancer] Updated chat state:\", {\n      hasContent,\n      hasContext,\n      contentLength: this.currentContent?.length || 0,\n      contextLength: this.context?.length || 0,\n    });\n  }\n\n  /**\n   * Override the original handleToolAction method to update chat state after content changes\n   */\n  /**\n   * Improved handleToolAction method for AITextEnhancer\n   * This implementation resolves issues with the retry functionality\n   * Replace this method in src/index.js\n   */\n  async handleToolAction(event) {\n    // Safely extract action details with fallbacks\n    const detail = event.detail || {};\n    const action = detail.action;\n    const responseId = detail.responseId;\n    const content = detail.content;\n\n    console.log(\"[AITextEnhancer] Tool action received:\", {\n      action,\n      responseId,\n      contentLength: content ? content.length : 0,\n    });\n\n    if (!action) {\n      console.error(\"[AITextEnhancer] Tool action missing action parameter\");\n      if (this.notificationManager) {\n        this.notificationManager.error(\"Invalid action request\");\n      }\n      return;\n    }\n\n    let tempResponse = null;\n    try {\n      // Determine text to process - from response content, event content, or current editor content\n      const textToProcess = content || this.currentContent;\n\n      // Check for cached response\n      const cachedResponse = this.cacheManager?.get(action, textToProcess);\n      if (cachedResponse) {\n        console.log(\"[AITextEnhancer] Using cached response for\", action);\n        this.addResponseToHistory(action, cachedResponse);\n        return;\n      }\n\n      // Create temporary response for showing progress\n      tempResponse = {\n        id: Date.now(),\n        action,\n        content: \"\", // Empty content to start with\n        timestamp: new Date(),\n      };\n\n      // Add response to history\n      if (this.responseHistory) {\n        this.responseHistory.addResponse(tempResponse);\n      } else {\n        console.error(\"[AITextEnhancer] Response history not available\");\n        return;\n      }\n\n      // Check if components are initialized\n      if (!this.apiClient || !this.isInitialized) {\n        console.log(\n          \"[AITextEnhancer] Components not initialized, initializing now...\"\n        );\n        await this.initializeComponents();\n      }\n\n      // Handler for streaming updates\n      const onProgress = (chunk) => {\n        if (chunk && this.responseHistory) {\n          this.responseHistory.updateResponse(\n            tempResponse.id,\n            (prevContent) => prevContent + chunk\n          );\n        }\n      };\n\n      try {\n        // Make the actual API request\n        console.log(\"[AITextEnhancer] Making API request for action:\", action);\n\n        // Log if we're using an empty text\n        if (!textToProcess) {\n          console.warn(\n            \"[AITextEnhancer] Processing empty text for action:\",\n            action\n          );\n        }\n\n        const completeText = await this.apiClient.enhanceText(\n          textToProcess,\n          action,\n          null, // No image for tool actions\n          this.context,\n          onProgress\n        );\n\n        // Cache for future requests if cache manager is available\n        if (this.cacheManager) {\n          this.cacheManager.set(action, textToProcess, completeText);\n        }\n\n        // Update chat state\n        this.updateChatState();\n\n        // Show success notification\n        if (this.notificationManager) {\n          const actionName = this.translations?.tools?.[action] || action;\n          this.notificationManager.success(\n            `Text ${actionName} successfully`,\n            2000\n          );\n        }\n      } catch (error) {\n        console.error(\"[AITextEnhancer] API request error:\", error);\n\n        // Remove temporary response\n        if (tempResponse && this.responseHistory) {\n          this.responseHistory.removeResponse(tempResponse.id);\n        }\n\n        // Add error message\n        this.addResponseToHistory(\"error\", this.formatErrorMessage(error));\n\n        // Show error notification\n        if (this.notificationManager) {\n          this.notificationManager.error(`Error: ${error.message}`);\n        }\n      }\n    } catch (error) {\n      console.error(\"[AITextEnhancer] Error in handleToolAction:\", error);\n\n      // Remove temporary response if it exists\n      if (tempResponse && this.responseHistory) {\n        this.responseHistory.removeResponse(tempResponse.id);\n      }\n\n      // Add error message\n      this.addResponseToHistory(\"error\", `Error: ${error.message}`);\n\n      // Show notification\n      if (this.notificationManager) {\n        this.notificationManager.error(`Error: ${error.message}`);\n      }\n    }\n  }\n\n  /**\n   * Helper method to add responses to history\n   * Add this if it doesn't exist\n   */\n  addResponseToHistory(action, content) {\n    if (!this.responseHistory) {\n      console.error(\"[AITextEnhancer] No response history available\");\n      return;\n    }\n\n    const response = {\n      id: Date.now(),\n      action,\n      content: content || \"\",\n      timestamp: new Date(),\n    };\n\n    this.responseHistory.addResponse(response);\n    return response;\n  }\n\n  /**\n   * Helper method to format error messages\n   * Add this if it doesn't exist\n   */\n  formatErrorMessage(error) {\n    if (!error) return \"An unknown error occurred\";\n\n    // Extract message from different error formats\n    let message = error.message || error.toString();\n\n    if (error.originalError) {\n      message += `\\n${\n        error.originalError.message || error.originalError.toString()\n      }`;\n    }\n\n    return message;\n  }\n}\n\n// Registrar el componente\ncustomElements.define(\"ai-text-enhancer\", AITextEnhancer);\n\nexport default AITextEnhancer;\n","export const createEventEmitter = (element) => {\n  return {\n    emit: (eventName, detail) => {\n      const event = new CustomEvent(eventName, {\n        detail,\n        bubbles: true,\n        composed: true,\n      });\n      element.dispatchEvent(event);\n    },\n    on: (eventName, handler) => {\n      element.addEventListener(eventName, handler);\n      return () => element.removeEventListener(eventName, handler);\n    },\n    off: (eventName, handler) => {\n      element.removeEventListener(eventName, handler);\n    },\n  };\n};\n\nexport const createCustomEvent = (name, detail) => {\n  return new CustomEvent(name, {\n    detail,\n    bubbles: true,\n    composed: true,\n  });\n};\n\nexport const dispatchCustomEvent = (element, name, detail) => {\n  element.dispatchEvent(createCustomEvent(name, detail));\n};\n","export function attachShadowTemplate(component, templateContent) {\n  if (!component) {\n    console.error(\n      \"Error: No se proporcionó un componente para attachShadowTemplate\"\n    );\n    return null;\n  }\n\n  if (!templateContent) {\n    console.error(\n      \"Error: No se proporcionó contenido de plantilla para attachShadowTemplate\"\n    );\n    return null;\n  }\n\n  console.log(\"Attaching shadow template to component:\", {\n    componentTagName: component.tagName,\n    templateContentLength: templateContent.length,\n  });\n\n  // Verificar si el componente ya tiene un shadowRoot\n  if (component.shadowRoot) {\n    console.log(\"El componente ya tiene un shadowRoot, no se creará uno nuevo\");\n\n    // Limpiar el shadowRoot existente\n    while (component.shadowRoot.firstChild) {\n      component.shadowRoot.removeChild(component.shadowRoot.firstChild);\n    }\n  } else {\n    // Crear un nuevo shadowRoot\n    try {\n      component.attachShadow({ mode: \"open\" });\n      console.log(\"Shadow root creado:\", !!component.shadowRoot);\n    } catch (error) {\n      console.error(\"Error creando shadow root:\", error);\n      return null;\n    }\n  }\n\n  try {\n    // Crear un template y agregar el contenido\n    const template = document.createElement(\"template\");\n    template.innerHTML = templateContent;\n    console.log(\n      \"Template element creado con contenido de longitud:\",\n      template.innerHTML.length\n    );\n\n    // Clonar el contenido del template\n    const content = template.content.cloneNode(true);\n    console.log(\"Contenido clonado:\", {\n      hasContent: !!content,\n      childNodes: content.childNodes.length,\n    });\n\n    // Agregar el contenido al shadowRoot\n    component.shadowRoot.appendChild(content);\n    console.log(\"Contenido agregado al shadow root\");\n\n    // Registrar elementos clave\n    const elements = {\n      modalTrigger: component.shadowRoot.querySelector(\".modal-trigger\"),\n      modal: component.shadowRoot.querySelector(\".modal\"),\n      aiToolbar: component.shadowRoot.querySelector(\"ai-toolbar\"),\n      chatWithImage: component.shadowRoot.querySelector(\"chat-with-image\"),\n      responseHistory: component.shadowRoot.querySelector(\"response-history\"),\n    };\n\n    console.log(\"Elementos renderizados:\", {\n      hasModalTrigger: !!elements.modalTrigger,\n      hasModal: !!elements.modal,\n      hasAiToolbar: !!elements.aiToolbar,\n      hasChatWithImage: !!elements.chatWithImage,\n      hasResponseHistory: !!elements.responseHistory,\n    });\n\n    return component.shadowRoot;\n  } catch (error) {\n    console.error(\"Error procesando template:\", error);\n    return null;\n  }\n}\n\nexport const createTemplate = (html) => {\n  if (typeof html !== \"string\") {\n    // Si se pasa un componente en lugar de una cadena HTML,\n    // asumimos que es un componente y utilizamos su método createTemplate\n    if (html && typeof html.translations === \"object\") {\n      if (typeof createTemplate === \"function\") {\n        return createTemplate(html);\n      } else {\n        console.warn(\n          \"No se encontró la función createTemplate para el componente\"\n        );\n        return \"\";\n      }\n    }\n\n    console.warn(\"Se esperaba una cadena HTML para createTemplate\");\n    return \"\";\n  }\n\n  const template = document.createElement(\"template\");\n  template.innerHTML = html;\n  return template;\n};\n"],"names":["TRANSLATIONS","en","modalTrigger","modalTitle","tools","improve","summarize","expand","paraphrase","actions","copy","use","edit","retry","insert","replace","generate","preview","placeholder","chat","question","contentPrompt","contextPrompt","emptyPrompt","errors","apiKey","initialization","request","es","fr","de","pt","it","getToolIcon","action","icons","variables","animations","previewStyles","ResponseHistory","HTMLElement","constructor","super","this","attachShadow","mode","responses","markdownHandler","observedAttributes","language","lang","getAttribute","console","log","connectedCallback","hasAttribute","getAttributeNames","translations","render","setupEventListeners","attributeChangedCallback","name","oldValue","newValue","createResponseEntry","response","entry","document","createElement","className","dataset","id","isInfo","includes","isQuestion","innerHTML","convert","content","hasImage","image","formatTimestamp","timestamp","URL","createObjectURL","contentWrapper","isLoading","length","contentClass","mainContent","isSystemMessage","toolsHtml","_b","_a","_d","_c","_f","_e","_h","_g","_j","_i","_l","_k","actionsHtml","_n","_m","_p","_o","_r","_q","_t","_s","_v","_u","_x","_w","_y","shadowRoot","querySelector","styleEl","textContent","appendChild","addEventListener","e","button","target","closest","responseId","getResponse","classList","contains","dispatchEvent","CustomEvent","detail","bubbles","composed","setTimeout","element","remove","parentNode","getRootNode","host","error","find","parseInt","addResponse","push","updateResponse","contentOrCallback","index","findIndex","r","oldContent","isFirstUpdate","isIncrementalUpdate","startsWith","responseEntry","contentElement","firstChunk","warn","textNode","createTextNode","streamingActive","add","substring","lastChild","nodeType","Node","TEXT_NODE","nodeValue","container","scrollHeight","scrollTop","clientHeight","getTypingPlaceholder","removeResponse","filter","clear","style","forEach","firstChild","removeChild","requestAnimationFrame","Date","toLocaleTimeString","hour","minute","customElements","define","ChatWithImage","tempImage","imageUrl","apiProvider","supportsImages","initialPrompt","hasContent","hasContext","handleImageUrl","setInitialPrompt","updateTranslations","updateUploadVisibility","updateInitialPrompt","chatInput","prompt","innerText","trim","activeElement","selection","window","getSelection","range","createRange","selectNodeContents","collapse","removeAllRanges","addRange","updateImagePreview","existingPreview","template","createContextualFragment","form","input","uploadButton","imageInput","handleSubmit","bind","key","shiftKey","preventDefault","Event","stopPropagation","handleFileSelect","value","event","file","files","message","submitButton","setAttribute","display","url","fetch","blob","File","type","ToolBar","currentAction","bindEvents","updateVisibleTools","createToolbar","toolbar","label","formal","casual","tool","querySelectorAll","onclick","setActiveAction","toggle","improveButton","getCurrentAction","MODEL_CONFIG","openai","models","contextWindow","description","suggested","maxTokens","costPer1k","defaultModel","visionModel","anthropic","deepseek","cohere","command","google","mistral","ollama","llama2","mixtral","ModelManager","provider","config","getModelConfig","modelId","providerConfig","Error","default","getDefaultModel","getAllModels","Object","values","isProviderSupported","isImageSupportedForProvider","getVisionModelForProvider","setProvider","TokenManager","modelManager","tokensPerChar","zh","ja","defaultTokensPerChar","MarkdownHandler","marked","initialize","import","setOptions","gfm","breaks","sanitize","text","APIClient","proxyEndpoint","model","visionModels","temperature","sessionToken","systemPrompt","tenantId","userId","debugMode","_streamCounter","setSessionToken","token","setModel","updateConfig","processStream","onProgress","reader","body","getReader","decoder","TextDecoder","buffer","completeText","accumulatedChunks","streamedChars","chunkCounter","extractContentFromJSON","data","choices","delta","isFirstContentChunk","done","read","jsonMatch","match","JSON","parse","cleanBuffer","chunk","decode","stream","lines","split","pop","foundContent","line","slice","jsonData","extractedContent","parts","i","processed","makeRequest","progressHandler","_createDebugProgressHandler","payload","messages","role","stringify","method","headers","status","ok","fromEntries","entries","errorMessage","json","statusText","APIError","makeRequestWithImage","imageSource","imageData","mimeType","imageToBase64","image_url","source","media_type","inline_data","mime_type","endpoint","imageType","Authorization","errorData","parseError","rawText","catch","imageFile","Promise","resolve","reject","FileReader","onload","result","onerror","readAsDataURL","enhanceText","context","prompts","empty","chatResponse","imageError","originalHandler","chunkIndex","Array","from","map","c","charCodeAt","join","originalError","CacheManager","options","prefix","maxItems","ttl","storage","sessionStorage","validateStorage","testKey","setItem","removeItem","generateKey","hash","hashString","str","Math","abs","toString","get","cachedItem","getItem","item","now","delete","set","enforceSizeLimit","cleanup","keys","getCacheKeys","sort","a","b","getStats","totalSize","expiredCount","totalItems","expiredItems","TinyMCEAdapter","editorId","debug","waitTimeout","useGlobalReference","editorInstance","_initialized","tmceVersion","_findEditorInstance","_detectTinyMCEVersion","tinymce","majorVersion","createEditor","dom","TreeWalker","EventUtils","instance","globalInstanceKey","tinyMCEInstance","waitForEditor","startTime","checkInterval","setInterval","clearInterval","_hasMethod","methodName","getContent","format","err","getBody","contentDocument","doc","textareaElement","getElementById","setContent","undoManager","load","insertContent","execCommand","isInitialized","getVersion","CKEditorAdapter","ckeditorInstance","editorElement","getData","setData","viewFragment","processor","toView","modelFragment","toModel","QuillAdapter","quillInstance","quillContainer","__quill","editor","root","clipboard","dangerouslyPasteHTML","getLength","FroalaAdapter","froalaInstance","froalaEditor","froalaContainer","instanceKey","$","html","events","trigger","EditorAdapter","editorType","toLowerCase","specificAdapters","_initializeSpecificAdapter","createTinyMCEAdapter","ckeditor","createCKEditorAdapter","quill","createQuillAdapter","froala","createFroalaAdapter","CKEDITOR","instances","quillElement","froalaElement","tagName","NotificationManager","notifications","Set","show","duration","toUpperCase","notification","icon","getIconForType","close","animation","closeButton","cleanupOldNotifications","warning","info","success","maxNotifications","notificationsArray","clearAll","keyboardNavigationMixin","handleKeyboard","ctrlKey","metaKey","click","isModalOpen","handleToolAction","handleModalKeyboard","handleTabNavigation","handleToolNavigation","focusableElements","firstFocusable","lastFocusable","focus","currentTool","currentIndex","indexOf","nextIndex","responseHandlerMixin","handleResponseCopy","responseHistory","navigator","writeText","then","notificationManager","handleResponseUse","contentToInsert","editorAdapter","initialized","modal","handleResponseRetry","syntheticEvent","handleResponseEdit","imageHandlerMixin","isImageUsed","imageId","some","imageUsed","handleImageChange","productImage","productImageUrl","lastQuestion","findLast","imagePreviewHTML","renderImagePreview","questionEntry","responseContent","insertAdjacentHTML","removeImage","isInitial","imageToRender","filename","pathname","stateManagementMixin","initializeStateManager","stateManager","component","_state","updateState","propName","property","rerender","targetSelector","renderPart","getState","defaultValue","getAllState","batchUpdate","stateUpdates","changedProps","changes","createStateManager","handleStateChange","handleStateBatchChange","handleProductImageChange","handleEnhancedTextChange","change","oldImage","newImage","oldText","newText","requestUpdate","createTemplate","t","currentContent","Boolean","showTrigger","hideTrigger","AITextEnhancer","assign","eventEmitter","emit","eventName","on","handler","removeEventListener","off","tokenManager","cacheManager","createCacheManager","enhancedText","chatMessages","usageControl","bindMethods","handleChatMessage","modalTriggerHandler","apiModel","templateContent","componentTagName","templateContentLength","cloneNode","childNodes","elements","aiToolbar","chatWithImage","hasModalTrigger","hasModal","hasAiToolbar","hasChatWithImage","hasResponseHistory","attachShadowTemplate","notificationsContainer","ensureModalExists","updateLanguageForChildren","setupKeyboardNavigation","initializeComponents","setupEditorListener","updateChatState","errorElement","color","padding","margin","border","notifError","apiClient","setApiKey","chatComponent","_editorChangeListener","components","oldLang","to","newModal","openModal","setupTinyMCEIntegration","tinyMceInstance","createAPIClient","addResponseToHistory","rawContent","questionResponse","prevContent","responseContainer","formatErrorMessage","part","triggerUpdate","contentLength","contextLength","tempResponse","textToProcess","cachedResponse","actionName"],"mappings":"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"}